#!/bin/bash
:; for v in "${@//!/!1}" ; do v=${v// /!0} ; v=${v//	/!+}; a[++n]=${v:-!.} ; done ; LC_ALL=C SCAM_ARGS=${a[*]} exec make -Rr --no-print-directory -f"$0" 9>&1
SCAM_MAIN := scam `main
^uid := 4c5fb7204ab86f16

define [mod-scam]
# Requires: core repl getopts compile gen io
# Exports: 
$(call ^R,core)
$(call ^R,repl)
$(call ^R,getopts)
$(call ^R,compile)
$(call ^R,gen)
$(call ^R,io)
`usage-string := Usage:$'$'    scam [-i]                  Enter interactive mode$'    scam FILE ARGS...          Compile and execute FILE$'    scam -o FILE [OPTS] FILE   Build an executable from SRC$'    scam -e EXPR               Print the value of expression EXPR$'    scam -v / --version        Show version$'    scam -h / --help           Show this message$'$'Options:$'$'  --quiet           Do not display progress messages$'  --build-dir DIR   Specify directory for intermediate files$'  --                Stop processing options$'
define `perror
$(and $(call `vfprintf,2,scam: $1
,$(foreach N,2,$(^v)))1,1)
endef
`main = $(call ^Y,$(call `getopts,$1,-o= -e= -v --version -h --help -i --quiet --build-dir= --boot),,,,,,,,,$`(and $`(call ^set,`*is-boot*,$`(call `dict-get,boot,$`1))1,$`(call ^set,`build-dir,$`(or $`(call ^u,$`(lastword $`(call `dict-get,build-dir,$`1))),$`(addsuffix .scam/,$`(dir $`(call ^u,$`(lastword $`(call `dict-get,o,$`1))))),$`(SCAM_BUILD_DIR),$`(HOME)/.scam/))1,$`(or $`(if $`(call `dict-get,!,$`1),$`(and $`(foreach ;,$`(call `dict-get,!,$`1),$`(call ^d,$`(if $`(filter !:GetoptsError0,$`(word 1,$`(call ^u,$`;))),$`(call `perror,`%s` is missing an argument,$`(call ^n,2,$`(call ^u,$`;))),$`(if $`(filter !:GetoptsError1,$`(word 1,$`(call ^u,$`;))),$`(call `perror,`%s` is not a recognized option,$`(call ^n,2,$`(call ^u,$`;))),$`(call `perror,[internal error])))))1,$`(call `perror,try `scam -h` for help))),$`(call ^n,1,$`(filter-out !.,$`(foreach ;,$`(call `dict-get,e,$`1),$`(call ^d,$`(if $`(call `repl-ep,$`(call ^u,$`;),$`(`build-dir),$`(call `dict-get,quiet,$`1)),1))))),$`(if $`(or $`(call `dict-get,h,$`1),$`(call `dict-get,help,$`1)),$`(and $`(info $`(`usage-string))1,0)),$`(if $`(call `dict-get,o,$`1),$`(if $`(wordlist 2,99999999,$`(call `dict-get,*,$`1)),$`(call `perror,too many input files were given with `-o`),$`(or $`(call `build-program,$`(call ^n,1,$`(call `dict-get,*,$`1)),$`(call ^u,$`(lastword $`(call `dict-get,o,$`1))),$`(`build-dir),$`(call `dict-get,quiet,$`1)),0))),$`(if $`(or $`(call `dict-get,v,$`1),$`(call `dict-get,version,$`1)),$`(and $`(info SCAM version 2.1.0)1,0)),$`(if $`(call ^n,1,$`(call `dict-get,*,$`1)),$`(or $`(call `run-program,$`(call ^n,1,$`(call `dict-get,*,$`1)),$`(wordlist 2,99999999,$`(call `dict-get,*,$`1)),$`(`build-dir),$`(call `dict-get,quiet,$`1)),0)),$`(if $`(or $`(call `dict-get,i,$`1),$`(if $`(or $`(call ^n,1,$`(call `dict-get,*,$`1)),$`(call `dict-get,e,$`1)),,1)),$`(and $`(info SCAM v2.1.0 interactive mode. Type `?` for help.)1,$`(call `repl,$`(`build-dir))1,0)))))

endef

define [mod-runtime]
# Requires: 
# Exports: at-exit}1'2 tracing#2{`untrace|7'`trace'[]0[01[0.|0'2'. do-not-trace}1 untrace}1'2 trace}1 ^tags@0!0i!0^tags filtersub}3 native-bound?#1!0!]6!0if|6'filter-out'[]4[0u!p'[]6[0flavor[0[1]0[101[10.|4'1 rrest#1!0!]6!0wordlist|4'3|4'99999999|0'1'. rest#1!0!]6!0wordlist|4'2|4'99999999|0'1'. first#1{^n|4'1|0'1'. nth-rest#2!0!]6!0wordlist|0'1'.|4'99999999|0'2'. not#1!0!]6!0if|0'1'.|4'[.|4'1 nil@3!0i!0.!0!]4!0!1. set-native-fn#2'3{^fset|0'1'.|0'2'.|0'3'. set-native#2'3{^set|0'1'.|0'2'.|0'3'. nth#2{^n|0'1'.|0'2'. demote#1{^d|0'1'. promote#1{^u|0'1'. apply#2{^apply|0'1'.|0'2'. name-apply#2{^na|0'1'.|0'2'.
`*do-not-trace* := $(.VARIABLES)
define '


endef
 [ := (
 ] := )
" := \#
' := $'
` := $$
& := ,
$(if ,, ) :=

^d = $(or $(subst $  ,!0,$(subst $ 	,!+,$(subst !,!1,$1))),!.)
^u = $(subst !1,!,$(subst !+,	,$(subst !0, ,$(subst !.,,$1))))
^n = $(subst !1,!,$(subst !+,	,$(subst !0, ,$(subst !.,,$(word $1,$2)))))
^k = $(subst %,!8,$(^d))
^dk = $(subst !1,!,$(subst !+,	,$(subst !0, ,$(subst !.,,$(subst !8,%,$(word 1,$(subst !=, ,$1)))))))
^dv = $(subst !1,!,$(subst !+,	,$(subst !0, ,$(subst !.,,$(word 2,$(subst !=, ,$1))))))
^Y = $(call if,,,$(10))
^v = $(subst !.,!. ,$(filter-out %!,$(subst !. ,!.,$(foreach n,$(wordlist $N,9,1 2 3 4 5 6 7 8),$(call ^d,$($n)))$(if $9, $9) !)))
^av = $(foreach N,1,$(^v))
^apply = $(call ^Y,$(call ^n,1,$2),$(call ^n,2,$2),$(call ^n,3,$2),$(call ^n,4,$2),$(call ^n,5,$2),$(call ^n,6,$2),$(call ^n,7,$2),$(call ^n,8,$2),$(wordlist 9,99999999,$2),$1)
^na = $(call if,,,$`(call $1$(subst $(if ,, ,),$(if ,,,),$(foreach ;,$(wordlist 1,$(words $2),1 2 3 4 5 6 7 8),$(if ,,,$`(call ^n,$;,$`2))))$(if $(word 9,$2),$(if ,,,$`(wordlist 9,99999999,$`2)))))
define ^f
"$(subst 
,\n,$(subst ",\",$(subst \,\\,$1)))"
endef
^tp = $(info $1 $(call ^f,$2))$2
^tc = $(call $1,$2,$3,$4,$5,$6,$7,$8,$(call ^n,1,$9),$(wordlist 2,9999,$9))
^ta = $(if $(or $1,$2,$3,$4,$5,$6,$7,$8,$9), $(^f)$(call ^tc,^ta,$2,$3,$4,$5,$6,$7,$8,$9))
^t = $(info --> ($1$(call ^tc,^ta,$2,$3,$4,$5,$6,$7,$8,$9)))$(call ^tp,<-- $1:,$(call ^tc,$1,$2,$3,$4,$5,$6,$7,$8,$9))
define `esc-LHS
$`(if ,,$(subst $],$`],$(subst $[,$`[,$(subst 
,$`',$(subst #,$`",$(subst $`,$`$`,$1))))))
endef
define ^set
$(eval $(call `esc-LHS,$1) :=$` $(subst 
,$`',$(subst #,$`",$(subst $`,$`$`,$2))))$3
endef
define ^fset
$(and $(eval define $(call `esc-LHS,$1)
$(subst \$ 
,\$` 
,$(subst define,$` define,$(subst endef,$` endef,$2
)))endef
)1,$3)
endef
define ^E
$(subst $`,$`$2,$`(if ,,$(subst 
,$`',$(subst $[,$`[,$(subst $],$`],$(subst $`,$``,$1))))))
endef
`filtersub = $(patsubst $1,$2,$(filter $1,$3))
^tags := 
^at = $(call ^set,^tags,$(^tags) $(filter-out $(^tags),$1))
`*required* := 
^load = $(and $(if $(if $(filter-out u%,$(flavor [mod-$1])),1),$(eval $(value [mod-$1])),$(eval include $(subst $ 	,\	,$(subst $  ,\ ,$(value SCAM_DIR)$1.o))))1,$1)
^R = $(and $(or $(filter $(call ^d,$1),$(`*required*)),$(and $(call ^set,`*required*,$(`*required*) $(call ^d,$1))1,$(call ^load,$1)))1,)
`trace-info = $(info TRACE: $1$2$3$4)
`trace-digits = $(if $(findstring /1111111111,$1),$(call `trace-digits,$(subst /1111111111,1/,$1)),$(subst !:,,$(subst :!,0!,$(subst :0,::,$(subst :00,:::,$(subst :0000,:::::,$(subst $  ,,!:$(foreach ;,/$(subst /, /,$1),$(words $(subst /,,$(subst 1, 1,$;))))!:)))))))
`trace-words = $(if $(word $1,$2),$2,$(call `trace-words,$1,1 $2))
`trace-body = $(subst :D,$4,$(subst :N,$(patsubst '%,%,$2),$(subst :C,$`(call [S-$3],$`1,$`2,$`3,$`4,$`5,$`6,$`7,$`8,$`9),$(subst :E,$`(eval ^TI:=$`$`(^TI) ):C$`(eval ^TI:=$`$`(subst x ,,x$`$`(^TI))),$(subst :I,info $`(^TI),$(if $(filter c,$1),$(and $(call ^set,[K-$3],$(or $(value [K-$3]),///////),)1,$`(eval [K-$3]:=$`(subst /1111111111,1/,$`([K-$3])1)):D),$(if $(filter p%,$1),$(subst :,:$` ,$(call ^u,$(patsubst p%,%,$1))):D,$(if $(filter t f,$1),$(if $(or $(filter f,$1),$(filter ^ta ^f ^tc ^tp ^n,$2)),$`(:I--> :N):E$`(:I<-- :N),$`(:I--> (:N$`(^ta)))$`(call ^tp,$`(^TI)<-- :N:,:E)),$(if $(filter x%,$1),$`(foreach ^X,1,:C)$`(if $`(^X),,$`(if $`(foreach ^X,$(wordlist 2,99999999,$(call `trace-words,$(or $(patsubst x%,%,$1),11),1)),$`(if :C,)),)),$(error TRACE: Unknown mode: '$1'))))))))))
`trace-match = $(foreach ;,$(if $(filter '% `% "%,$1),$(patsubst "%,%,$1),'$1),$(filter-out $(foreach ;;,^% `% `trace% `esc-% `set-native-fn `filtersub,$(if $(filter-out $(;;),$;),$(;;))),$(filter $;,$2)))
`*trace-ids* := 
`trace-id = $(or $(call `filtersub,$1:%,%,$(`*trace-ids*)),$(if $2,$(call ^set,`*trace-ids*,$(`*trace-ids*) $1:$(words $(`*trace-ids*)),$(words $(`*trace-ids*)))))
define `trace
$(subst "`,`,$(subst "',',$(addprefix ",$(filter %,$(foreach ;,$(filter-out %:v %:-,$1),$(foreach ;;,$(foreach ;;,$(call `trace-match,$(filter-out :%,$(subst :, :,$;)),$(filter-out $(`*do-not-trace*) [% ~trace ~untrace ~trace-ext ~untrace-ext ^Y  $(call `filtersub,%:-,%,$1),$(.VARIABLES))),$(if $(filter filerec%,$(origin $(;;))$(flavor $(;;))),$(;;))),$(foreach ;;;,$(call `trace-id,$(;;),1),$(and $(and $(if $(filter u%,$(origin [S-$(;;;)])),$(call ^fset,[S-$(;;;)],$(value $(;;)),))1,$(if $(filter %:v,$1),$(call `trace-info,[,$(subst $  ,,$(wordlist 2,999,$(subst :,: ,$;))),] ,$(;;)))1,$(call ^fset,$(;;),$(call `trace-body,$(or $(subst $  ,,$(wordlist 2,999,$(subst :,: ,$;))),t),$(subst #,$`",$(;;)),$(;;;),$(value [S-$(;;;)])),))1,$(;;)))))))))
endef
`trace-rev = $(if $1,$(call `trace-rev,$(wordlist 2,99999,$1)) $(word 1,$1))
`trace-dump = $(foreach ;,$(sort $(foreach ;,$1,$(foreach ;;,$(value [K-$(call `trace-id,$;)]),$(if $(findstring 1,$(;;)),$(and $(call ^set,[K-$(call `trace-id,$;)],///////,)1,$(call ^d,$(subst :, ,$(call `trace-digits,$(;;))) $;)))))),$(call ^d,$(call `trace-info,$(call ^u,$;))))
`untrace = $(and $(call `trace-dump,$(foreach ;,$(filter $1,$(filter-out :%,$(subst :, :,$(`*trace-ids*)))),$(foreach ;;,$(call `trace-id,$;),$(and $(call ^fset,$;,$(value [S-$(;;)]),)1,$;))))1,$2)
`do-not-trace = $(call ^set,`*do-not-trace*,$(`*do-not-trace*) $1)
`start-trace = $(call `trace,$(value SCAM_TRACE))
SHELL := /bin/bash
`*atexits* := 
`at-exit = $(if $(and $2,$(findstring $  $(call ^d,$1) , $(`*atexits*) )),,$(call ^set,`*atexits*,$(call ^d,$1) $(`*atexits*)))
`run-at-exits = $(and $(foreach ;,$(`*atexits*),$(call ^d,$(call ^Y,,,,,,,,,,$(call ^u,$;))))1,)
`check-exit = $(if $(subst 0,,$(subst 9,,$(subst 8,,$(subst 7,,$(subst 6,,$(subst 5,,$(subst 4,,$(subst 3,,$(subst 2,,$(subst 1,,$(patsubst -%,%,$(subst $ 	,x,$(subst $  ,x,$1))))))))))))),$(error scam: main returned '$1'),$(or $1,0))
define ^start
$(and $(call `start-trace,$1)1,$(call `do-not-trace,^R ^load)1,$(call ^R,$1)1,$(call `start-trace,$1)1,$(eval $(call ^Y,$(call `check-exit,$(call ^Y,$3,,,,,,,,,$(value $2))),,,,,,,,,.DEFAULT_GOAL :=
.PHONY: [exit]
[exit]: $`(.DEFAULT_GOAL);@exit $`1$``(call `run-at-exits))))
endef
$(if $(call `do-not-trace,^start `start-trace),)
$(if $(call `at-exit,$`(call `trace-dump,$`(filter-out :%,$`(subst :, :,$`(`*trace-ids*))))),)
$(if $(call ^start,$(call ^u,$(word 1,$(SCAM_MAIN))),$(word 2,$(SCAM_MAIN)),$(value SCAM_ARGS)),)

endef

define [mod-core]
# Requires: 
# Exports: repeat-words}2 intersperse}2 foldr}3 foldl}3 index-of}2 assoc#2{%-initial|6'subst'[]4[0[11'[]4[0[111'[]7[0^d[0[1]0[101[10.|0'2'. assoc-vec#2{`assoc-initial|7'^d'[]0[01[0.|0'2'. assoc-initial}2 sort-by}2 memoize}1 1+}1 split}2 uniq}1 see}2 fexpect#2{`expect-x|7'`format'[]0[01[0.|7'`format'[]0[02[0.|10'5143 assert#1{%-x|0'1'.|10'5092 trace-expect#2!0!]2|1'[]7[0`expect-x[0[1]7[10^n[10[11]4[1101[10[11]0[1101[110.[0[1]7[10^n[10[11]4[1102[10[11]0[1101[110.[0[1]10[105007|7'`untrace'[]7[0`trace[0[1]4[10!p'[]8[0[1]7[10^d[10[11]0[1101[110.[0[1]4[10[110[0[1]7[10^d[10[11]0[1102[110. expect#2{%-x|0'1'.|0'2'.|10'4958 expect-x}3 printf}1+ sprintf}1+ vsprintf}2 vsprintfx}4 format}1 format-add}1 dict-collate}1 dict-values}1 dict-keys}1 dict-compact}1'2 dict-set}3 dict-remove}2 dict-get}2'3 dict-find}2 dict-value#1{^dv|0'1'. dict-key#1{^dk|0'1'. append}0+ word-index?}1 numeric?}1 while}3 reverse}1 indices}1 urange}2 permute}2'3 vec-subtract#2{`vec-filter|4'filter-out|0'2'.|0'1'. vec-intersect#2{`vec-filter|4'filter|0'2'.|0'1'. vec-or#1{^n|4'1|6'filter-out'[]4[0[11.'[]0[01[0. select-words}2 select-vec}2 butlast}1 strip#1!0!]6!0filter|4'!p|0'1'. last#1{^u|6'lastword'[]0[01[0. conj}2 cons}2 concat-vec}1'2 xor}2 identity#1!0!]0!01!0. eq?#2!0!]6!0findstring|6'subst'[]8[0[1]0[102[10.[0[1]4[100'[]4[01'[]8[0[1]0[101[10.[0[1]4[100|4'1
`xor = $(if $1,$(if $2,,$1),$2)
`concat-vec = $(call ^u,$(subst $  ,$(call ^d,$2),$1))
`cons = $(call ^d,$1)$(if $2, )$2
`conj = $1$(if $1, )$(call ^d,$2)
`butlast = $(wordlist 2,$(words $1),X $1)
`select-vec = $(filter-out !,$(foreach ;,$2,$(if $(call ^Y,$(call ^u,$;),,,,,,,,,$1),$;,!)))
`select-words = $(foreach ;,$(foreach ;,$2,$(if $(call ^Y,$;,,,,,,,,,$1),$;)),$;)
`vec-filter = $(if $(findstring %,$2),$(subst !P,%,$(call $1,$(subst %,!P,$2),$(subst %,!P,$3))),$(call $1,$2,$3))
`permute = $(if $(findstring 00,$2),$(foreach ;,$1,$(call `permute,$1,$(subst 0x,,$2x),$3$;)),$(if $2,$(foreach ;,$1,$(addprefix $3$;,$1)),$(addprefix $3,$1)))
`urange-x = $(if $(word $1,$2),$2,$(call `urange-x,$1,$2 $(foreach ;,1 2 3 4 5 6 7 8 9,$(call `permute,0 1 2 3 4 5 6 7 8 9,$3,$;)),$30))
`urange = $(wordlist $1,$2,$(call `urange-x,$2,1 2 3 4 5 6 7 8 9,))
`indices = $(if $(word 10,$1),$(call `urange,1,$(words $1)),$(wordlist 1,$(words $1),1 2 3 4 5 6 7 8 9))
`rev-by-10s = $(if $1,$(if $2,$(foreach ;,10 9 8 7 6 5 4 3 2 1,$(call `rev-by-10s,$(wordlist $(word $;,0 1 2 3 4 5 6 7 8 9)$(patsubst %0,%1,$2),$;$2,$1),$(patsubst 0%,%,$2))),$(foreach ;,10 9 8 7 6 5 4 3 2 1,$(word $;,$1))))
`rev-zeroes = $(if $(word 1$21,$1),$(call `rev-zeroes,$1,0$2),$2)
`reverse = $(wordlist 1,99999999,$(call `rev-by-10s,$1,$(call `rev-zeroes,$1,)))
`while-0 = $(if $(filter iiiiiiiiiiiiiiiiiiii,$4),1 $(call ^d,$3),$(if $(call ^Y,$3,,,,,,,,,$1),$(call `while-0,$1,$2,$(call ^Y,$3,,,,,,,,,$2),i$4),0 $(call ^d,$3)))
`while-N = $(if $(filter 0,$(word 1,$3)),$3,$(if $(filter iii,$5),$(if $(filter 1,$4),$(call `while-N,$1,$2,$3,$4 0,ii),$3),$(call `while-N,$1,$2,$(if $4,$(call `while-N,$1,$2,$3,$(wordlist 2,99999999,$4),),$(call `while-0,$1,$2,$(call ^n,2,$3),)),$4,i$5)))
`while = $(if $(call ^Y,$3,,,,,,,,,$1),$(call ^Y,$(call ^Y,$3,,,,,,,,,$2),$1,$2,,,,,,,$`(call ^n,2,$`(call `while-N,$`2,$`3,$`(call `while-0,$`2,$`3,$`1,),1,ii))),$3)
`numeric? = $(if $(filter 0% 1% 2% 3% 4% 5% 6% 7% 8% 9%,$(subst -,,$1)),$(if $(patsubst .%,%,$(patsubst %e,%,$(subst 0,,$(patsubst -%,%,$(subst $  ,_,$(subst E0,e,$(subst E-,E,$(subst e,E,$(subst +,-,$(subst 9,0,$(subst 8,0,$(subst 7,0,$(subst 6,0,$(subst 5,0,$(subst 4,0,$(subst 3,0,$(subst 2,0,$(subst 1,0,$1)))))))))))))))))),,$1))
`word-index? = $(if $(subst 9,,$(subst 8,,$(subst 7,,$(subst 6,,$(subst 5,,$(subst 4,,$(subst 3,,$(subst 2,,$(subst 1,,$(subst 0,,$1)))))))))),,$(subst 0,,$1))
`append = $(filter %,$1 $2 $3 $4 $5 $6 $7 $8 $(if $9,$(call ^u,$9)))
`dict-find = $(word 1,$(filter $(subst %,!8,$(call ^d,$1))!=%,$2))
`dict-get = $(call ^u,$(or $(word 2,$(subst !=, ,$(filter $(subst %,!8,$(call ^d,$1))!=%,$2))),$(subst !,!1,$3)))
`dict-remove = $(filter-out $(subst %,!8,$(call ^d,$1))!=%,$2)
`dict-set = $(foreach ;,$(subst %,!8,$(call ^d,$1))!=,$;$(call ^d,$2) $(filter-out $;%,$3))
`dict-compact = $(if $(if $1,,1),$2,$(call `append,$(word 1,$1),$(call `dict-compact,$(filter-out $(word 1,$(subst !=,!=% ,$(word 1,$1))),$(wordlist 2,99999999,$1)))))
`dict-keys = $(subst !8,%,$(filter-out !=%,$(subst !=, !=,$1)))
`dict-values = $(filter-out %!=,$(subst !=,!= ,$1))
`dict-collate = $(foreach ;,$(word 1,$(subst !=,!= ,$(word 1,$1))),$(call `append,$;$(call ^d,$(call `filtersub,$;%,%,$1)),$(call `dict-collate,$(filter-out $;%,$1))))
define `symbol?
$(and $(findstring $1,$(word 1,$1)),$(if $(or $(findstring 
,$1),$(findstring $[,$1),$(findstring $],$1),$(findstring [,$1),$(findstring ],$1),$(findstring $(if ,,,),$1),$(findstring ;,$1),$(findstring :,$1),$(findstring ',$1),$(findstring `,$1),$(findstring ",$1),$(findstring !=,$1)),,1),$1)
endef
`format-dict = $(if $(findstring !=,$1),$(if $(findstring $(subst $(foreach ;,$1,$(call ^k,$(call ^dk,$;))!=$(call ^d,$(call ^dv,$;)))0,1,$10),1),{$(call `concat-vec,$(foreach ;,$1,$(call ^d,$(or $(call `symbol?,$(call ^dk,$;)),$(call `format,$(call ^dk,$;))): $(call `format,$(call ^dv,$;)))),$(if ,,, ))}))
`data-foreach = $(if $2,$(call `data-foreach,$1,$(wordlist 2,99999999,$2),$(wordlist 2,99999999,$3),$4$(if $4, )$(call ^Y,$(if $(filter L,$(word 1,$2)),$3,$(if $(filter S,$(word 1,$2)),$(call ^n,1,$3),$(if $(filter W,$(word 1,$2)),$(word 1,$3),$(error bad encoding in ctor pattern)))),$(word 1,$2),,,,,,,,$1)),$4)
`format-record = $(if $(filter !:%,$(word 1,$1)),$(call ^Y,$(call `dict-get,$(word 1,$1),$(^tags)),$(wordlist 2,99999999,$1),$(word 1,$1),$1,,,,,,$`(and $`1,$`(findstring $`(subst $`(filter %,$`(call `data-foreach,$``(if $``(findstring $``(subst $``20,1,S0),1),$``(call ^d,$``1),$``1),$`(wordlist 2,99999999,$`1),$`2,$`3))0,1,$`(filter %,$`4)0),1),($`(call ^n,1,$`1)$`(if $`(wordlist 2,99999999,$`1), )$`(call `data-foreach,$``(if $``(and $``(findstring $``(subst $``20,1,L0),1),$``(if $``1,,1)),[],$``(call `format,$``1)),$`(wordlist 2,99999999,$`1),$`2,)))))
`*format-funcs* := 
`format-add = $(call ^set,`*format-funcs*,$(call `cons,$1,$(`*format-funcs*)))
`format-custom = $(if $2,$(or $(call ^Y,$1,,,,,,,,,$(call ^n,1,$2)),$(call `format-custom,$1,$(wordlist 2,99999999,$2))))
define `format
$(or $(call `format-custom,$1,$(`*format-funcs*)),$(if $(findstring !,$1),$(or $(call `format-dict,$1),$(call `format-record,$1))),$(if $(or $(findstring !,$1),$(and $(findstring $  ,$1),$(call `numeric?,$(subst $  ,,$1)))),$(if $(findstring $(subst $(foreach ;,$1,$(call ^d,$(call ^u,$;)))0,1,$10),1),[$(foreach ;,$1,$(call `format,$(call ^u,$;)))])),$(call `numeric?,$1),"$(subst ,\x0d,$(subst $ 	,\t,$(subst 
,\n,$(subst ",\",$(subst \,\\,$1)))))")
endef
`vsp-split = $(subst !%$(or $(word 1,$1),%),!:$(word 1,$1) ,$(subst !%$(or $(word 2,$1),%),!:$(word 2,$1) ,$(if $(word 3,$1),$(call `vsp-split,$(wordlist 3,99999999,$1),$2),$2)))
`vsprintfx = $(call `concat-vec,$(foreach ;,$(join $(subst !%,%,$(call `vsp-split,$3,$(subst !%!%,%,$(subst %,!%,$(call ^d,$1))))),$(addprefix !:%,$2)),$(word 1,$(subst !:, !. ,$;))$(if $(findstring !:,$(subst !:%,,$;)),$(call ^Y,$(word 2,$(subst !:, ,x$;)),$(word 2,$(subst !:%, ,$;)),,,,,,,,$4))))
`vsprintf = $(call `vsprintfx,$1,$2,s q,$`(if $`(filter q,$`1),$`(call ^d,$`(call `format,$`(call ^u,$`2))),$`2))
`sprintf = $(call `vsprintf,$1,$(foreach N,2,$(^v)))
`printf = $(info $(call `vsprintf,$1,$(foreach N,2,$(^v))))
define `expect-x
$(if $(findstring $(subst $20,1,$10),1),$(if $(findstring O,$(SCAM_DEBUG)),$(info $3: OK: $1)),$(and $(info $3: error: assertion failed
A: $(call `format,$1)
B: $(call `format,$2)

Raw:
A: $1
B: $2
)1,$(if $(findstring K,$(SCAM_DEBUG)),$(call `at-exit,$`(error $`1),1),$(error ))))
endef
`assert-x = $(or $1,$(error $(info $2: error: assertion failed)))
define `see
$(if $(findstring $1,$2),1,$(and $(info Expected: $(subst 
,
          ,$1))1,$(info $   Within: $(subst 
,
          ,$2))))
endef
`uniq-x = $(if $1,$(word 1,$1) $(call `uniq-x,$(filter-out $(word 1,$1),$(wordlist 2,99999999,$1))))
`uniq = $(subst ~1,~,$(subst ~p,%,$(filter %,$(call `uniq-x,$(subst %,~p,$(subst ~,~1,$1))))))
`split = $(subst !x,,$(patsubst !x,!.,!x$(subst $ 	,!+,$(subst !!,!1,$(subst $  ! ,!0,$(subst $(subst $  , ! ,$(subst !,!!,$1)), !x,$(subst $  , ! ,$(subst !,!!,$2))))))))
`1+ = $(if $(filter %1 %2 %3 %4,$1),$(subst 1~,2,$(subst 2~,3,$(subst 3~,4,$(subst 4~,5,$1~)))),$(if $(filter %5 %6 %7,$1),$(subst 5~,6,$(subst 6~,7,$(subst 7~,8,$1~))),$(if $(findstring 9~,$1~),$(call `1+,$(or $(subst 9~,,$1~),0))0,$(patsubst %0,%1,$(patsubst %8,%9,$1)))))
`mcache = $(and $(if $6,$(info Warning: memoized function passed more than three arguments))1,$(if $(if $(if $(filter-out u%,$(flavor $1)),1),,1),$(call ^set,$1,$(call ^Y,$3,$4,$5,,,,,,,$2),))1,$($1))
`memoenc = $(if $(or $1,$2,$3),~~$(subst ~,~0,$1)$(call `memoenc,$2,$3))
`memoize = $(if $(if $(if $(filter-out u%,$(flavor $1)),1),,1),$(info Warning: [memoize-1] function '$1' not defined.),$(call ^Y,$(value $1),*memo$(call `memoenc,$1),$1,,,,,,,$`(call ^fset,$`3,$``(call `mcache,$`(call ^E,$`2)$``(call `memoenc,$``1,$``2,$``3),$`(call ^E,$`1),$``1,$``2,$``3,$``(or $``4,$``5,$``6,$``7,$``8)),)))
`sort-by = $(filter-out %!!,$(subst !!,!! ,$(sort $(foreach ;,$2,$(call ^d,$(call ^Y,$(call ^u,$;),,,,,,,,,$1))!!$;))))
`assoc-initial = $(call ^u,$(firstword $(if $(findstring %,$1),$(subst !8,$1,$(filter !8 !8!0%,$(subst $1,!8,$2))),$(filter $1 $1!0%,$2))))
`index-of = $(words $(subst !_, ,$(filter %!|,$(subst !_$(call ^d,$2)!_,!_!| ,!_$(subst $  ,!_,$1)!_))))
`foldl = $(if $(word 1,$3),$(call `foldl,$1,$(call ^Y,$2,$(call ^n,1,$3),,,,,,,,$1),$(wordlist 2,99999999,$3)),$2)
`foldr = $(if $(word 1,$3),$(call ^Y,$(call ^n,1,$3),$(call `foldr,$1,$2,$(wordlist 2,99999999,$3)),,,,,,,,$1),$2)
`intersperse = $(subst $  , $(call ^d,$1) ,$2)
`repeat-words = $(if $(filter-out -% 0,$2),$(if $(word $2,$1 $1 $1),$(wordlist 1,$2,$1 $1 $1),$(call `repeat-words,$1 $1 $1,$2)))

endef

define [mod-repl]
# Requires: core io parse compile gen math peg utf8
# Exports: repl-ep}1'2'3 repl}0'1'2
$(call ^R,core)
$(call ^R,io)
$(call ^R,parse)
$(call ^R,compile)
$(call ^R,gen)
$(if $(or 1,$(call ^R,math),$(call ^R,peg),$(call ^R,utf8)),)
`LIBS := compile core getopts io math peg repl string utf8
*1 := 
*2 := 
define `help
$(and $(info Commands:
  :q or ^D : exit REPL loop
  :        : reset input state
  :e       : show environment
  :E       : show environment (including imported entries)
  ?        : this message

Global variables in REPL:
  *1 = most recent value printed
  *2 = second most recent value
)1,$(call `printf,LIBS = %s
,$(`LIBS)))
endef
`describe-binding = $(if $(or $3,$(if $(filter i%,$(word 2,$2)),,1)),$(if $(filter !:EDefn6,$(word 1,$2)),built-in function,$(if $(filter !:EDefn1,$(word 1,$2)),$(call `sprintf,function (%s),$(subst +, or more,$(subst $  , or ,$(call ^n,4,$2))) arguments),$(if $(filter !:EDefn2,$(word 1,$2)),$(call `sprintf,compound macro (%s),$(subst +, or more,$(subst $  , or ,$(call ^n,4,$2))) arguments),$(if $(filter !:EDefn0,$(word 1,$2)),variable,$(if $(filter !:EDefn3,$(word 1,$2)),symbol macro: $(call `format,$(wordlist 4,99999999,$2)),$(if $(filter !:EDefn4,$(word 1,$2)),executable macro,$(if $(filter !:EDefn5,$(word 1,$2)),constructor,))))))))
`describe-env = $(foreach ;,$(call `reverse,$(call `dict-compact,$1)),$(call ^Y,$(call `describe-binding,$(call ^dk,$;),$(call ^dv,$;),$2),,,,,,,,,$`(if $`1,$`(call `printf,  %s : %s,$`(call ^dk,$(call ^E,$;)),$`1))))
$(call ^at,!1:REPL0!=REPL!0S!0S!0S!0S!0S!0L)
`eval-and-print = $(call ^Y,$(call `compile-text,$1,[stdin],$5,$3,$4),$5,$1,,,,,,,$`(if $`(and $(call ^E,$2),$`(filter $`[ [ {,$`(foreach ;,$`(call ^d,$`(call ^n,1,$`(call ^dv,$`(filter errors!=%,$`1)))),$`(if $`(filter !1:P8!0%,$`;!0),$`(word 1,$`(call ^n,3,$`(call ^u,$`;))),)))),!:REPL0 $`(call ^d,$`3) $`(call ^d,$(call ^E,$2)) $`(call ^d,$(call ^E,$3)) $`(call ^d,$(call ^E,$4)) !. $`2,$`(if $`(call ^dv,$`(filter errors!=%,$`1)),$`(and $`(foreach ;,$`(call ^dv,$`(filter errors!=%,$`1)),$`(call ^d,$`(info $`(call `describe-error,$`(call ^u,$`;),$`3,[stdin]))))1,!:REPL0 !. $`(call ^d,$(call ^E,$2)) $`(call ^d,$(call ^E,$3)) $`(call ^d,$(call ^E,$4)) 1 $`2),$`(and $`(call ^Y,$`(call ^Y,,,,,,,,,,$`(call ^dv,$`(filter code!=%,$`1))),,,,,,,,,$``(if $``1,$``(and $``(call ^set,*2,$``(*1))1,$``(call ^set,*1,$``1)1,$``(info $``(call `format,$``1)))))1,!:REPL0 !. $`(call ^d,$(call ^E,$2)) $`(call ^d,$(call ^E,$3)) $`(call ^d,$(call ^E,$4)) !. $`(call ^dv,$`(filter env!=%,$`1))))))
`read-eval-print = $(if $(filter !:REPL0,$(word 1,$1)),$(call ^Y,$(call `getline,$(call ^n,$(if $(call ^n,2,$1),2,1),$(call ^n,3,$1))),$(wordlist 7,99999999,$1),$1,,,,,,,$`(if $`(findstring $`(subst ?0,1,$`(strip $`1)0),1),$`(and $`(call `help)1,$`3),$`(if $`(findstring $`(subst :0,1,$`(strip $`1)0),1),!:REPL0 !. $`(call ^d,$`(call ^n,3,$(call ^E,$1))) $`(call ^d,$`(call ^n,4,$(call ^E,$1))) $`(call ^d,$`(call ^n,5,$(call ^E,$1))) !. $`2,$`(if $`(findstring $`(subst :q0,1,$`(strip $`1)0),1),,$`(if $`(findstring $`(subst 0,1,$`10),1),,$`(if $`(findstring $`(subst :e0,1,$`(strip $`1)0),1),$`(and $`(call `describe-env,$`2,)1,$`3),$`(if $`(findstring $`(subst :E0,1,$`(strip $`1)0),1),$`(and $`(call `describe-env,$`2,1)1,$`3),$`(call `eval-and-print,$`(call ^n,2,$(call ^E,$1))$`1,$`(call ^n,3,$(call ^E,$1)),$`(call ^n,4,$(call ^E,$1)),$`(call ^n,5,$(call ^E,$1)),$`2)))))))),)
`repl = $(and $(call `do-not-trace,~repl ~eval-and-print ~while ~while-0 ~while-N)1,$(call `while,$`1,$(value `read-eval-print),!:REPL0 !. $(call ^d,$(or $2,>!0 +!0)) $(call ^d,$1) !. !. $(call ^Y,$(call `compile-text,$(foreach ;,$(`LIBS),(require "$;"))(declare *1 &native)(declare *2 &native),[stdin],,,),,,,,,,,,$`(and $`(call ^Y,,,,,,,,,,$`(call ^dv,$`(filter code!=%,$`1)))1,$`(call ^dv,$`(filter env!=%,$`1)))))1,$(info ))
`repl-ep = $(foreach ;,$(call ^d,$(call `eval-and-print,$1,,$2,$3,$(call ^Y,$(call `compile-text,$(foreach ;,$(`LIBS),(require "$;"))(declare *1 &native)(declare *2 &native),[stdin],,,),,,,,,,,,$`(and $`(call ^Y,,,,,,,,,,$`(call ^dv,$`(filter code!=%,$`1)))1,$`(call ^dv,$`(filter env!=%,$`1)))))),$(if $(filter !1:REPL0!0%,$;!0),$(call ^n,6,$(call ^u,$;)),))

endef

define [mod-getopts]
# Requires: core
# Exports: getopts}2 MissingArg@5!0i!0S!0[:GetoptsError0 BadOption@5!0i!0S!0[:GetoptsError1
$(call ^R,core)
$(call ^at,!1:GetoptsError0!=MissingArg!0S !1:GetoptsError1!=BadOption!0S)
`opt-pair = $(call ^k,$(patsubst -%,%,$(patsubst -%,%,$1)))!=$(call ^d,$2)
`getopts-loop = $(if $(if $(word 1,$3),,1),$4,$(if $(filter --,$(word 1,$3)),$(call `append,$4,$(foreach ;,$(wordlist 2,99999999,$3),*!=$;)),$(if $(filter $1,$(word 1,$3)),$(call `getopts-loop,$1,$2,$(wordlist $(or 2,2),99999999,$3),$(call `append,$4,$(call `opt-pair,$(word 1,$3),1))),$(if $(filter $2,$(word 1,$3)),$(if $(word 2,$3),$(call `getopts-loop,$1,$2,$(wordlist $(or 3,2),99999999,$3),$(call `append,$4,$(call `opt-pair,$(word 1,$3),$(call ^n,2,$3)))),$(call `append,$4,!1!=$(call ^d,!:GetoptsError0 $(call ^d,$(word 1,$3))))),$(if $(filter -%,$(word 1,$3)),$(call `getopts-loop,$1,$2,$(wordlist $(or 2,2),99999999,$3),$(call `append,$4,!1!=$(call ^d,!:GetoptsError1 $(call ^d,$(word 1,$3))))),$(call `getopts-loop,$1,$2,$(wordlist $(or 2,2),99999999,$3),$(call `append,$4,*!=$(word 1,$3))))))))
`getopts = $(call `dict-collate,$(call `getopts-loop,$(filter-out %=,$2),$(call `filtersub,%=,%,$2),$1))

endef

define [mod-compile]
# Requires: core parse gen gen0 gen1 io memo escape macros
# Exports: compile-text}2'3'4'5 run-program}2'3'4 build-program}2'3'4 ModSuccess@5!0i!0S'L!0[:Mod0 ModError@5!0i!0S!0[:Mod1
$(call ^R,core)
$(call ^R,parse)
$(call ^R,gen)
$(call ^R,gen0)
$(call ^R,gen1)
$(call ^R,io)
$(call ^R,memo)
$(call ^R,escape)
$(call ^R,macros)
`*compiling* := 
define `build-message
$(or $(`*is-quiet*),$(call `write,2,... $1 $2
))
endef
define `bail-if
$(if $1,$(and $(call `fprintf,2,scam: %s
,$1)1,$(call `memo-drop)1,1),$(and 1,))
endef
`descendants = $(if $2,$(call `descendants,$1,$(call `append,$(wordlist 2,99999999,$2),$(call `vec-filter,filter-out,$2 $3,$(call ^Y,$(call ^n,1,$2),,,,,,,,,$1))),$(call `append,$3,$(word 1,$2))),$3)
define `env-cmp
$(subst @2!0i!0..!0,#,$(subst @1!0i!0%!0,},$(subst !0!]7!0,{,$(subst !=!1:EDefn,@,$(subst !0[:IL,|,$(subst 1:IL,],$(subst !11,[,$(subst !10,',$(subst #,!H,$(subst },!G,$(subst {,!F,$(subst @,!E,$(subst |,!D,$(subst ],!C,$(subst [,!B,$(subst ',!A,$1))))))))))))))))
endef
define `env-exp
$(subst !A,',$(subst !B,[,$(subst !C,],$(subst !D,|,$(subst !E,@,$(subst !F,{,$(subst !G,},$(subst !H,#,$(subst ',!10,$(subst [,!11,$(subst ],1:IL,$(subst |,!0[:IL,$(subst @,!=!1:EDefn,$(subst {,!0!]7!0,$(subst },@1!0i!0%!0,$(subst #,@2!0i!0..!0,$1))))))))))))))))
endef
define `env-compress
$(call `env-cmp,$(foreach ;,$(patsubst %!0,%,$(subst 
,!n,$1)),$(word 1,$(subst !=, ,$;))!=$(subst `$(word 1,$(subst !=, ,$;)),%,$(subst %,!p,$(word 2,$(subst !=,. ,$;))))))
endef
define `env-parse
$(subst !n,
,$(subst !n,
,$(foreach ;,$(call `env-exp,$(foreach ;,Exports $(if $2,Private),$(call ^u,$(call `filtersub,$(call ^d,# $;: %),%,$1)))),$(word 1,$(subst !=, ,$;))!=$(subst !p,%,$(subst %,`$(word 1,$(subst !=, ,$;)),$(word 2,$(subst !=,. ,$;)))))))
endef
`modid-from-source = $(if $(`*is-boot*),$(basename $(call `escape-path,$1)),$(`*obj-dir*)$(call `escape-path,$1))
define `modid-read-lines
$(if $(or $(filter %.scm,$(call ^d,$1)),$(`*is-boot*)),$(and $(call `memo-hash-file,$(if $(`*is-boot*),$(`*obj-dir*)$1.o,$1.o))1,$(call `read-lines,$(if $(`*is-boot*),$(`*obj-dir*)$1.o,$1.o),$(and $2,1),$2)),$(wordlist 1,$(or $2,99999999),$(call `split,
,$(value [mod-$1]))))
endef
define `modid-deps
$(call ^Y,$(call `modid-read-lines,$1,4),,,,,,,,,$`(and $`(call `assert-x,$`1,compile.scm:323)1,$`(call ^u,$`(call `filtersub,#!0Requires:!0%,%,$`1))))
endef
`modid-import = $(call `env-parse,$(call `modid-read-lines,$1,4),$2)
`locate-source = $(call ^n,1,$(filter-out !.,$(foreach ;,$(call `cons,$1,$(addsuffix /,$(call `split,:,$(SCAM_LIBPATH)))),$(call ^d,$(call `file-exists?,$(call `resolve-path,$(call ^u,$;),$2))))))
`m-locate-source = $(call `memo-io,`locate-source,$1,$2)
define `skip-comments
$(if $(filter #% !.,$(word 1,$1)),$(call `append,$(filter $2,$(word 1,$1)),$(call `skip-comments,$(wordlist 2,99999999,$1),$2)),$1)
endef
define `construct-bundle

$ define [mod-$1]
$(call `concat-vec,$(call `skip-comments,$(call `modid-read-lines,$1),$(if $2,#!0Req% #!0Exp%)),
)
$ endef

endef
$(call ^at,!1:Mod0!=ModSuccess!0S!0L !1:Mod1!=ModError!0S)
`get-source-module = $(or $(if $(if $3,,1),!:Mod1 $(call ^d,$(call `sprintf,cannot find `%s`,$1))),$(if $(call `memo-call,$(if $2,`compile-module,`compile-and-test-module),$3),!:Mod1 $(call ^d,$(call `sprintf,compilation of `%s` failed,$3))),!:Mod0 $(call ^d,$(call `modid-from-source,$3)) $(call `memo-blob-call,`modid-import,$(call `modid-from-source,$3),$2))
`get-module = $(call ^Y,$(if $(filter %.scm,$(call ^d,$1)),$(call `get-source-module,$1,$3,$(call `m-locate-source,$(call ^u,$(dir $(call ^d,$2))),$1)),$(and $(if $(`*is-boot*),!:Mod1 standard!0modules!0not!0available!0with!0--boot)1,$(if $(if $(filter-out u%,$(flavor [mod-$1])),1),!:Mod0 $(call ^d,$1) $(call `modid-import,$1,),!:Mod1 $(call ^d,$(call `sprintf,standard module `%s` not found,$1))))),,,,,,,,,$`(or $`(if $`(filter !:Mod0,$`(word 1,$`1)),$`(if $`(word 1,$`(foreach ;,$`(wordlist 3,99999999,$`1),$`(foreach ;;,$`(call ^d,$`(call ^dv,$`;)),$`(if $`(filter !1:EDefn4!0%,$`(;;)!0),1,)))),$`(if $`(`*is-boot*),!:Mod1 module!0has!0executable!0macros!0(boot=true),$`(and $`(call `memo-hash-file,$`(if $`(`*is-boot*),$`(`*obj-dir*)$`(call ^n,2,$`1).o,$`(call ^n,2,$`1).o))1,$`(call ^R,$`(call ^n,2,$`1))))),),$`1))
`M.require = $(or $(if $(call `skip-flags,$3),$(call `gen-error,$(call ^n,1,$(call `skip-flags,$3)),too many arguments to require)),$(if $(filter !:P1,$(word 1,$(call ^n,1,$3))),$(foreach ;,$(call ^d,$(call `get-module,$(call ^n,3,$(call ^n,1,$3)),$(`*compile-file*),$(filter &private,$(call `get-flags,$3)))),$(if $(filter !1:Mod1!0%,$;!0),$(call `gen-error,$(call ^n,1,$3),require: %s,$(call ^n,2,$(call ^u,$;))),$(if $(filter !1:Mod0!0%,$;!0),!:IL12 $(call ^d,$(wordlist 3,99999999,$(call ^u,$;))) !:IL7 ^R $(call ^d,!:IL8 $(call ^d,!:IL4 $(call ^d,$(call ^n,2,$(call ^u,$;)))) $(call ^d,!:IL11 require $(call ^d,$(call ^n,2,$(call ^u,$;))))),))),$(call `err-expected,Q,$(call ^n,1,$3),$2,STRING,(require STRING))))
`runtime-module-name = $(if $(`*is-boot*),$(filter-out $(subst -q.scm,.scm,$(call ^d,$1)),runtime.scm),runtime)
`compile-prelude = $(foreach ;,$(call `runtime-module-name,$1),$(foreach ;;,$(call ^d,$(call `get-module,$;,.,)),$(if $(filter !1:Mod0!0%,$(;;)!0),$(wordlist 3,99999999,$(call ^u,$(;;))),$(if $(filter !1:Mod1!0%,$(;;)!0),$(error $(call ^n,2,$(call ^u,$(;;)))),))))
`parse-and-gen = $(if $(if $1,,1),errors!=$(call ^d,$(call ^d,!:P8 0 File!0is!0empty!0or!0does!0not!0exist)),$(call ^set,`*compile-subject*,$(call ^set,`*compile-subject*,$(call `penc,$1),$(`*compile-subject*)),$(call ^set,`*compile-file*,$(call ^set,`*compile-file*,$3,$(`*compile-file*)),$(call ^Y,$(call `gen0,$(call `parse-subject,$(`*compile-subject*)),$2),$4,,,,,,,,$`(call `gen1,$`(wordlist 2,99999999,$`1),$`2) env!=$`(call ^d,$`(call ^n,1,$`1))))))
define `trim-hashbang
$(if $(filter #%,$(word 1,$1)),
$(call `concat-vec,$(wordlist 2,99999999,$(call `split,
,$1)),
),$1)
endef
define `compile-module
$(or $(if $(call `vec-filter,filter,$(call ^d,$1),$(`*compiling*)),$(call `bail-if,dependency loop: $(call `concat-vec,$(call `conj,$(`*compiling*),$1), -> ))),$(call ^set,`*compiling*,$(call ^set,`*compiling*,$(call `conj,$(`*compiling*),$1),$(`*compiling*)),$(and $(call `build-message,compile,$1)1,$(call ^Y,$(call `parse-and-gen,$(call `trim-hashbang,$(call `memo-read-file,$1)),$(call `compile-prelude,$1),$1,1),$1,,,,,,,,$`(if $`(call ^dv,$`(filter errors!=%,$`1)),$`(and $`(foreach ;,$`(call ^dv,$`(filter errors!=%,$`1)),$`(call ^d,$`(info $`(call `describe-error,$`(call ^u,$`;),$`(call `trim-hashbang,$`(call `memo-read-file,$(call ^E,$1))),$`2))))1,$`(call `memo-drop)1,1),$`(and $`(call `bail-if,$`(call `memo-write-file,$`(if $`(`*is-boot*),$`(`*obj-dir*)$`(call `modid-from-source,$`2).o,$`(call `modid-from-source,$`2).o),# Requires: $`(call ^dv,$`(filter require!=%,$`1))
$`(call ^Y,$`(filter p:% x:%,$`(foreach ;,$`(call `dict-compact,$`(call ^dv,$`(filter env!=%,$`1))),$`(word 2,$`(call ^dv,$`;)):$`(call ^k,$`(call ^dk,$`;))!=$`(call ^d,$`(word 1,$`(call ^dv,$`;)) i $`(wordlist 3,99999999,$`(call ^dv,$`;))))),,,,,,,,,# Exports: $``(call `env-compress,$``(call `filtersub,x:%,%,$``1))
# Private: $``(call `env-compress,$``(call `filtersub,p:%,%,$``1))
)$`(call ^dv,$`(filter code!=%,$`1))))1,))))))
endef
`modid-deps-all = $(call `descendants,$(value `modid-deps),$(call `uniq,$(call `cons,$1,$(foreach ;,$(call `runtime-module-name,),$(if $;,$(call ^d,$(if $(filter %.scm,$;),$(call `modid-from-source,$;),$;)))))))
define `link
$(and $(call `build-message,link,$1)1,$(call `bail-if,$(or $(call `memo-write-file,$1,$(call ^Y,$(call `modid-deps-all,$2),,,,,,,,,#!/bin/bash
:; for v in "$``{@//!/!1}" ; do v=$``{v// /!0} ; v=$``{v//	/!+}; a[++n]=$``{v:-!.} ; done ; LC_ALL=C SCAM_ARGS=$``{a[*]} exec make -Rr --no-print-directory -f"$``0" 9>&1
SCAM_MAIN := $`(call `protect-rhs,$`(call ^d,$(call ^E,$2)) $`(call `gen-native-name,main,))
^uid := $`(call `hash-output,cat -- %V,$`(filter-out !.,$`(foreach ;,$`1,$`(call ^d,$`(if $`(or $`(filter %.scm,$`(call ^d,$`(call ^u,$`;))),$`(`*is-boot*)),$`(if $`(`*is-boot*),$`(`*obj-dir*)$`(call ^u,$`;).o,$`(call ^u,$`;).o))))))
$`(subst ~x,,$`(subst ~x~x ,,$`(foreach ;,$`1,$`(subst ~,~~x,$`(call `construct-bundle,$`(call ^u,$`;),$`(filter compile,$`1)))~x~x)))$``(eval $``(value [mod-runtime]))
)),$(call `memo-chmod-file,$1,+x))))
endef
`run = $(and $(if $3,$(call `build-message,run,$1))1,$(call `modid-deps-all,$(call `modid-from-source,$1))1,$(if $(filter-out 0,$(lastword $(call `shellf,SCAM_ARGS=%A %s -Rr --no-print-directory -f%A SCAM_MAIN=%A SCAM_TMP=%A SCAM_DIR=%A 1>&9 ; echo " $`?",$2,$(MAKE),$(if $(`*is-boot*),$(if $(`*is-boot*),$(`*obj-dir*)runtime.o,runtime.o),$(firstword $(MAKEFILE_LIST))),$(call ^d,$(call `modid-from-source,$1)) $(call `gen-native-name,main,),$(`*obj-dir*),$(if $(`*is-boot*),$(`*obj-dir*))))),$(and 1,$(call `memo-drop)1,1),$(and 1,)))
`compile-and-test-module = $(or $(call `memo-call,`compile-module,$1),$(and $(call `memo-hash-file,$(subst .scm,-q.scm,$1)),$(or $(call `memo-call,`compile-module,$(subst .scm,-q.scm,$1)),$(if $(call `memo-call,`run,$(subst .scm,-q.scm,$1),,1),$(call `bail-if,$(subst .scm,-q.scm,$1) failed)))))
define `build-program
$(call ^set,`*obj-dir*,$(call ^set,`*obj-dir*,$(if $3,$(patsubst %//,%/,$3/),.scam/)$(or $(`cache-instance),$(call ^set,`cache-instance,$(call `hash-output,echo %s $`(pwd),$(^uid))),$(`cache-instance))/,$(`*obj-dir*)),$(call ^set,`*is-quiet*,$(call ^set,`*is-quiet*,$4,$(`*is-quiet*)),$(call `memo-minus,$(if $(`*memo-on*),,$(and $(call `memo-start-session,$(`*obj-dir*)db)1,1)),$(if $(if $(call `memo-hash-file,$1),,1),$(and $(call `fprintf,2,scam: file `%s` does not exist
,$1)1,1),$(or $(call `memo-call,$(if ,`compile-module,`compile-and-test-module),$1),$(call `memo-call,`link,$2,$(call `modid-from-source,$1)))))))
endef
`run-program = $(call ^set,`*obj-dir*,$(call ^set,`*obj-dir*,$(if $3,$(patsubst %//,%/,$3/),.scam/)$(or $(`cache-instance),$(call ^set,`cache-instance,$(call `hash-output,echo %s $`(pwd),$(^uid))),$(`cache-instance))/,$(`*obj-dir*)),$(call ^set,`*is-quiet*,$(call ^set,`*is-quiet*,$4,$(`*is-quiet*)),$(call `memo-minus,$(if $(`*memo-on*),,$(and $(call `memo-start-session,$(`*obj-dir*)db)1,1)),$(or $(call `memo-call,$(if ,`compile-module,`compile-and-test-module),$1),$(call `run,$1,$2,)))))
`compile-text = $(and $(call `assert-x,$(if $(`*is-boot*),,1),compile.scm:791)1,$(call ^set,`*obj-dir*,$(call ^set,`*obj-dir*,$(if $4,$(patsubst %//,%/,$4/),.scam/)$(or $(`cache-instance),$(call ^set,`cache-instance,$(call `hash-output,echo %s $`(pwd),$(^uid))),$(`cache-instance))/,$(`*obj-dir*)),$(call ^set,`*is-quiet*,$(call ^set,`*is-quiet*,$5,$(`*is-quiet*)),$(call `memo-minus,$(if $(`*memo-on*),,$(and $(call `memo-start-session,$(`*obj-dir*)db)1,1)),$(call `parse-and-gen,$1,$(or $3,$(call `compile-prelude,)),$2,)))))

endef

define [mod-gen]
# Requires: core parse
# Exports: gen-native-name}2 resolve}2 bind-target}4 bind-nxmap}4 first-perror}1 parse-target}1'2 Bind@5!0i!0S'S!0[:NX0 check-arity}3 err-expected}5'6'7 gen-error}2+ gensym}2 depth.l#1!0!]6!0subst|4';|4'[.|0'1'. depth.a#1!0!]6!0subst|4'.|4'[.|0'1'. current-depth}1 gensym-name}3 il-nth-rest}2 il-nth#2!0!]8|4'[]7|4'[0|4'^n|4'[0|8'[]7[0^d[0[1]8[10[11]4[110[111]4[10[11]4[110[1110[10[11]7[110^d[110[111]0[11101[1110.'[]4[0[10'[]7[0^d[0[1]0[102[10. il-word#2!0!]8|4'[]6|4'[0|4'word|4'[0|8'[]7[0^d[0[1]8[10[11]4[110[111]4[10[11]4[110[1110[10[11]7[110^d[110[111]0[11101[1110.'[]4[0[10'[]7[0^d[0[1]0[102[10. il-subst}3 subst-in-il}3 il-vector}1 il-promote}1 il-demote}1 il-concat}1 EnvErrorKey@3!0i!0.!0!]4!0; depth-marker#1!0!]8|4':[1=|7'^d'[]8[0[1]4[10[111:EDefn7[0[1]4[10[110[0[1]0[101[10. EDefn.arg#2!0!]8|4'[1:EDefn3|4'[0|4'p|4'[0|0'2'.|4'[0|8'[]4[0[1]0'[]4[0[10'[]0[01[0.'[]4[0[10'[]4[0. EDefn.set-scope#2!0!]8|6'word'[]4[01'[]0[01[0.|4'[0|0'2'.|4'[0|6'wordlist'[]4[03'[]4[099999999'[]0[01[0. EDefn.scope#1!0!]6!0word|4'2|0'1'. EVar@5!0i!0W'W!0[:EDefn0 EFunc@5!0i!0W'W'S!0[:EDefn1 EMacro@5!0i!0W'W'S'L!0[:EDefn2 EIL@5!0i!0W'W'L!0[:EDefn3 EXMacro@5!0i!0W'W!0[:EDefn4 ERecord@5!0i!0W'S'S!0[:EDefn5 EBuiltin@5!0i!0W'W'S!0[:EDefn6 EMarker@5!0i!0W!0[:EDefn7 IArg@5!0i!0W'W|0 ILambda@5!0i!0S|1 IFuncall@5!0i!0L|2 IFor@5!0i!0W'S'L|3 IString@5!0i!0S|4 IVar@5!0i!0W|5 IBuiltin@5!0i!0W'L|6 ICall@5!0i!0W'L|7 IConcat@5!0i!0L|8 IBlock@5!0i!0L|9 IWhere@5!0i!0W|10 ICrumb@5!0i!0W'S|11 IEnv@5!0i!0S'L|12 *is-boot*@0!0i!0% *compile-file*@0!0i!0% *compile-subject*@0!0i!0%
$(call ^R,core)
$(call ^R,parse)
`*is-boot* := 
$(call ^at,!1:IL0!=IArg!0W!0W !1:IL1!=ILambda!0S !1:IL2!=IFuncall!0L !1:IL3!=IFor!0W!0S!0L !1:IL4!=IString!0S !1:IL5!=IVar!0W !1:IL6!=IBuiltin!0W!0L !1:IL7!=ICall!0W!0L !1:IL8!=IConcat!0L !1:IL9!=IBlock!0L !1:IL10!=IWhere!0W !1:IL11!=ICrumb!0W!0S !1:IL12!=IEnv!0S!0L)
$(call ^at,!1:EDefn0!=EVar!0W!0W !1:EDefn1!=EFunc!0W!0W!0S !1:EDefn2!=EMacro!0W!0W!0S!0L !1:EDefn3!=EIL!0W!0W!0L !1:EDefn4!=EXMacro!0W!0W !1:EDefn5!=ERecord!0W!0S!0S !1:EDefn6!=EBuiltin!0W!0W!0S !1:EDefn7!=EMarker!0W)
`il-merge-strings = $(if $(filter !:IL4,$(word 1,$(call ^n,1,$1))),$(call `il-merge-strings,$(wordlist 2,99999999,$1),$2$(call ^n,2,$(call ^n,1,$1))),$(call `append,$(if $2,$(call ^d,!:IL4 $(call ^d,$2))),$(word 1,$1),$(if $(word 2,$1),$(call `il-merge-strings,$(wordlist 2,99999999,$1),))))
`il-flatten = $(filter %,$(foreach ;,$1,$(if $(filter !:IL8,$(word 1,$(call ^u,$;))),$(call `il-flatten,$(wordlist 2,99999999,$(call ^u,$;))),$;)))
`il-concat = $(call ^Y,$(call `il-merge-strings,$(call `il-flatten,$1),),,,,,,,,,$`(if $`(word 2,$`1),!:IL8 $`1,$`(call ^n,1,$`1)))
`il-demote = $(or $(if $(filter !:IL4,$(word 1,$1)),!:IL4 $(call ^d,$(word 2,$1)),$(if $(filter !:IL7,$(word 1,$1)),$(if $(findstring $(subst ^u0,1,$(word 2,$1)0),1),$(call ^n,1,$(wordlist 3,99999999,$1))),)),!:IL7 ^d $(call ^d,$1))
`il-promote = !:IL7 ^u $(call ^d,$1)
`il-vector = $(call `il-concat,$(call `intersperse,!:IL4 !0,$(foreach ;,$1,$(call ^d,$(call `il-demote,$(call ^u,$;))))))
`subst-in-il = $(if $(filter !:IL4,$(word 1,$3)),!:IL4 $(call ^d,$(subst $1,$2,$(call ^n,2,$3))),!:IL6 subst $(call ^d,!:IL4 $(call ^d,$1)) $(call ^d,!:IL4 $(call ^d,$2)) $(call ^d,$3))
`il-subst = $(or $(if $(filter !:IL4,$(word 1,$1)),$(if $(filter !:IL4,$(word 1,$2)),$(call `subst-in-il,$(call ^n,2,$1),$(call ^n,2,$2),$3),),),!:IL6 subst $(call ^d,$1) $(call ^d,$2) $(call ^d,$3))
`il-nth-rest = !:IL6 wordlist $(call ^d,!:IL4 $(call ^d,$1)) $(call ^d,!:IL4 99999999) $(call ^d,$2)
`gensym-name = $(if $(filter $1&$3!=%,$2),$(call `gensym-name,$1,$2 .,$(words $2)),$1&$3)
`current-depth = $(foreach ;,$(call ^d,$(call `dict-get,:,$1)),$(if $(filter !1:EDefn7!0%,$;!0),$(word 2,$(call ^u,$;)),.))
`gensym = !:P2 0 $(call ^d,$(call `gensym-name,$(call `symbol-name,$1),$2,))
`gen-error = !:P8 $(or $(call `form-index,$1),$(if $(call `numeric?,$1),$1,0)) $(call ^d,$(call `vsprintf,$2,$(foreach N,3,$(^v))))
`form-description = $(if $(findstring $(subst %0,1,$10),1),form,$(if $(findstring $(subst L0,1,$10),1),list,$(if $(findstring $(subst S0,1,$10),1),symbol,$(if $(findstring $(subst P0,1,$10),1),target,$(if $(findstring $(subst Q0,1,$10),1),literal string,$(call `form-typename,$1))))))
`err-expected = $(call `gen-error,$(or $2,$3),$(if $2,invalid,missing) $4 in $5$(if $1,; expected a $(subst ~x,,$(subst ~x~x , or ,$(foreach ;,$1,$(subst ~,~~x,$(call `form-description,$(call ^u,$;)))~x~x)))),$6,$7)
`check-arity = $(if $(if $(or $(filter 0+ $(words $2),$1),$(and $(findstring +,$1),$(word $(patsubst %+,%,$1),$2))),,1),$(call `gen-error,$3,$(subst %S,$(if $(findstring $(subst 10,1,$(subst +, or more,$(subst $  , or ,$1))0),1),,s),$(if ,,`%s` accepts %s argument%S, not %s)),$(call `symbol-name,$3),$(subst +, or more,$(subst $  , or ,$1)),$(words $2)))
$(call ^at,!1:NX0!=Bind!0S!0S)
`parse-target = $(or $(if $(filter !:P2,$(word 1,$1)),$(if $(filter ?% ...%,$1),,$(call ^d,!:NX0 $(call ^d,$(call ^n,3,$1)) $(call ^d,$(or $2,$`1)))),),$(call `pt,$1,$(or $2,$`1)))
`perror-pattern := $(call ^d,$(word 1,!:P8  !.))!0%
`first-perror = $(call ^n,1,$(filter $(`perror-pattern),$1))
`pt-err = $(call ^d,$(call `gen-error,$1,$(call ^n,$(subst 1,$(if $(filter ...%,$(call `symbol-name,$1)),2,1),$2),$(if ,,'?NAME'!0can!0appear!0only!0in!0parameter!0lists!0after!0all!0non-optional!0parameters '...NAME'!0can!0appear!0only!0as!0the!0last!0parameter!0or!0vector!0target!0element invalid!0assignment!0target;!0{=NAME:!0TARGET,!0...}!0unpacks!0pairs,!0{KEY:!0TARGET,!0...}!0extracts!0fields in!0dictionary!0field!0targets,!0keys!0must!0be!0symbols!0or!0string!0literals invalid!0assignment!0target;!0expected!0symbol,!0vector,!0or!0dictionary))))
`pt-pair = $(or $(if $(filter !:P2,$(word 1,$1)),$(if $(filter =%,$1),$(call `cons,!:NX0 $(call ^d,$(patsubst =%,%,$(call ^n,3,$1))) $(call ^d,!:IL7 ^dk $`(call ^d,$`(if $`(filter $(call ^E,$3),1),$`(call ^Y,$`1,,,,,,,,,$(call ^E,$5)),!:IL6 word $`(call ^d,!:IL4 $`(call ^d,$(call ^E,$3))) $`(call ^d,$`(call ^Y,$`1,,,,,,,,,$(call ^E,$5)))))),$(call `pt,$2,!:IL7 ^dv $`(call ^d,$`(if $`(filter $(call ^E,$3),1),$`(call ^Y,$`1,,,,,,,,,$(call ^E,$5)),!:IL6 word $`(call ^d,!:IL4 $`(call ^d,$(call ^E,$3))) $`(call ^d,$`(call ^Y,$`1,,,,,,,,,$(call ^E,$5))))))),$(if $(and $(filter ...,$1),$4),$(call `pt,$2,$`(call `il-nth-rest,$(call ^E,$3),$`(call ^Y,$`1,,,,,,,,,$(call ^E,$5)))))),),$(call `pt-err,$1,3))
`pt-dict = $(or $(foreach ;,$(call ^d,$(call ^dk,$1)),$(if $(filter !1:P2!0%,$;!0),$(if $(filter ... =%,$(call ^n,3,$(call ^u,$;))),$(filter %,$(foreach ;;,$(call `indices,$1),$(call `pt-pair,$(call ^dk,$(word $(call ^u,$(;;)),$1)),$(call ^dv,$(word $(call ^u,$(;;)),$1)),$(call ^u,$(;;)),$(filter $(call ^u,$(;;)),$(words $1)),$2)))),)),$(foreach ;,$1,$(or $(filter %,$(foreach ;;,$(foreach ;;,$(call ^d,$(call ^dk,$;)),$(if $(filter !1:P2!0% !1:P1!0%,$(;;)!0),$(call ^d,$(call ^n,3,$(call ^u,$(;;)))),)),$(call `pt,$(call ^dv,$;),!:IL7 ^dv $`(call ^d,!:IL6 filter $`(call ^d,!:IL4 $`(call ^d,$`(subst %,!8,$`(call ^d,$`(call ^u,$(call ^E,$(;;)))))!=%)) $`(call ^d,$`(call ^Y,$`1,,,,,,,,,$(call ^E,$2))))))),$(call `pt-err,$(call ^dk,$;),4))))
`pt-vec = $(filter %,$(foreach ;,$(call `indices,$1),$(or $(if $(filter $(call ^u,$;),$2),$(foreach ;;,$(call ^d,$(call ^n,$(call ^u,$;),$1)),$(if $(filter !1:P2!0%,$(;;)!0),$(if $(filter ...%,$(call ^n,3,$(call ^u,$(;;)))),$(call ^d,!:NX0 $(call ^d,$(or $(patsubst ...%,%,$(call ^n,3,$(call ^u,$(;;)))),$(call ^n,3,$(call ^u,$(;;))))) $(call ^d,$`(call `il-nth-rest,$`(words $(call ^E,$1)),$`(call ^Y,$`1,,,,,,,,,$(call ^E,$3)))))),))),$(call `pt,$(call ^n,$(call ^u,$;),$1),!:IL7 ^n $`(call ^d,!:IL4 $`(call ^d,$`(call ^u,$(call ^E,$;)))) $`(call ^d,$`(call ^Y,$`1,,,,,,,,,$(call ^E,$3)))))))
`pt = $(if $(filter !:P2,$(word 1,$1)),$(if $(filter ...% ?%,$1),$(call `pt-err,$1,1),$(call ^d,!:NX0 $(call ^d,$(call ^n,3,$1)) $(call ^d,$2))),$(if $(filter !:P9,$(word 1,$1)),$(call `pt-vec,$(call ^n,3,$1),$(words $(call ^n,3,$1)),$2),$(if $(filter !:P3,$(word 1,$1)),$(call `pt-dict,$(wordlist 3,99999999,$1),$2),$(call `pt-err,$1,5))))
`bind-nxmap = $(filter %,$(foreach ;,$1,$(if $(filter !:NX0,$(word 1,$(call ^u,$;))),$(call ^k,$(call ^n,2,$(call ^u,$;)))!=$(call ^d,!:EDefn3 $2 $3 $(call ^Y,$4,,,,,,,,,$(call ^n,3,$(call ^u,$;)))),;!=$;)))
`bind-target = $(call `bind-nxmap,$(call `parse-target,$1),$2,$3,$4)
`base-env := $(foreach ;,abspath basename dir error firstword lastword notdir realpath shell sort suffix wildcard words native-eval native-flavor native-origin native-strip native-value addprefix/2 addsuffix/2 filter/2 filter-out/2 findstring/2 join/2 word/2 patsubst/3 wordlist/3 and/0+ or/0+ native-call/1+ if/2/3,$(call ^k,$(word 1,$(subst /, ,$;)))!=$(call ^d,!:EDefn6 i $(subst native-,,$(word 1,$(subst /, ,$;))) $(call ^d,$(or $(wordlist 2,99999999,$(subst /, ,$;)),1)))) native-var!=$(call ^d,!:EDefn6 i = 1)
`resolve = $(if $(filter !:P2,$(word 1,$1)),$(call ^dv,$(or $(filter $(subst !,!1,$(call ^n,3,$1))!=%,$2),$(filter $(subst !,!1,$(call ^n,3,$1))!=%,$(`base-env)))),-)
`gen-native-name = $(if $(filter %&native,$2),$1,$(if $(`*is-boot*),`$1,'$1))

endef

define [mod-io]
# Requires: core string
# Exports: get-tmp-dir}0'1 unescape-path}1 escape-path}1 resolve-path}2 clean-path}1 save-blob}2 hash-output}1+ hash-file}1 hash-files}1 file-exists?}1 cp-file-atomic}2'3 cp-file}2'3 mkdir-p}1 read-file}1 read-lines}1'2'3 chmod-file}2 getline}1 fprintf}2+ vfprintf}3 write-file-atomic}2 mv-file}2 write-file}2 write}2 pipe}2+ shell-lines}1+ shellf}1+ io-sprintf}1+ quote-sh-file}1 quote-sh-arg}1 path-basename#1{^u|6'basename'[]7[0^d[0[1]0[101[10. path-notdir#1{^u|6'notdir'[]7[0^d[0[1]0[101[10. path-dir#1{^u|6'dir'[]7[0^d[0[1]0[101[10.
$(call ^R,core)
$(call ^R,string)
`ioshell = $(and $(if $(filter S,$(SCAM_DEBUG)),$(call `printf,shell: %q,$1))1,$(shell $1))
`quote-sh-arg = '$(subst ','\'',$1)'
`quote-sh-file = $(call `quote-sh-arg,$(if $(filter -%,$(call ^d,$1)),./)$1)
`io-vsprintf = $(call `vsprintfx,$1,$2,s A F V,$`(if $`(filter A,$`1),$`(call `quote-sh-arg,$`2),$`(if $`(filter F,$`1),$`(call `quote-sh-file,$`2),$`(if $`(filter V,$`1),$`(subst $`  ,!0,$`(foreach ;,$`(call ^u,$`2),$`(call `quote-sh-arg,$`;))),$`2))))
`io-sprintf = $(call `io-vsprintf,$1,$(foreach N,2,$(^v)))
`shellf = $(call `ioshell,$(call `io-vsprintf,$1,$(foreach N,2,$(^v))))
`shell-vwrap = $(subst !r,,$(call `ioshell,( $(call `io-vsprintf,$1,$2) ) | sed -e '$(if $3,$(if ,,$3,$4!d;))s/!/!1/g;s/ /!0/g;s/	/!+/g;s//!r/g;s/^$`/!./'))
`shell-lines = $(call `shell-vwrap,$1 ; echo ,$(foreach N,2,$(^v)))
`shell-ok = $(call ^Y,$(call `shell-vwrap,$1 2>&1 ; echo $`?,$(foreach N,2,$(^v))),,,,,,,,,$`(lastword $`1) $`(call `butlast,$`1))
define `pipe
$(call ^Y,$(subst !r,,$(call `ioshell,$(if $1,printf '%b' $(call `quote-sh-arg,$(subst 
,\n,$(subst \,\\,$1))) | ,cat /dev/null | )( ( ( $(call `io-vsprintf,$2,$(foreach N,3,$(^v))) ; echo 1$`? >&3 ; echo ; echo >&2 ) | sed 's/^/2/;s/!/!1/g;s/ /!0/g;s/	/!+/g;s//!r/g' ) 3>&2 2>&1 1>&3 | sed 's/^/3/;s/!/!1/g;s/ /!0/g;s/	/!+/g;s//!r/g' ) 2>&1)),,,,,,,,,$`(foreach ;,1 2 3,$`(or $`(subst $`  ,
,$`(call `filtersub,$`;%,%,$`1)),!.)))
endef
`MAX-ARG-1 := 100000
`MAX-ARG-REST := 100001
`echo-small = $(call `ioshell,printf '%b' '$(call `concat-vec,$1)' $(call `io-vsprintf,$(if $4,$(patsubst >%F,>>%F,$2),$2),$(call ^d,$3)))
`echo-split = $(if $(filter ' \,$(lastword $(subst ' \ ' ',,$(subst \ \,,$1)))),$(call `echo-split,$1 $(word 1,$2),$(wordlist 2,99999999,$2),$3,$4,$5),$(or $(call `echo-small,$1,$3,$4,$5),$(call `echo-bytes,$2,$3,$4,1)))
`echo-bytes = $(if $(word $(`MAX-ARG-REST),$1),$(call `echo-split,$(wordlist 1,$(`MAX-ARG-1),$1),$(wordlist $(`MAX-ARG-REST),99999999,$1),$2,$3,$4),$(call `echo-small,$1,$2,$3,$4))
define `write
$(call `echo-bytes,$(subst ',' \ ' ',$(subst 
,\ n,$(subst \,\ \,$(call `string-to-bytes,$2)))),$(if $(filter 2,$1),9>&2 2>&1 >&9,2>&1 >&$(patsubst 1,9,$1)),)
endef
define `write-file
$(call `echo-bytes,$(subst ',' \ ' ',$(subst 
,\ n,$(subst \,\ \,$(call `string-to-bytes,$2)))),2>&1 >%F,$1)
endef
`mv-file = $(call `shellf,mv -f %F %F 2>&1,$1,$2)
`write-file-atomic = $(call ^Y,$(call `shell-ok,mktemp %F,$1.tmp.XXXX),,,,,,,,,$`(if $`(filter-out 0,$`(call ^n,1,$`1)),$`(call ^n,2,$`1),$`(or $`(call `write-file,$`(call ^n,2,$`1),$(call ^E,$2)),$`(call `mv-file,$`(call ^n,2,$`1),$(call ^E,$1)))))
`vfprintf = $(call `write,$1,$(call `vsprintf,$2,$3))
`fprintf = $(call `vfprintf,$1,$2,$(foreach N,3,$(^v)))
define `getline
$(and $(if $1,$(call `write,1,$1))1,$(call `concat-vec,$(call `shell-lines,head -1),
))
endef
`chmod-file = $(call `shellf,chmod %s %F 2>&1,$2,$1)
`read-lines = $(call `shell-vwrap,cat %F 2>/dev/null && echo,$(call ^d,$1),$2,$3)
define `read-file
$(if $1,$(call `concat-vec,$(call `read-lines,$1),
),$(info error: read-file: nil filename))
endef
`mkdir-p = $(call `shellf,mkdir -p %F 2>&1,$1)
`cp-file = $(call `shellf,%s cp %F %F 2>&1,$(if $3,$(call `io-sprintf,mkdir -p %F 2>&1 &&,$(call ^u,$(dir $(call ^d,$2))))),$1,$2)
`cp-file-atomic = $(call `shellf,(%s a=$`(mktemp %F) && (cp %F "$`a" && mv -f "$`a" %F) || rm "$`a") 2>&1,$(if $3,$(call `io-sprintf,mkdir -p %F &&,$(call ^u,$(dir $(call ^d,$2))))),$2.tmp.XXXX,$1,$2)
`file-exists? = $(if $(call `shellf,[[ -f %F ]] && echo t,$1),$1)
`*hash-cmd* := 
`get-hash-cmd = $(or $(`*hash-cmd*),$(and $(call ^set,`*hash-cmd*,$(subst md5,md5 -r,$(or $(notdir $(word 1,$(shell which md5 sha1sum shasum 2>/dev/null))),$(error $(if ,,no md5, shasum, or sha1sum in path)))))1,$(`*hash-cmd*)))
`hash-files = $(foreach ;,$(if $(filter s%,$(call `get-hash-cmd)),!0!0,!0),$(foreach ;;,$(call `shellf,%s -- %V 2>/dev/null | sed 's/\(^................\)[^ ]*/\1/;s/!/!1/g;s/ /!0/g;s/	/!+/g',$(call `get-hash-cmd),$1),$(foreach ;;;,$(word 1,$(subst !0, ,$(;;))),$(subst %,!8,$(patsubst $(;;;)$;%,%,$(;;)))!=$(call ^d,$(;;;)))))
`hash-file = $(call ^dv,$(call `hash-files,$(call ^d,$1)))
`hash-output = $(call `ioshell,( $(call `io-vsprintf,$1,$(foreach N,2,$(^v))) ) | $(if $(filter md5,$(basename $(call `get-hash-cmd))),md5 -q,$(call `get-hash-cmd) -) | sed 's/\(^................\).*/\1/')
define `write-blob
$(addprefix $(call ^u,$(dir $(call ^d,$1))),$(if $(call `echo-bytes,$(subst ',' \ ' ',$(subst 
,\ n,$(subst \,\ \,$(call `string-to-bytes,$2)))),2>&1 >%F,$1),,$(call `shellf,( o=%F && h=$`(%s "$`o") && mv -f "$`o" %A"$`{h:0:16}" && echo "$`{h:0:16}" ) 2>/dev/null,$1,$(call `get-hash-cmd),$(call ^u,$(dir $(call ^d,$1))))))
endef
`save-blob = $(call `write-blob,$(call `shellf,mktemp %F,$1blob.XXXX),$2)
`clean-path-x = $(if $1,$(filter ..,$(word 1,$1)$(word 1,$2)) $(call `clean-path-x,$(wordlist 2,99999999,$1),$(subst /, ,$(filter-out %/..,$2/$(word 1,$1)))),$2)
`clean-path = $(call ^u,$(patsubst /./,/,$(if $(filter /%,$1),/)$(or $(subst $  ,/,$(filter %,$(call `clean-path-x,$(filter-out .,$(subst /, ,$(call ^d,$1)))))),.)$(if $(filter %/,$1),/)))
`resolve-path = $(call `clean-path,$(if $(filter /%,$2),$2,$1/$2))
define `escape-path
$(patsubst /%,+@%,$(subst ..,+.,$(subst 
,+_,$(subst $ 	,+-,$(subst |,+V,$(subst ?,+Q,$(subst *,+A,$(subst ~,+T,$(subst %,+P,$(subst =,+E,$(subst ;,+S,$(subst :,+C,$(subst $`,+D,$(subst \,+B,$(subst #,+H,$(subst !,+1,$(subst $  ,+0,$(subst +,+2,$1))))))))))))))))))
endef
define `unescape-path
$(subst +2,+,$(subst +0, ,$(subst +1,!,$(subst +H,#,$(subst +B,\,$(subst +D,$`,$(subst +C,:,$(subst +S,;,$(subst +E,=,$(subst +P,%,$(subst +T,~,$(subst +A,*,$(subst +Q,?,$(subst +V,|,$(subst +-,	,$(subst +_,
,$(subst +.,..,$(subst +@,/,$1))))))))))))))))))
endef
define `get-tmp-dir
$(if $1,$(call ^Y,$(call `pipe,,mktemp -d %F,$(or $(SCAM_TMP),.scam/)$1),,,,,,,,,$`(or $`(if $`(filter 0,$`(call ^n,1,$`1)),$`(filter-out / //,$`(call ^n,1,$`(subst 
,/ ,$`(call ^d,$`(call ^n,2,$`1)))))),$`(error get-tmp-dir failed: $`(call ^n,2,$`1)))),$(or $(SCAM_TMP),.scam/))
endef

endef

define [mod-parse]
# Requires: core string
# Exports: describe-error}3 get-subject-line}2 parse-text}1 parse-subject}1 pdec}1 penc}1 format-form}1 form-typename}1 form-index}1 PList-is-empty?}1 string-value}1 symbol-to-string}1 symbol-name}1 PList@5!0i!0W'L!0[:P0 PString@5!0i!0W'S!0[:P1 PSymbol@5!0i!0W'S!0[:P2 PDict@5!0i!0W'L!0[:P3 PQuote@5!0i!0W'L!0[:P4 PQQuote@5!0i!0W'L!0[:P5 PUnquote@5!0i!0W'L!0[:P6 PSplice@5!0i!0W'L!0[:P7 PError@5!0i!0W'S!0[:P8 PVec@5!0i!0W'S!0[:P9
$(call ^R,core)
$(call ^R,string)
$(call ^at,!1:P0!=PList!0W!0L !1:P1!=PString!0W!0S !1:P2!=PSymbol!0W!0S !1:P3!=PDict!0W!0L !1:P4!=PQuote!0W!0L !1:P5!=PQQuote!0W!0L !1:P6!=PUnquote!0W!0L !1:P7!=PSplice!0W!0L !1:P8!=PError!0W!0S !1:P9!=PVec!0W!0S)
`symbol-name = $(if $(filter !:P2,$(word 1,$1)),$(call ^n,3,$1),ERROR:symbol-name($1))
`symbol-to-string = $(if $(filter !:P2,$(word 1,$1)),!:P1 $(word 2,$1) $(call ^d,$(call ^n,3,$1)),ERROR:symbol-to-string($1))
`string-value = $(if $(filter !:P1,$(word 1,$1)),$(call ^n,3,$1),ERROR:string-value($1))
`PList-is-empty? = $(if $(filter !:P0,$(word 1,$1)),$(if $(wordlist 3,99999999,$1),,1),ERROR:PList.is-empty?($1))
`form-index = $(if $(filter !:P0 !:P1 !:P2 !:P3 !:P4 !:P5 !:P6 !:P7 !:P8 !:P9,$(word 1,$1)),$(word 2,$1),)
`form-typename = $(if $(filter !:P0,$(word 1,$1)),list,$(if $(filter !:P2,$(word 1,$1)),symbol,$(if $(filter !:P1,$(word 1,$1)),literal string,invalid form)))
`format-form = $(if $(filter !:P0,$(word 1,$1)),($(foreach ;,$(wordlist 3,99999999,$1),$(call `format-form,$(call ^u,$;)))),$(if $(filter !:P1,$(word 1,$1)),$(call `format,$(call ^n,3,$1)),$(if $(filter !:P2,$(word 1,$1)),$(call ^n,3,$1),$(if $(filter !:P4,$(word 1,$1)),'$(call `format-form,$(wordlist 3,99999999,$1)),$(if $(filter !:P5,$(word 1,$1)),`$(call `format-form,$(wordlist 3,99999999,$1)),$(if ,,,$(call `format,$1)))))))
`expand-spaces = $(subst !2,!0!0,$(subst !6,!2!2!2,$(subst !c,!6!6,$1)))
define `penc
$(subst !6!6,!c,$(subst !2!0!2!0,!6,$(subst !0!0!0,!0!2,$(subst 
!0!0,
!2,$(subst 
 !0,
!0,$(subst ; ;,;;,$(subst !s, ,$(subst $  ,,$(foreach ;,$(subst ;, ;,$(subst 
, 
,$(subst \, \,$(subst ", ",$(subst $  ,!s,$(subst !0 !0,!0!0,$(subst !0 !0,!0!0,$(subst $   , ,$(subst !+, !+ ,$(subst %, !p ,$(subst \, \,$(subst :, : ,$(subst $`, $` ,$(subst $[, $[ ,$(subst $], $] ,$(subst }, } ,$(subst {, { ,$(subst [, [ ,$(subst ], ] ,$(subst ", " ,$(subst 
, 
 ,$(subst !0, !0 ,$(subst ;, ; ,$(subst \",!Q,$(subst \\,!b,$(subst ', ' ,$(subst `, ` ,$(subst $(if ,,, @),$(if ,,,@ ),$(subst $(if ,,,),$(if ,, , ),$(if $1,$(call ^d,$1))))))))))))))))))))))))))))))),$(if $(filter ;%,$;),$(subst !s,,$;)!s,$;))))))))))
endef
`pdec = $(call ^u,$(call `expand-spaces,$(subst !p,%,$(subst !b,\\,$(subst !Q,\",$(subst $  ,,$1))))))
`find-word = $(foreach ;,$(call `1+,$(call `1+,$2)),$(if $(filter $3,$(or $(wordlist $2,$;,$1),$3)),$(if $(filter $3,$(or $(word $2,$1),$3)),$2,$(foreach ;;,$(call `1+,$2),$(if $(filter $3,$(or $(word $(;;),$1),$3)),$(;;),$;))),$(call `find-word,$1,$(call `1+,$;),$3)))
`hex-ticks = $(filter :,$(subst :, : ,$(word 2,$(subst $1, ,xFf:Ee:Dd:Cc:Bb:Aa:9:8:7:6:5:4:3:2:1:))))
`hh-to-dec = $(words $(subst :,: : : : : : : : : : : : : : : :,$(call `hex-ticks,$(word 1,$1))) $(call `hex-ticks,$(word 2,$1)))
`hex-digits := 0 1 2 3 4 5 6 7 8 9 a b c d e f A B C D E F
define `parse-string-bs
$(or $(if $(filter \n% \t%,$5),$(call `parse-string,$1,$2,$(call `1+,$3),$4$(subst \t,!+,$(subst \n,
,$5)))),$(foreach ;,$(foreach ;,$(`hex-digits),$(if $(filter \x$;%,$5),$(foreach ;;,$(`hex-digits),$(if $(filter \x$;$(;;)%,$5),$;
$(;;))))),$(call `parse-string,$1,$2,$(call `1+,$3),$4$(subst \x$(subst 
,,$;),$(call `bytes-from-bytecodes,$(call `hh-to-dec,$(strip $;))),$5))),$(call `find-word,$1,$3,") !:P8 $3 $(call ^d,!B))
endef
`parse-string = $(or $(foreach ;,$(word $3,$1),$(if $(filter ",$;),$3 !:P1 $2 $(or $(call `expand-spaces,$(subst !p,%,$(subst !b,\,$(subst !Q,",$(subst !.,,$4))))),!.),$(if $(filter \\%,$;),$(call `parse-string-bs,$1,$2,$3,$4,$;),$(call `parse-string,$1,$2,$(call `1+,$3),$4$;)))),$3 !:P8 $2 ")
`parse-seq-err = $3 $(if $(filter .,$4),!:P8 $2 $(call ^d,$(subst ],[,$(subst $],$[,$1))),!:P8 $3 $(call ^d,$4 $1))
`parse-seq = $(if $(filter !:P8,$(word 1,$(wordlist 2,99999999,$4))),$(if $(findstring $(subst $(call ^n,3,$(wordlist 2,99999999,$4))0,1,$20),1),$(word 1,$4) $(call ^Y,$3,$5,,,,,,,,$6),$(call `parse-seq-err,$2,$3,$(word 2,$(wordlist 2,99999999,$4)),$(call ^n,3,$(wordlist 2,99999999,$4)))),$(call `parse-seq,$1,$2,$3,$(call `parse-exp,$1,$(call `1+,$(word 1,$4))),$(call `conj,$5,$(wordlist 2,99999999,$4)),$6))
`parse-vector = $(call `parse-seq,$1,],$2,$(call `parse-exp,$1,$(call `1+,$2)),,!:P9 $`1 $`(call ^d,$`2))
define `parse-skip
$(if $(filter !0% !+% 
% ;%,$(word $2,$1)),$(call `parse-skip,$1,$(call `1+,$2)),$2)
endef
`parse-dict = $(call `parse-dict-1,$1,$2,,$(call `parse-exp,$1,$(call `1+,$2)))
`parse-dict-error = $(if $(filter !:P8,$(word 1,$(wordlist 2,99999999,$1))),$(if $(findstring $(subst $(call ^n,3,$(wordlist 2,99999999,$1))0,1,.0),1),$(word 2,$(wordlist 2,99999999,$1)) !:P8 $3 {,$(if $(if $(filter $2,$(call ^d,$(call ^n,3,$(wordlist 2,99999999,$1)))),,1),$(word 2,$(wordlist 2,99999999,$1)) !:P8 $(word 2,$(wordlist 2,99999999,$1)) $(call ^d,$(call ^n,3,$(wordlist 2,99999999,$1)) }))),)
`parse-dict-1 = $(or $(call `parse-dict-error,$4,},$2),$(if $(filter !:P8,$(word 1,$(wordlist 2,99999999,$4))),$(word 1,$4) !:P3 $2 $3,$(call `parse-dict-2,$1,$2,$3,$(wordlist 2,99999999,$4),$(call `parse-skip,$1,$(call `1+,$(word 1,$4))))))
`parse-dict-2 = $(if $(filter :,$(word $5,$1)),$(call `parse-dict-3,$1,$2,$3,$4,$(call `parse-exp,$1,$(call `1+,$5))),$5 !:P8 $5 :?)
`parse-dict-3 = $(or $(call `parse-dict-error,$5,},$2),$(if $(filter !:P8,$(word 1,$(wordlist 2,99999999,$5))),$(if $(findstring $(subst }0,1,$(call ^n,3,$(wordlist 2,99999999,$5))0),1),$(word 2,$(wordlist 2,99999999,$5)) !:P8 $(word 2,$(wordlist 2,99999999,$5)) v?),),$(call `parse-dict-4,$1,$2,$(call `append,$3,$(call ^k,$4)!=$(call ^d,$(wordlist 2,99999999,$5))),$(call `parse-skip,$1,$(call `1+,$(word 1,$5)))))
`parse-dict-4 = $(call `parse-dict-1,$1,$2,$3,$(call `parse-exp,$1,$(if $(filter $(if ,,,),$(word $4,$1)),$(call `1+,$4),$4)))
`parse-x2 = $(if $(filter !:P8,$(word 1,$(wordlist 2,99999999,$3))),$3,$(word 1,$3) $(call ^Y,$2,$(wordlist 2,99999999,$3),,,,,,,,$(if $(filter ',$1),!:P4 $`1 $`2,$(if $(filter `,$1),!:P5 $`1 $`2,$(if $(filter $(if ,,,),$1),!:P6 $`1 $`2,$(if $(filter $(if ,,,@),$1),!:P7 $`1 $`2,!:P8 $(call ^E,$2) $`(call ^d,internal:parse-x2:$(call ^E,$1))))))))
define `parse-x
$(if $(filter !0% !+% 
% ;% (),$(or $(word $(call `1+,$3),$2),())),$3 !:P8 $3 $(call ^d,$1),$(call `parse-x2,$1,$3,$(call `parse-exp,$2,$(call `1+,$3))))
endef
define `parse-exp
$(or $(foreach ;,$(word $2,$1),$(if $(filter !0% !+% 
%,$;),$(call `parse-exp,$1,$(call `1+,$2)),$(if $(filter $] ] },$;),$2 !:P8 $2 $(call ^d,$;),$(if $(filter $[,$;),$(call `parse-seq,$1,$],$2,$(call `parse-exp,$1,$(call `1+,$2)),,!:P0 $`1 $`2),$(if $(filter ",$;),$(call `parse-string,$1,$2,$(call `1+,$2)),$(if $(filter ;%,$;),$(call `parse-exp,$1,$(call `1+,$(call `find-word,$1,$2,
%))),$(if $(filter [,$;),$(call `parse-vector,$1,$2),$(if $(filter {,$;),$(call `parse-dict,$1,$2),$(if $(filter $(if ,,' ` , ,@),$;),$(call `parse-x,$;,$1,$2),$(if $(call `numeric?,$;),$2 !:P1 $2 $(call ^d,$;),$(if $(filter $` : !p,$;),$2 !:P8 $2 $(call ^d,$(call `pdec,$;)),$2 !:P2 $2 $;))))))))))),$2 !:P8 $2 .)
endef
`parse-subject = $(foreach ;,$(call ^d,$(wordlist 2,99999999,$(call `parse-seq,$1,.,0,$(call `parse-exp,$1,1),,!:P0 $`1 $`2))),$(if $(filter !1:P0!0%,$;!0),$(wordlist 3,99999999,$(call ^u,$;)),$;))
`parse-text = $(call `parse-subject,$(call `penc,$1))
define `get-subject-line
$(words $(filter 
%,$(wordlist 1,$(or $1,1),
 $2)))
endef
`get-error-msg = $(if $(filter ` ',$(word 1,$1)),prefix "$(word 1,$1)" must immediately precede expression,$(if $(filter ( ) [ ] { },$(word 1,$1)),unmatched "$(word 1,$1)",$(if $(filter ",$(word 1,$1)),unterminated string,$(if $(filter $(if ,,: ,),$(word 1,$1)),saw ":" where not expected,$(if $(filter :?,$(word 1,$1)),expected ": VALUE" following dictionary key,$(if $(filter v?,$(word 1,$1)),expected value following dictionary "KEY:",$(if $(filter !B,$(word 1,$1)),invalid backslash sequence in string,$(if $(filter $(word 1,$1),$`),invalid symbol character "$(word 1,$1)",$1))))))))
define `describe-error
$(if $(filter !:P8,$(word 1,$1)),$(call ^Y,$(call ^Y,$(subst 
, 
,$(subst $  ,,$(wordlist 1,$(or $(word 2,$1),1),
 $(call `penc,$2)))),,,,,,,,,$`(words $`1):$`(call `string-len,$`(call `pdec,$`(lastword $`1)))),$2,$3,$(call `get-error-msg,$(call ^n,3,$1)),,,,,,$`(if $`(call `word-index?,$`(word 2,$(call ^E,$1))),$`(call `sprintf,%s:%s: %s
%s
%s
,$`3,$`1,$`4,$`(call ^n,$`(word 1,$`(subst :, ,$`1)),$`(call `split,
,$`2)),$`(subst $`  ^,^,$`(call `string-repeat, ,$`(word 2,$`(subst :, ,$`1)))^)),$`(call `sprintf,%s: %s
,$`3,$`(call ^n,3,$(call ^E,$1))))),)
endef

endef

define [mod-math]
# Requires: core math0 math1 math2
# Exports: atan}1'2 atan2}2'3 get-pi}0'1 cos#1'2{`xsin|4'[.|0'1'.|0'2'. sin#1'2{`xsin|4'1|0'1'.|0'2'. pow}2'3 exp}1'2 log}1'2'3 num-sort}1 num-lex}1 format-fixed}1'2'3 range}2 frexp10}1 sum}0+ min}2 max}2 abs#1!0!]6!0patsubst|4'-!p|4'!p|0'1'. 0-#1!0!]6!0subst|4'--|4'[.|8'[]4[0-'[]0[01[0. <=#2!0!]6!0if|6'findstring'[]4[01'[]7[0`math-cmp[0[1]0[101[10.[0[1]0[102[10.|4'[.|4'1 >=#2!0!]6!0if|6'findstring'[]4[01'[]7[0`math-cmp[0[1]0[102[10.[0[1]0[101[10.|4'[.|4'1 =#2!0!]6!0if|7'`math-cmp'[]0[01[0.'[]0[02[0.|4'[.|4'1 !1=#2!0!]6!0if|7'`math-cmp'[]0[01[0.'[]0[02[0.|4'1 <#2!0!]6!0findstring|4'1|7'`math-cmp'[]0[02[0.'[]0[01[0. >#2!0!]6!0findstring|4'1|7'`math-cmp'[]0[01[0.'[]0[02[0. round}1'2'3 trunc#1{`raw-round|0'1'.|4'0|4'1 ceil#1{`raw-round|0'1'.|4'0|4'3 floor#1{`raw-round|0'1'.|4'0|4'9 mod#2{`binop|4'mod|0'1'.|0'2'. ^#2{`binop|4'pwr|0'1'.|0'2'. *~#2'3{`prec-op|4'mulp|0'1'.|0'2'.|0'3'. /#2'3{`prec-op|4'div|0'1'.|0'2'.|0'3'.|4'1 //#2{`binop|4'fdiv|0'1'.|0'2'. *#2{`binop|4'mul|0'1'.|0'2'. -#2{`binop|4'sub|0'1'.|0'2'. +#2{`binop|4'add|0'1'.|0'2'.
$(call ^R,core)
$(call ^R,math0)
$(call ^R,math1)
$(call ^R,math2)
`raw-add = $(if $(subst 0,,$(subst 1,,$(subst 9,,$(subst 9-0,,9$19$2)))),$(call `fp2u,$(call `fp-add,$(call `u2fp,$1),$(call `u2fp,$2))),$(call `u-add,$1,$2))
`raw-sub = $(if $(subst 1,,$(subst 0,,$1$2)),$(if $(subst 0,,$(subst 1,,$(subst 9,,$(subst 9-0,,9$19$2)))),$(call `fp2u,$(call `fp-add,$(call `u2fp,$1),$(subst !,-,$(subst $  -, +,$(subst $  +, !,$(call `u2fp,$2)))))),$(call `u-add,$1,$(subst --,,-$2))),$(call `u-sub-unsigned,$1,$2))
`raw-mul-s = $(if $(subst 0,,$(subst 1,,$(subst 9,,$(subst 9-0,,9$19$2)))),$(call `fp2u,$(call `fp-mul,$(call `u2fp,$1),$(call `u2fp,$2))),$(patsubst -0,0,$(filter -,$(findstring -,$1)$(findstring -,$2))0$(subst $  ,,$(wordlist 2,99999999,$(subst 01,0 1,$(subst $  ,,$(call `uf-mul,$(strip $(subst 0, 0,$(subst -,,$1))),$(strip $(subst 0, 0,$(subst -,,$2))))))))))
`raw-mul = $(if $(subst 1,,$(subst 0,,$1$2)),$(call `raw-mul-s,$1,$2),0$(subst $  ,,$(wordlist 2,99999999,$(subst 01,0 1,$(subst $  ,,$(call `uf-mul,$(strip $(subst 0, 0,$1)),$(strip $(subst 0, 0,$2))))))))
`raw-fdiv = $(if $(subst 1,,$(subst 0,,$1$2)),$(call `fp2u,$(call `fp-div,$(call `u2fp,$1),$(call `u2fp,$2),0,)),$(or $(call `u-fdiv,$1,$2,1),NaN))
`raw-mod = $(if $(subst 1,,$(subst 0,,$1$2)),$(call `fp2u,$(call `fp-mod,$(call `u2fp,$1),$(call `u2fp,$2))),$(or $(call `u-fdiv,$1,$2,4),NaN))
`raw-round = $(call `u2d,$(call `fp2u,$(call `fp-round,$(call `u2fp,$(call `d2u,$1)),$2,$3)))
`raw-cmp = $(if $(subst 1,,$(subst 0,,$1$2)),$(call `fp-cmp,$(call `u2fp,$1),$(call `u2fp,$2)),$(word 1,$(subst 0,,$(subst 1~,,$(subst 11~~,,$(subst 10~,,$(subst 111110~~~~~,0,$(join $(subst 0, 0,$(subst 1,,$2)$1),$(subst 0, 0,$(subst 1,,$1)$(subst 1,~,$2))))))))))
`math-cmp = $(call `raw-cmp,$(subst 3,0111,$(subst 6,3111,$(subst 8,611,$(subst 9,81,$(subst 7,61,$(subst 5,311,$(subst 4,31,$(subst 2,011,$(subst 1,01,$(or $1,?)))))))))),$(subst 3,0111,$(subst 6,3111,$(subst 8,611,$(subst 9,81,$(subst 7,61,$(subst 5,311,$(subst 4,31,$(subst 2,011,$(subst 1,01,$(or $2,?)))))))))))
`raw-pwr = $(if $(subst 1,,$(subst 0,,$2)),NaN,$(call `fp2u,$(call `fp-pwr,$(call `u2fp,$1),$2)))
`binop = $(subst 01,1,$(subst 011,2,$(subst 31,4,$(subst 311,5,$(subst 61,7,$(subst 81,9,$(subst 611,8,$(subst 3111,6,$(subst 0111,3,$(call `raw-$1,$(subst 3,0111,$(subst 6,3111,$(subst 8,611,$(subst 9,81,$(subst 7,61,$(subst 5,311,$(subst 4,31,$(subst 2,011,$(subst 1,01,$(or $2,?)))))))))),$(subst 3,0111,$(subst 6,3111,$(subst 8,611,$(subst 9,81,$(subst 7,61,$(subst 5,311,$(subst 4,31,$(subst 2,011,$(subst 1,01,$(or $3,?))))))))))))))))))))
`prec-op = $(subst 01,1,$(subst 011,2,$(subst 31,4,$(subst 311,5,$(subst 61,7,$(subst 81,9,$(subst 611,8,$(subst 3111,6,$(subst 0111,3,$(call `fp2u,$(call `fp-$1,$(call `u2fp,$(subst 3,0111,$(subst 6,3111,$(subst 8,611,$(subst 9,81,$(subst 7,61,$(subst 5,311,$(subst 4,31,$(subst 2,011,$(subst 1,01,$(or $2,?))))))))))),$(call `u2fp,$(subst 3,0111,$(subst 6,3111,$(subst 8,611,$(subst 9,81,$(subst 7,61,$(subst 5,311,$(subst 4,31,$(subst 2,011,$(subst 1,01,$(or $3,?))))))))))),$(call `prec-to-pod,$4),$5)))))))))))
`round = $(call `raw-round,$1,$(if $2,$(call `prec-to-pod,$2),0),$(or $(if $3,$(filter 9 3 1,$(subst |,1,$(subst +,3,$(subst -,9,$3))))),2))
`max = $(if $(findstring 1,$(call `math-cmp,$2,$1)),$2,$1)
`min = $(if $(findstring 1,$(call `math-cmp,$1,$2)),$2,$1)
`fp-sum = $(if $(word 2,$1),$(call `fp-add,$(call ^n,1,$1),$(call `fp-sum,$(wordlist 2,99999999,$1))),$(call ^n,1,$1))
`sum-vec = $(if $(findstring !,$1),$(if $(findstring !0,$(subst !1,!0,$1)),$(call `sum-vec,$(call ^u,$1))),$(call `u2d,$(call `fp2u,$(call `fp-sum,$(foreach ;,$(call `d2u,$1),$(call ^d,$(call `u2fp,$(call ^u,$;))))))))
`sum = $(call `sum-vec,$(call ^u,$(foreach N,1,$(^v))))
`frexp10 = $(call ^Y,$(subst ., ,$(filter-out %0,$(subst 0 ,0.,$(call `u2fp,$(call `d2u,$1))))),,,,,,,,,$`(if $`(word 3,$`1),$`(call `u2d,$`(findstring -,$`(word 2,$`1))0.$`(subst $`  ,,$`(wordlist 3,99999999,$`1)) $`(word 1,$`1)),$`(if $`1,0 0)))
`uv-trim = $(wordlist $(words $(subst 1,1 ,$(subst 0,,$1$21))),$(words $3),$(subst 1,1 ,$(subst 0,,$2)) $3)
`uv-range = $(if $(findstring 1,$(call `u-cmp,$1,$2)),,$(call `uv-trim,$(lastword $1),$(subst $(lastword $2),0,0111111111),$(if $(if $(word 2,$1),,1),0 1 2 3 4 5 6 7 8 9 )$(foreach ;,$(call `uv-range,$(or $(filter-out %x,$1x),01),$(filter-out %x,$2x)),$;0 $;1 $;2 $;3 $;4 $;5 $;6 $;7 $;8 $;9 )))
`uv-sign-range = $(if $3,$(addprefix -,$(call `reverse,$(call `uv-range,$(if $4,$2,1),$1))) )$(if $4,,$(call `uv-range,$(if $3,0,$1),$2))
`raw-range = $(filter %,$(if $(subst 0,,$(subst 1,,$(subst 9,,$(subst 9-0,,9$19$2)))),,$(call `uv-sign-range,$(or $(strip $(subst 0, 0,$(filter 01%,$(subst 01, 01,$(subst -,,$1))))),0),$(or $(strip $(subst 0, 0,$(filter 01%,$(subst 01, 01,$(subst -,,$2))))),0),$(findstring 1,$(filter -%,$1)),$(findstring 1,$(filter -%,$2)))))
`range = $(call `raw-range,$(call `d2u,$1),$(call `d2u,$2))
`format-fixed = $(foreach ;,$(if $3,$(call `d2u,$3),?),$(if $(subst 1,,$(subst 0,,$(if $3,$;)$(if $2,$(call `d2u,$2)))),$(if $(and $3,$(subst 1,,$(subst 0,,$;))),[invalid_DECIMALS],[invalid_MIN-WIDTH]),$(call `fp-fix,$(call `fp-round,$(call `u2fp,$(call `d2u,$1)),$(if $3,$;,0),2),$2,$3,$;)))
`lex-exp = $(if $(subst 0,,$(filter-out -%,$1)),$(patsubst 0111111111%,%,$(subst 9,0111111111,$(subst 90111111111,9909,$(subst 0,9,$(subst 1,,$1))$1))),$(subst 1~,,$(subst 11~~,,$(subst 111~~~,,$(subst 111111~~~~~~,,$(subst 0,0111111111,$(subst 1,~,$(subst 9,0111111111,$(subst 90111111111,9909,$(subst 0,9,$(subst 1,,$(subst -,,$1)))$(subst -,,$1))))))))))
`fp-lex = $(if $(findstring - 01,$(filter-out 0,.$1)),-$(subst 1~,,$(subst 11~~,,$(subst 111~~~,,$(subst 111111~~~~~~,,$(subst 0,0111111111,$(subst 1,~,$(call `fp-lex,$(subst !,-,$(subst $  -, +,$(subst $  +, !,$1)))))))))):,$(if $(findstring 1,$(wordlist 3,99999999,$1)),$(call `lex-exp,$(word 1,$1))$(wordlist 3,99999999,$1),0))
`num-lex = $(call `u2d,$(subst $  ,,$(call `fp-lex,$(call `u2fp,$(call `d2u,$1)))))
define `num-sort
$(filter-out %!#,$(subst !#,!# ,$(sort $(foreach ;,$1,$(call `num-lex,$(word 1,$(subst !, ,$;)))!#$;))))
endef
`log = $(call `u2d,$(call `fp2u,$(if $2,$(call `fp-log-x-b,$(call `u2fp,$(call `d2u,$1)),$(call `u2fp,$(call `d2u,$2)),$(call `prec-to-pod,$3)),$(call `fp-log,$(call `u2fp,$(call `d2u,$1)),$(call `prec-to-pod,$3)))))
`exp = $(call `u2d,$(call `fp2u,$(call `fp-exp,$(call `u2fp,$(call `d2u,$1)),$(call `prec-to-pod,$2))))
`pow = $(call `u2d,$(call `fp2u,$(call `fp-pow,$(call `u2fp,$(call `d2u,$1)),$(call `u2fp,$(call `d2u,$2)),$(call `prec-to-pod,$3))))
`get-pi = $(or $(foreach ;,$(call `prec-to-pod,$1),$(or $(patsubst 31%,3.1%,$(call `u2d,$(subst $  ,,$(subst ., ,$(filter-out %0,$(subst 0 ,0.,$(call `get-uf-const,`uf-pi,$(if $(filter 0% -0%,$;),$(call `u-zeros,$(call `u-add-ones,$;,1)),$(call `extend-fn,0,$;, 0 0 0 0))))))))),0)),NaN:P)
`atan2 = $(or $(foreach ;,$(call `prec-to-pod,$3),$(call `u2d,$(call `fp2u,$(call `fp-round,$(call `fp-atan2,$(call `u2fp,$(call `d2u,$1)),$(call `u2fp,$(call `d2u,$2)),$;),$(or $(`result-pod),$;),2)))),NaN:P)
`atan = $(call `atan2,$1,1,$2)

endef

define [mod-peg]
# Requires: core string
# Exports: peg-c}2 peg-+}1 peg-at}1 peg-?}1 peg-not}1 peg-*}1 peg-and}0+ peg-or}0+ peg-p}1'2'3 peg-empty}0'1 un-lex}1 gen-lex}1 lex}2
$(call ^R,core)
$(call ^R,string)
`spread-tokens = $(if $1,$(call `spread-tokens,$(wordlist 2,99999999,$1),$(subst $(word 1,$1), $(word 1,$1) ,$2)),$(filter %,$2))
`lex = $(call `spread-tokens,$2,$(call ^d,$1))
`gen-lex = $(call ^Y,$(call `gen-polysub,$(foreach ;,$1,$(call ^d,$;)),$(foreach ;,$1,$(call ^d, $; )),$`(call ^d,$`1)),,,,,,,,,$``(filter %,$``(call ^Y,$``1,,,,,,,,,$`(call ^E,$`1))))
`un-lex = $(call ^u,$(subst $  ,,$1))
`peg-empty = $`(call `append,$`2,$(call ^E,$1))
`peg-p = $(if $(and $2,$(findstring $(subst $10,1,%0),1)),$`(if $`(filter-out $(call ^E,$2),$`(word $`2,$`1)),$`(call `append,$`(call `1+,$`2),$(call ^E,$3))),$(if $2,$`(if $`(filter-out $(call ^E,$2),$`(filter $(call ^E,$1),$`(word $`2,$`1))),$`(call `append,$`(call `1+,$`2),$(call ^E,$3))),$`(if $`(filter $(call ^E,$1),$`(word $`2,$`1)),$`(call `append,$`(call `1+,$`2),$(call ^E,$3)))))
`match-or = $(if $3,$(or $(call ^Y,$1,$2,,,,,,,,$(call ^n,1,$3)),$(call `match-or,$1,$2,$(wordlist 2,99999999,$3))))
`peg-or-v = $`(call `match-or,$`1,$`2,$(call ^E,$1))
`peg-or = $(call `peg-or-v,$(foreach N,1,$(^v)))
`match-and = $(if $3,$(call ^Y,$(call ^Y,$1,$2,,,,,,,,$(call ^n,1,$3)),,,,,,,,,$`(if $`1,$`(call `match-and,$(call ^E,$1),$`(word 1,$`1),$`(wordlist 2,99999999,$(call ^E,$3)),$`(call `append,$(call ^E,$4),$`(wordlist 2,99999999,$`1))))),$(call `append,$2,$4))
`peg-and-v = $`(call `match-and,$`1,$`2,$(call ^E,$1),)
`peg-and = $(call `peg-and-v,$(foreach N,1,$(^v)))
`match* = $(call ^Y,$(call ^Y,$1,$2,,,,,,,,$3),,,,,,,,,$`(if $`1,$`(call `match*,$(call ^E,$1),$`(word 1,$`1),$(call ^E,$3),$`(call `append,$(call ^E,$4),$`(wordlist 2,99999999,$`1))),$`(call `append,$(call ^E,$2),$(call ^E,$4))))
`peg-* = $`(call `match*,$`1,$`2,$(call ^E,$1),)
`peg-not = $`(if $`(call ^Y,$`1,$`2,,,,,,,,$(call ^E,$1)),,$`(call `append,$`2,))
`peg-? = $(call `peg-or,$1,$(call `peg-empty))
`peg-at = $`(if $`(call ^Y,$`1,$`2,,,,,,,,$(call ^E,$1)),$`(call `append,$`2,))
`peg-+ = $(call `peg-and,$1,$(call `peg-*,$1))
`peg-c = $`(call ^Y,$`(call ^Y,$`1,$`2,,,,,,,,$(call ^E,$2)),,,,,,,,,$``(if $``1,$``(call `append,$``(word 1,$``1),$``(call `append,$``(wordlist 2,99999999,$``1),$``(call ^k,$(call ^E,$1,`))!=$``(call ^d,$``(wordlist $``(call `1+,$`(call ^E,$`2)),$``(word 1,$``1),. $`(call ^E,$`1)))))))

endef

define [mod-utf8]
# Requires: core math
# Exports: utf8-decode}1 utf8-encode}1
$(call ^R,core)
$(call ^R,math)
`utf-seq = $(if $2,$(call ^Y,$(call `binop,fdiv,$1,64),$(wordlist 2,99999999,$2),$(word 1,$2),,,,,,,$`(call `append,$`(call `utf-seq,$`1,$`2),$`(call `binop,add,$`3,$`(call `binop,sub,$(call ^E,$1),$`(call `binop,mul,$`1,64))))))
`utf8-encode = $(foreach ;,$1,$(if $(findstring 1,$(call `math-cmp,128,$;)),$;,$(if $(findstring 1,$(call `math-cmp,2048,$;)),$(call `utf-seq,$;,128 192),$(if $(findstring 1,$(call `math-cmp,65536,$;)),$(call `utf-seq,$;,128 128 224),$(if $(findstring 1,$(call `math-cmp,1114112,$;)),$(call `utf-seq,$;,128 128 128 240),?)))))
`plex2 = $(foreach ;,$1,$(foreach ;;,$1,$;$(;;)))
`byte-to-bin-a := $(wordlist 2,99999999,$(call `plex2,$(call `plex2,00 01 10 11)))
`byte-to-bin = $(if $(subst 0,,$1),$(word $1,$(`byte-to-bin-a)))
`b2d-loop = $(if $(word 2,$1),$(call `binop,add,$(lastword $1),$(call `binop,mul,2,$(call `b2d-loop,$(call `butlast,$1)))),$1)
`utf8-decode = $(foreach ;,$(subst b 10,,$(foreach ;,$1,$(or $(filter 1%,$(call `byte-to-bin,$;)b),$;))),$(if $(filter %b,$;),$(call `b2d-loop,$(subst 0,0 ,$(subst 1,1 ,$(or $(subst $  ,,$(wordlist 2,99999999,$(subst 0,0 ,$(subst b,,$;)))),0)))),$;))

endef

define [mod-gen0]
# Requires: core parse escape gen
# Exports: gen0}2 c0-lambda}3 c0-vec#2!0!]3!0;|0'1'.{^d|7'`c0'[]7[0^u[0[1]0[10;[10.'[]0[02[0. c0-block}2 c0}2 skip-flags}1 get-flags}1
$(call ^R,core)
$(call ^R,parse)
$(call ^R,escape)
$(call ^R,gen)
`scan-flags = $(or $(if $(filter !:P2,$(word 1,$(call ^n,$2,$1))),$(if $(filter &private &public &native,$(call ^n,3,$(call ^n,$2,$1))),$(call `scan-flags,$1,$(call `1+,$2),$2)),),$3)
`get-flags = $(filter %,$(foreach ;,$(wordlist 2,$(call `scan-flags,$1,2,1),$1),$(if $(filter !:P2,$(word 1,$(call ^u,$;))),$(call ^n,3,$(call ^u,$;)),)))
`skip-flags = $(wordlist $(call `1+,$(call `scan-flags,$1,2,1)),99999999,$1)
`get-arity = $(if $(filter ...% ?%,$(lastword $1)),$(if $(filter ...%,$(lastword $1)),$(words $(filter-out ...% ?%,$1))+,$(call `get-arity,$(call `butlast,$1)) $(words $1)),$(words $1))
`xlat = $(if $(filter !:IL4,$(word 1,$1)),$1,$(if $(filter !:IL6,$(word 1,$1)),!:IL6 $(word 2,$1) $(foreach ;,$(wordlist 3,99999999,$1),$(call ^d,$(call `xlat,$(call ^u,$;),$2,$3,$4,$5,$6,$7,$8))),$(if $(filter !:IL7,$(word 1,$1)),!:IL7 $(word 2,$1) $(foreach ;,$(wordlist 3,99999999,$1),$(call ^d,$(call `xlat,$(call ^u,$;),$2,$3,$4,$5,$6,$7,$8))),$(if $(filter !:IL0,$(word 1,$1)),$(if $(and $(filter $2,$(word 3,$1)),$6,$(filter-out ;%,$(word 2,$1))),$(call `xlat,$(if $(findstring +,$(word 2,$1)),$(call `il-vector,$(wordlist $(subst +,,$(word 2,$1)),99999999,$6)),$(call ^n,$(word 2,$1),$6)),.,$3,$5,$3,,$(word 3,$1),$8),$(if $(and $(filter $2,$(word 3,$1)),$(findstring $4;,$(word 2,$1))),!:IL0 $(patsubst $4%,%,$(word 2,$1)$5) $(word 3,$1),$(if $(findstring $2,$(word 3,$1)),!:IL0 $(word 2,$1) $(patsubst .%,%,$(word 3,$1)$7),$1))),$(if $(filter !:IL2,$(word 1,$1)),!:IL2 $(foreach ;,$(wordlist 2,99999999,$1),$(call ^d,$(call `xlat,$(call ^u,$;),$2,$3,$4,$5,$6,$7,$8))),$(if $(filter !:IL8,$(word 1,$1)),!:IL8 $(foreach ;,$(wordlist 2,99999999,$1),$(call ^d,$(call `xlat,$(call ^u,$;),$2,$3,$4,$5,$6,$7,$8))),$(if $(filter !:IL9,$(word 1,$1)),!:IL9 $(foreach ;,$(wordlist 2,99999999,$1),$(call ^d,$(call `xlat,$(call ^u,$;),$2,$3,$4,$5,$6,$7,$8))),$(if $(filter !:IL3,$(word 1,$1)),!:IL3 $(if $(filter .,$2),$(patsubst $4%,%,$(word 2,$1)$5),$(word 2,$1)) $(call ^d,$(call `xlat,$(call ^n,3,$1),$2,$3,$4,$5,$6,$7,$8)) $(call `xlat,$(wordlist 4,99999999,$1),$2,$3;,$4,$5,$6,$7,$8),$(if $(filter !:IL1,$(word 1,$1)),!:IL1 $(call ^d,$(call `xlat,$(call ^n,2,$1),.$2,,$4,$5,$6,$7,$8)),$(if $(filter !:IL10,$(word 1,$1)),$(if $(word 2,$1),!:IL10 $8,$1),$1))))))))))
`IWhere-sig := $(word 1,$(subst !,,!:IL10 ))
`translate = $(if $(or $4,$(if $(findstring $(subst $30,1,$20),1),,1),$(findstring $(`IWhere-sig),$1)),$(call `xlat,$1,.,$(subst .,,$3),$(subst .,,$2),$(subst .,,$3),$4,$(patsubst $(subst ;,,$2)%,%,$(subst ;,,$3).),$5),$1)
`c0-error = $(if $(filter !:P8,$(word 1,$1)),$1,$(call `gen-error,$1,$(if $(filter !:P6,$(word 1,$1)),unquote (,) outside of a quasiquoted (`) form,$(if $(filter !:P7,$(word 1,$1)),splice (,@) outside of a quasiquoted (`) form,bad AST node: %q)),$1))
`c0 = $(if $(filter !:P0,$(word 1,$1)),$(call `c0-L,$2,$(word 2,$1),$(call ^n,1,$(wordlist 3,99999999,$1)),$(wordlist 2,99999999,$(wordlist 3,99999999,$1)),$(call `resolve,$(call ^n,1,$(wordlist 3,99999999,$1)),$2)),$(if $(filter !:P1,$(word 1,$1)),!:IL4 $(call ^d,$(call ^n,3,$1)),$(if $(filter !:P2,$(word 1,$1)),$(call `c0-S,$2,$1,$(call ^n,3,$1),$(call `resolve,$1,$2)),$(if $(filter !:P3,$(word 1,$1)),$(call `c0-D,$2,$(word 2,$1),$(wordlist 3,99999999,$1)),$(if $(filter !:P9,$(word 1,$1)),$(call `il-vector,$(foreach ;,$(call ^n,3,$1),$(call ^d,$(call `c0,$(call ^u,$;),$2)))),$(if $(filter !:P4,$(word 1,$1)),!:IL4 $(call ^d,$(wordlist 3,99999999,$1)),$(if $(filter !:P5,$(word 1,$1)),$(call `c0-qq,$2,$(wordlist 3,99999999,$1)),$(call `c0-error,$1))))))))
`c0-macro = $(call `translate,!:IL1 $(call ^d,$2),$(patsubst .%,%,$1),$(call `current-depth,$3),,$(call `form-index,$4))
`c0-builtin = !:IL1 $(call ^d,$(if $(word 1,$(filter 3 2 1,$3)),!:IL6 $2 $(foreach ;,$(wordlist 1,$(word 1,$(filter 3 2 1,$3)),1 2 3),$(call ^d,!:IL0 $(call ^u,$;) .)),!:IL7 ^na $(call ^d,!:IL4 $(call ^d,$2)) $(call ^d,!:IL5 ^av)))
`c0-S-error = $(if $2,$(call `gen-error,$1,internal: %s binds to %q,$1,$2),$(call `gen-error,$1,undefined variable: `%s`,$(call `symbol-name,$1)))
`c0-S = $(if $(filter !:EDefn3,$(word 1,$4)),$(call `translate,$(wordlist 4,99999999,$4),$(word 3,$4),$(call `current-depth,$1),,$(call `form-index,$2)),$(if $(filter !:EDefn0,$(word 1,$4)),!:IL5 $(word 3,$4),$(if $(filter !:EDefn2,$(word 1,$4)),$(call `c0-macro,$(word 3,$4),$(wordlist 5,99999999,$4),$1,$2),$(if $(filter !:EDefn1,$(word 1,$4)),!:IL6 value $(call ^d,!:IL4 $(call ^d,$(word 3,$4))),$(if $(filter !:EDefn5,$(word 1,$4)),$(call `c0-ctor,$1,$2,$(call ^n,3,$4)),$(if $(filter !:EDefn6,$(word 1,$4)),$(call `c0-builtin,$1,$(word 3,$4),$(call ^n,4,$4)),$(call `c0-S-error,$2,$4)))))))
`c0-dict-key = $(foreach ;,$(call ^d,$(call `il-demote,$(call `c0,$1,$2))),$(if $(filter !1:IL7!0%,$;!0),$(if $(findstring $(subst ^d0,1,$(word 2,$(call ^u,$;))0),1),!:IL7 ^k $(wordlist 3,99999999,$(call ^u,$;)),!:IL7 $(word 2,$(call ^u,$;)) $(wordlist 3,99999999,$(call ^u,$;))),$(call `subst-in-il,%,!8,$(call ^u,$;))))
`c0-D = $(call `il-concat,$(call `intersperse,!:IL4 !0,$(foreach ;,$3,$(call ^d,$(call `il-concat,$(call ^d,$(foreach ;;,$(call ^d,$(call ^dk,$;)),$(if $(filter !1:P2!0%,$(;;)!0),$(if $(filter =%,$(call ^n,3,$(call ^u,$(;;)))),$(call `c0-dict-key,!:P2 $(word 2,$(call ^u,$(;;))) $(call ^d,$(patsubst =%,%,$(call ^n,3,$(call ^u,$(;;))))),$1),!:IL4 $(call ^d,$(call ^d,$(call ^n,3,$(call ^u,$(;;)))))),$(call `c0-dict-key,$(call ^dk,$;),$1)))) $(call ^d,!:IL4 !1=) $(call ^d,$(call `il-demote,$(call `c0,$(call ^dv,$;),$1))))))))
`c0-record = $(or $(call `check-arity,$(words $4),$3,$2),!:IL8 $(call `cons,!:IL4 $(call ^d,$5),$(foreach ;,$(call `indices,$4),$(call `append,$(call ^d,!:IL4 !0),$(call ^d,$(if $(filter S,$(word $;,$4)),$(call `il-demote,$(call `c0,$(call ^n,$;,$3),$1)),$(call `c0,$(call ^n,$;,$3),$1)))))))
`c0-block-cc = $(if $(filter !:IL12,$(word 1,$5)),$(call `c0-block-cc,$(call `append,$(call ^n,2,$5),$1),$2,$3,$4,$(wordlist 3,99999999,$5)),$(if $2,$(call `c0-block-cc,$1,$(wordlist 2,99999999,$2),$3,$4 $(call ^d,$5),$(call `c0,$(call ^n,1,$2),$1)),$(call ^Y,$1,$(filter-out !.,$4 $(call ^d,$5)),,,,,,,,$3)))
`c0-block = $(call `c0-block-cc,$2,$1,$`(if $`(word 2,$`2),!:IL9 $`2,$`(call ^n,1,$`2)))
`c0-L = $(if $(filter !:EDefn1,$(word 1,$5)),$(or $(call `check-arity,$(call ^n,4,$5),$4,$3),!:IL7 $(word 3,$5) $(foreach ;,$4,$(call ^d,$(call `c0,$(call ^u,$;),$1)))),$(if $(filter !:EDefn2,$(word 1,$5)),$(or $(call `check-arity,$(call ^n,4,$5),$4,$3),$(call `translate,$(wordlist 5,99999999,$5),$(word 3,$5),$(call `current-depth,$1),$(or $(foreach ;,$4,$(call ^d,$(call `c0,$(call ^u,$;),$1))),$(call ^d,!:IL4 !.)),$(call `form-index,$3))),$(if $(filter !:EDefn6,$(word 1,$5)),$(or $(call `check-arity,$(call ^n,4,$5),$4,$3),!:IL6 $(word 3,$5) $(foreach ;,$4,$(call ^d,$(call `c0,$(call ^u,$;),$1)))),$(if $(filter !:EDefn4,$(word 1,$5)),$(if $(findstring $(subst x0,1,$(word 2,$5)0),1),$(call `gen-error,$3,cannot use xmacro in its own file),$(call `c0,$(call $(word 3,$5),$4,$2),$1)),$(if $(filter !:EDefn5,$(word 1,$5)),$(call `c0-record,$1,$3,$4,$(call ^n,3,$5),$(call ^n,4,$5)),$(if $(if $3,,1),$(call `gen-error,$2,missing function/macro name),$(if $5,!:IL2 $(foreach ;,$(call `cons,$3,$4),$(call ^d,$(call `c0,$(call ^u,$;),$1))),$(if $(if $(filter-out u%,$(flavor `M.$(call `symbol-name,$3))),1),$(call `M.$(call `symbol-name,$3),$1,$3,$4),$(call `gen-error,$3,undefined symbol: `%s`,$(call `symbol-name,$3))))))))))
`bind-params = $(if $2,$(or $(foreach ;,$(lastword $2),$(if $(filter !1:P2!0%,$;!0),$(foreach ;;,$(filter $(if $3,?%,...% ?%),$(call ^n,3,$(call ^u,$;))),$(call `append,$(call `bind-params,$1,$(call `butlast,$2),1),$(call ^k,$(or $(patsubst $(if $(filter ?%,$(;;)),?%,...%),%,$(;;)),$(;;)))!=$(call ^d,!:EDefn3 p $1 !:IL0 $(words $2)$(if $(filter ...%,$(;;)),+) .))),)),$(foreach ;,$(call `indices,$2),$(call `bind-target,$(call ^n,$;,$2),p,$1,!:IL0 $; .))))
`c0-lambda = $(foreach ;,$(subst ;,,.$(call `current-depth,$1)),$(call ^Y,$(call `bind-params,$;,$2),$1,$3,,,,,,,$`(or $`(call `dict-get,;,$`1),!:IL1 $`(call ^d,$`(call `c0-block,$`3,$`(call `append,:!=$`(call ^d,!:EDefn7 $(call ^E,$;)),$`1,$`2))))))
`M.lambda = $(if $(filter !:P0,$(word 1,$(call ^n,1,$3))),$(call `c0-lambda,$1,$(wordlist 3,99999999,$(call ^n,1,$3)),$(wordlist 2,99999999,$3)),$(call `err-expected,L,$(call ^n,1,$3),$2,(ARGNAME...),(lambda (ARGNAME...) BODY)))
`c0-check-body = $(if $3,$(if $(if $2,,1),$(call `gen-error,$1,no BODY supplied to (define TARGET BODY))),$(if $2,$(call `gen-error,$2,too many arguments to (declare ...))))
`il-errors = $(if $(filter !:P8,$(word 1,$1)),$(call ^d,$1),$(if $(filter !:IL6 !:IL7,$(word 1,$1)),$(filter %,$(foreach ;,$(wordlist 3,99999999,$1),$(call `il-errors,$(call ^u,$;)))),$(if $(filter !:IL3,$(word 1,$1)),$(call `append,$(call `il-errors,$(call ^n,3,$1)),$(call `il-errors,$(wordlist 4,99999999,$1))),$(if $(filter !:IL2 !:IL8 !:IL9,$(word 1,$1)),$(filter %,$(foreach ;,$(wordlist 2,99999999,$1),$(call `il-errors,$(call ^u,$;)))),$(if $(filter !:IL1,$(word 1,$1)),$(call `il-errors,$(call ^n,2,$1)),)))))
`il-error-node = $(if $(findstring $(subst !,,$(word 1,!:P8  !.)),$1),$(call ^Y,$(call `il-errors,$1),,,,,,,,,$`(if $`(word 2,$`1),!:IL9 $`1,$`(call ^n,1,$`1))))
`assign-nx = $(if $(filter !:NX0,$(word 1,$1)),!:IL7 ^set $(call ^d,!:IL4 $(call ^d,$(call `gen-native-name,$(call ^n,2,$1),$2))) $(call ^d,$(call ^Y,$3,,,,,,,,,$(call ^n,3,$1))),)
`c0-def-target-2 = $(or $(call `first-perror,$2),$(call `il-error-node,$4),$(if $6,!:IL12 $(call ^d,$(call `bind-nxmap,$2,$7,$(call `current-depth,$1),$4)) ,!:IL12 $(call ^d,$(filter %,$(foreach ;,$2,$(if $(filter !:NX0,$(word 1,$(call ^u,$;))),$(call ^k,$(call ^n,2,$(call ^u,$;)))!=$(call ^d,!:EDefn0 $7 $(call `gen-native-name,$(call ^n,2,$(call ^u,$;)),$3)),)))) $(if $5,$(if $(word 2,$2),!:IL2 $(call ^d,!:IL1 $(call ^d,!:IL9 $(foreach ;,$2,$(call ^d,$(call `assign-nx,$(call ^u,$;),$3,!:IL0 1 .))))) $(call ^d,$4),$(call `assign-nx,$(call ^n,1,$2),$3,$4)))))
`c0-def-target = $(or $(call `c0-check-body,$(call `form-index,$2),$(call ^n,1,$4),$5),$(call `c0-def-target-2,$1,$(call `parse-target,$2),$3,$(call `c0-block,$4,$1),$5,$6,$(if $(filter &public,$3),x,p)))
`c0-def-compound = $(or $(call `c0-check-body,$2,$(call ^n,1,$6),$7),$(call ^Y,$(call `c0-lambda,$(if $8,$1,$(call `append,$(call ^k,$3)!=$(call ^d,!:EDefn1 $(if $(filter &public,$5),x,p) $(call `gen-native-name,$3,$5) $(call ^d,$(call `get-arity,$(foreach ;,$4,$(call ^d,$(call `symbol-name,$(call ^u,$;))))))),$1)),$4,$6),$(subst ;,,.$(call `current-depth,$1)),$7,$8,$(call `get-arity,$(foreach ;,$4,$(call ^d,$(call `symbol-name,$(call ^u,$;))))),$(if $(filter &public,$5),x,p),$3,$(call `gen-native-name,$3,$5),,$`(or $`(call `il-error-node,$`1),!:IL12 $`(call ^d,$`(call ^k,$`7)!=$`(call ^d,$`(if $`4,!:EDefn2 $`6 $`2 $`(call ^d,$`5) $`(if $`(filter !:IL1,$`(word 1,$`1)),$`(call ^n,2,$`1),),!:EDefn1 $`6 $`8 $`(call ^d,$`5)))) $`(and $`3,$`(if $`4,,1),!:IL7 ^fset $`(call ^d,!:IL4 $`(call ^d,$`8)) $`(call ^d,$`1)))))
`c0-def2 = $(or $(if $(if $7,,1),$(if $(filter !:P5,$(word 1,$3)),$(call `c0-def2,$1,$(word 2,$3),$(wordlist 3,99999999,$3),$4,$5,$6,1),)),$(if $(filter !:P0,$(word 1,$3)),$(foreach ;,$(call ^d,$(call ^n,1,$(wordlist 3,99999999,$3))),$(if $(filter !1:P2!0%,$;!0),$(call `c0-def-compound,$1,$(word 2,$3),$(call ^n,3,$(call ^u,$;)),$(wordlist 2,99999999,$(wordlist 3,99999999,$3)),$4,$5,$6,$7),$(call `err-expected,S,$(call ^u,$;),$3,NAME,(%s %s(NAME...)),$(if $6,define,declare),$(if $7,`)))),$(if $3,$(call `c0-def-target,$1,$3,$4,$5,$6,$7),$(call `err-expected,L P,$3,$2,FORM,(%s %sFORM ...),$(if $6,define,declare),$(if $7,`)))))
`M.define = $(call `c0-def2,$1,$(call `form-index,$2),$(call ^n,1,$3),$(call `get-flags,$3),$(call `skip-flags,$3),1,)
`M.declare = $(call `c0-def2,$1,$(call `form-index,$2),$(call ^n,1,$3),$(call `get-flags,$3),$(call `skip-flags,$3),,)
`c0-ctor = $(call `c0-lambda,$1,$(foreach ;,$(call `indices,$3),$(call ^d,!:P2 0 $(call ^d,a$(call ^u,$;)))),$(call ^d,!:P0 0 $(call `cons,$2,$(foreach ;,$(call `indices,$3),$(call ^d,!:P2 0 $(call ^d,a$(call ^u,$;)))))))
`M.begin = $(call `c0-block,$3,$1)
`c0-qq-form = $(if $(findstring *!*,$1),$(call `il-concat,$(call `intersperse,$2,$(foreach ;,$(call `split,*!*,$1),$(call ^d,!:IL4 $;)))),$(if $(findstring *!1*,$1),$(call `il-concat,$(call `intersperse,$(call `il-demote,$2),$(foreach ;,$(call `split,*!1*,$1),$(call ^d,!:IL4 $;)))),!:P8 0 $(call ^d,c0-qq-form: template='$1')))
`c0-qq = $(if $(filter !:P6,$(word 1,$2)),$(if $3,$(call `c0-qq-form,!:P6 $(word 2,$2) *!*,$(call `c0-qq,$1,$(wordlist 3,99999999,$2),$(wordlist 2,99999999,$3))),$(call `c0,$(wordlist 3,99999999,$2),$1)),$(if $(filter !:P5,$(word 1,$2)),$(call `c0-qq-form,!:P5 $(word 2,$2) *!*,$(call `c0-qq,$1,$(wordlist 3,99999999,$2),$(call `cons,1,$3))),$(if $(filter !:P0,$(word 1,$2)),$(call `c0-qq-form,!:P0 $(word 2,$2) *!*,$(call `il-concat,$(call `intersperse,!:IL4 !0,$(foreach ;,$(wordlist 3,99999999,$2),$(call ^d,$(if $(filter !:P7,$(word 1,$(call ^u,$;))),$(call `c0,$(wordlist 3,99999999,$(call ^u,$;)),$1),$(call `il-demote,$(call `c0-qq,$1,$(call ^u,$;),$3)))))))),$(if $(filter !:P8,$(word 1,$2)),$2,!:IL4 $(call ^d,$2)))))
`gen0 = $(call `c0-block-cc,$2,$1,$`(call `cons,$`1,$`2))

endef

define [mod-gen1]
# Requires: core escape parse gen
# Exports: gen1}2
$(call ^R,core)
$(call ^R,escape)
$(call ^R,parse)
$(call ^R,gen)
`c1-Where = $(subst $`,$``,$(`*compile-file*)$(if $1,:$(call `get-subject-line,$1,$(`*compile-subject*))))
`c1-Lambda = $(subst $``.,$`.,$(subst $``-,$`,$(subst $`,$``,$1)))
define `crumb
$`.{$(subst 
,~N,$(subst $`,~S,$(subst $],~R,$(subst $(if ,,,),~C,$(subst $[,~L,$(subst ~,~1,$(call ^k,$1)!=$(call ^d,$2)))))))$`.}
endef
`c1-arg = $(if $(if $(filter !:IL7 !:IL5 !:IL6 !:IL3 !:IL2 !:IL0,$(word 1,$1)),1,),$(call `c1,$1),$(call `protect-arg,$(call `c1,$1)))
`c1-arg-trim = $(if $(if $(filter !:IL7 !:IL5 !:IL6 !:IL3 !:IL2 !:IL0,$(word 1,$1)),1,),$(call `c1,$1),$(call `protect-trim,$(call `protect-arg,$(call `c1,$1))))
`c1-vec = $(subst ~x,,$(subst ~x~x ,$(subst ~,~~x,$2),$(foreach ;,$1,$(subst ~,~~x,$(call $3,$(call ^u,$;)))~x~x)))
`c1-Error = $(call `crumb,errors,$(if $(filter !:P8,$(word 1,$1)),$1,!:P8 0 $(call ^d,internal:bad IL: $1)))
`c1-Builtin = $`($(if $(filter-out =,$1),$1 )$(call `protect-ltrim,$(call `c1-vec,$2,$(if ,,,),$(if $(filter and or,$1),`c1-arg-trim,`c1-arg))))
`c1-args9 = $(if $(word 9,$1),$(if ,,$(call `c1-vec,$(wordlist 1,8,$1),$(if ,,,),`c1-arg),$(call `protect-arg,$(call `c1,$(call `il-vector,$(wordlist 9,99999999,$1))))),$(call `c1-vec,$1,$(if ,,,),`c1-arg))
`c1-Call = $`(call $(call `protect-ltrim,$(subst $`,$``,$1))$(if $2,$(if ,,,))$(call `c1-args9,$2))
`i-8 = $(words $(wordlist 9,99999999,$(call `repeat-words,. . . .,$1)))
`c1-ugly-arg = $(subst $`,$`$(subst .,-,$(subst <.,,<$2)),$(subst %,$(if $(filter $1,1 2 3 4 5 6 7 8 ;),$`$1,$(if $(filter ;%,$1),$`($1),$(if $(findstring +,$1),$(if $(filter $1,1+ 2+ 3+ 4+ 5+ 6+ 7+ 8+),$`(foreach N,$(subst +,,$1),$`(^v)),$(if $(filter 9+,$1),$`9,$`(wordlist $(call `i-8,$(subst +,,$1)),99999999,$`9))),$`(call ^n,$(call `i-8,$1),$`9)))),$(if $(filter .,$2),%,$`(call ^E,%$(filter %`,$(if ,,,$(subst .,`,$(subst <..,,<$2))))))))
`c1-Funcall = $`(call ^Y,$(call `c1-args9,$(wordlist 2,99999999,$1))$(subst $  ,,$(or $(wordlist $(words x$(wordlist 2,99999999,$1)),9,$(if ,,, , , , , , , , ,)),$(if ,,,)))$(call `protect-arg,$(call `c1,$(call ^n,1,$1))))
`c1-Block = $(if $(word 2,$1),$`(and $(call `c1-vec,$1,$(if ,,1,),`c1-arg)),$(if $1,$(call `c1,$(call ^n,1,$1))))
`c1-Var = $`$(or $(filter a b c d e f g h i j k l m n o p q r s t u v w x y z A B C D E F G H I J K L M N O P Q R S T U V W X Y Z _,$1),($(subst $`,$``,$1)))
`c1 = $(if $(filter !:IL4,$(word 1,$1)),$(subst $`,$``,$(call ^n,2,$1)),$(if $(filter !:IL0,$(word 1,$1)),$(or $(if $(filter .,$(word 3,$1)),$(addprefix $`,$(filter $(word 2,$1),1 2 3 4 5 6 7 8 ;))),$(call `c1-ugly-arg,$(word 2,$1),$(word 3,$1))),$(if $(filter !:IL7,$(word 1,$1)),$(call `c1-Call,$(word 2,$1),$(wordlist 3,99999999,$1)),$(if $(filter !:IL5,$(word 1,$1)),$(call `c1-Var,$(word 2,$1)),$(if $(filter !:IL8,$(word 1,$1)),$(call `c1-vec,$(wordlist 2,99999999,$1),,`c1),$(if $(filter !:IL1,$(word 1,$1)),$(call `c1-Lambda,$(call `c1,$(call ^n,2,$1))),$(if $(filter !:IL9,$(word 1,$1)),$(call `c1-Block,$(wordlist 2,99999999,$1)),$(if $(filter !:IL2,$(word 1,$1)),$(call `c1-Funcall,$(wordlist 2,99999999,$1)),$(if $(filter !:IL6,$(word 1,$1)),$(call `c1-Builtin,$(word 2,$1),$(wordlist 3,99999999,$1)),$(if $(filter !:IL3,$(word 1,$1)),$(call `c1-Builtin,foreach,$(call ^d,!:IL4 $(call ^d,$(word 2,$1))) $(call ^d,$(call ^n,3,$1)) $(call ^d,$(wordlist 4,99999999,$1))),$(if $(filter !:IL10,$(word 1,$1)),$(call `c1-Where,$(word 2,$1)),$(if $(filter !:IL11,$(word 1,$1)),$(call `crumb,$(word 2,$1),$(call ^n,3,$1)),$(if $(filter !:IL12,$(word 1,$1)),$(call `c1,$(wordlist 3,99999999,$1)),$(if $1,$(call `c1-Error,$1)))))))))))))))
define `c1-file-set
$(if $3,$(call `protect-lhs,$1) := $(call `protect-rhs,$2)
,$(if $(or $(findstring $`,$(subst $``,,$2)),$(findstring $``.,$2)),$(call `protect-expr,$`(call ^fset,$(call `protect-arg,$1),$(call `protect-arg,$2)))
,$(if $(or $(findstring #,$2),$(findstring 
,$2),$(filter ~%,$(subst $  ,~,$(subst $ 	,~,$2)))),define $(call `protect-lhs,$1)
$(call `protect-define,$(subst $``,$`,$2))
$ endef
,$(call `protect-lhs,$1) = $(subst $``,$`,$(call `protect-rhs,$2))
)))
endef
define `c1-file
$(or $(if $(filter !:IL6,$(word 1,$1)),$(foreach ;,$(call ^d,$(call ^n,1,$(wordlist 3,99999999,$1))),$(if $(filter !1:IL4!0%,$;!0),$(if $(filter eval,$(word 2,$1)),$(call ^n,2,$(call ^u,$;))
,$(if $(filter call,$(word 2,$1)),$(call `c1-file,!:IL7 $(call ^n,2,$(call ^u,$;)) $(wordlist 2,99999999,$(wordlist 3,99999999,$1))))),)),$(if $(filter !:IL7,$(word 1,$1)),$(if $(filter ^set:2 ^fset:2,$(word 2,$1):$(words $(wordlist 3,99999999,$1))),$(call `c1-file-set,$(call `c1,$(call ^n,1,$(wordlist 3,99999999,$1))),$(call `c1,$(call ^n,2,$(wordlist 3,99999999,$1))),$(filter ^set,$(word 2,$1)))),$(if $(filter !:IL9,$(word 1,$1)),$(subst ~x,,$(subst ~x~x ,,$(foreach ;,$(wordlist 2,99999999,$1),$(subst ~,~~x,$(call `c1-file,$(call ^u,$;)))~x~x))),))),$(if ,,$(call `protect-expr,$(call `c1,$(if $(if $(filter !:IL6 !:IL7,$(word 1,$1)),$(filter error eval info ^R ^at,$(word 2,$1)),$(if $(filter !:IL11,$(word 1,$1)),1,)),$1,!:IL6 if $(call ^d,$1) $(call ^d,!:IL4 !.))))
))
endef
define `gen1
$(call ^Y,$(subst $`.}, ,$(subst $`.{, $`.{,$(call ^d,$(if $2,$(subst ~x,,$(subst ~x~x ,,$(foreach ;,$1,$(subst ~,~~x,$(call `c1-file,$(call ^u,$;)))~x~x))),$(call `c1,!:IL9 $1))))),,,,,,,,,$`(call `append,code!=$`(call ^d,$`(call `concat-vec,$`(filter-out $``.{%,$`1))),$`(call `dict-collate,$`(foreach ;,$`(call `filtersub,$``.{%,%,$`1),$`(subst ~1,~,$`(subst ~L,$`[,$`(subst ~C,$`(if ,,,),$`(subst ~R,$`],$`(subst ~S,$``,$`(subst ~N,
,$`(call ^u,$`;)))))))))))
endef

endef

define [mod-memo]
# Requires: core io string
# Exports: memo-chmod-file}2 memo-write-file}2 memo-read-file}1 memo-hash-file}1 memo-on#2{`memo-minus|6'if'[]5[0`*memo-on*'[]4[0[1.'[]9[0[1]7[10`memo-start-session[10[11]0[1101[110.[0[1]4[101|0'2'. memo-blob-call}1+ memo-call}1+ memo-apply}2 memo-io}1+ memo-drop}0
$(call ^R,core)
$(call ^R,io)
$(call ^R,string)
`*memo-on* := 
`*memo-cache* := 
`*memo-db* := 
`*memo-db-file* := 
`*memo-db-disk* := 
`*memo-key* := 
`*memo-tag* := 
`*memo-log* := 
`*memo-hashes* := 
`*memo-dir* := 
`memo-dir = $(and $(if $(if $(findstring $(subst $(call ^u,$(dir $(call ^d,$(`*memo-db-file*))))0,1,$(`*memo-dir*)0),1),,1),$(and $(call ^set,`*memo-dir*,$(call ^u,$(dir $(call ^d,$(`*memo-db-file*)))))1,$(call `mkdir-p,$(`*memo-dir*))))1,$(`*memo-dir*))
$(call ^at,!1:PMDB0!=Result!0S !1:PMDB1!=IO!0S!0S!0L)
`memo-playback = $(call ^Y,$(call `dict-get,$1,$(`*memo-cache*) $(`*memo-db*)),,,,,,,,,$`(if $`(filter !:PMDB0,$`(word 1,$`1)),$`1,$`(if $`(filter !:PMDB1,$`(word 1,$`1)),$`(call `memo-playback,$`(call ^d,$`(call ^n,2,$`1)) $`(call ^d,$`(if $`(filter :%,$`(call ^n,3,$`1)),$`(call `memo-do-apply,$`(patsubst :%,%,$`(call ^n,3,$`1)),$`(wordlist 4,99999999,$`1)),$`(call ^na,$`(call ^n,3,$`1),$`(wordlist 4,99999999,$`1))))),)))
`memo-add-entry = $(call ^set,`*memo-log*,$(call `append,$(`*memo-log*),$(call ^k,$(`*memo-key*))!=$(call ^d,$1)))
`memo-record = $(call ^set,`*memo-key*,$(call ^set,`*memo-key*,$1,$(`*memo-key*)),$(call ^set,`*memo-log*,$(call ^set,`*memo-log*,,$(`*memo-log*)),$(call ^Y,$(call ^na,$2,$3),$1,,,,,,,,$`(and $`(if $`(`*memo-key*),$`(and $`(call `memo-add-entry,!:PMDB0 $`(call ^d,$`1))1,$`(call ^set,`*memo-db*,$`(call `append,$`(`*memo-db*),$`(`*memo-log*)))))1,$`1))))
`memo-drop = $(and $(call ^set,`*memo-key*,)1,$(call `memo-save-session))
`get-io-tag = $(if $1,$(if $(filter !:PMDB1,$(word 1,$1)),$(call ^n,2,$1),))
`memo-log-io = $(and $(if $(`*memo-key*),$(call ^set,`*memo-key*,$(call ^d,$(or $(call `get-io-tag,$(call `dict-get,$(`*memo-key*),$(`*memo-db*)),$1,$2),$(and $(call `memo-add-entry,!:PMDB1 $(call ^d,$(`*memo-tag*)) $(call ^d,$1) $2)1,$(call ^set,`*memo-tag*,$(call `1+,$(`*memo-tag*)),$(`*memo-tag*))))) $(call ^d,$3)))1,$3)
`memo-io = $(call `memo-log-io,$1,$(foreach N,2,$(^v)),$(call ^na,$1,$(foreach N,2,$(^v))))
`memo-do-apply = $(call ^Y,$(call `dict-find,$1 $2,$(`*memo-cache*)),$1,$2,,,,,,,$`(if $`1,$`(call ^dv,$`1),$`(call ^Y,$`(foreach ;,$`(call ^d,$`(call `memo-playback,$`2 $`3)),$`(if $`(filter !1:PMDB0!0%,$`;!0),$`(call ^n,2,$`(call ^u,$`;)),$`(call `memo-record,$`2 $`3,$`2,$`3))),$`2 $`3,,,,,,,,$``(and $``(call ^set,`*memo-cache*,$``(call `append,$``(call ^k,$``2)!=$``(call ^d,$``1),$``(`*memo-cache*)))1,$``1))))
`memo-apply = $(call `memo-log-io,:$1,$2,$(call `memo-do-apply,$1,$2))
`memo-call = $(call `memo-apply,$1,$(foreach N,2,$(^v)))
`blobify = $(call `save-blob,$(call `memo-dir),$(call ^na,$1,$(foreach N,2,$(^v))))
`read-blob = $(call `read-file,$1)
$(if $(call `memoize,`read-blob),)
`memo-blob-call = $(if $(`*memo-on*),$(call `read-blob,$(call `memo-apply,`blobify,$(call `cons,$1,$(foreach N,2,$(^v))))),$(call ^na,$1,$(foreach N,2,$(^v))))
define `memo-save-session
$(if $(if $(findstring $(subst $(`*memo-db-disk*)0,1,$(`*memo-db*)0),1),,1),$(and $(call `memo-dir)1,$(call `expect-x,,$(call `write-file-atomic,$(`*memo-db-file*),$(`*memo-tag*)
$(subst !0, ,$(subst $  ,
,$(subst 
,!n,$(`*memo-db*))))
),memo.scm:284)1,$(call ^set,`*memo-db-disk*,$(`*memo-db*))))
endef
define `memo-start-session
$(and $(call ^set,`*memo-on*,1)1,$(if $(if $(findstring $(subst $10,1,$(`*memo-db-file*)0),1),,1),$(and $(call ^set,`*memo-db-file*,$1)1,$(call ^set,`*memo-db*,$(filter %,$(subst !n,
,$(subst 
, ,$(subst $  ,!0,$(call `read-file,$1))))))1,$(call ^set,`*memo-tag*,$(or $(word 1,$(`*memo-db*)),0))1,$(call ^set,`*memo-db*,$(wordlist 2,99999999,$(`*memo-db*)))1,$(call ^set,`*memo-db-disk*,$(`*memo-db*)))))
endef
`memo-minus = $(and $(if $1,$(and $(call ^set,`*memo-on*,)1,$(call ^set,`*memo-cache*,)1,$(call ^set,`*memo-hashes*,)1,$(call `memo-save-session)))1,$2)
`hash-add = $(call ^set,`*memo-hashes*,$(call `append,$(`*memo-hashes*),$1))
`do-hash-file = $(if $(`*memo-on*),$(call ^dv,$(or $(call `dict-find,$1,$(`*memo-hashes*)),$(and $(call `hash-add,$(call `hash-files,$(sort $(call `cons,$1,$(if $(`*memo-hashes*),,$(foreach ;,$(`*memo-db*),$(foreach ;;,$(call ^d,$(call ^dv,$;)),$(if $(filter !1:PMDB1!0%,$(;;)!0),$(if $(filter $(call ^n,3,$(call ^u,$(;;))),`do-hash-file `do-write-blob),$(word 1,$(wordlist 4,99999999,$(call ^u,$(;;))))),))))))))1,$(call `dict-find,$1,$(`*memo-hashes*))))),$(call `hash-file,$1))
`memo-hash-file = $(call `memo-io,`do-hash-file,$1)
`memo-read-file = $(and $(call `memo-hash-file,$1)1,$(call `read-file,$1))
`do-write-blob = $(if $(if $(findstring $(subst $(call `dict-get,$1,$(`*memo-hashes*))0,1,$(call ^u,$(notdir $(call ^d,$2)))0),1),,1),$(and $(call ^set,`*memo-hashes*,$(call `dict-remove,$1,$(`*memo-hashes*)))1,$(call `cp-file-atomic,$2,$1,1)))
`memo-write-file = $(if $(`*memo-on*),$(call ^Y,$(call `save-blob,$(call `memo-dir),$2),,,,,,,,,$`(call `memo-io,`do-write-blob,$(call ^E,$1),$`1)),$(call `write-file,$1,$2))
`memo-chmod-file = $(call `memo-io,`chmod-file,$1,$2)

endef

define [mod-escape]
# Requires: core
# Exports: protect-define}1 protect-rhs}1 protect-lhs}1 protect-expr}1 protect-arg}1 protect-trim}1 protect-ltrim}1 escape#1!0!]6!0subst|4'$|4'$`|0'1'.
$(call ^R,core)
define `protect-hash2
$(if $(findstring \.#,$1),$(call `protect-hash2,$(subst \.#,.#\\,$1)),$(subst .#,,$1))
endef
define `quote-hash
$(if $(findstring #,$1),$(call `protect-hash2,$(subst #,.#\#,$1)),$1)
endef
`protect-ltrim = $(if $(findstring $(word 1,0$10),0),$` )$1
define `protect-trim
$(if $(and $(findstring $1,$(wordlist 1,99999999,$1)),$(filter-out 
%,$(word 1,$1)),$(filter-out %
,$(lastword $1))),$1,$(if $1,$`(if ,,$1)))
endef
`balance2 = $(call ^u,$(if $(findstring !C,$1),$`(if ,,$(subst !C,,$1)),$1))
`balance-match-r = $(if $1,$(call `balance-match-r,$(word 1,$2),$(wordlist 2,99999999,$2),$(if $(filter !L%,$1),$3 $1,$(if $(and $(filter !R,$1),$(word 2,$3)),$(filter-out %!,$3!)($(subst !L,,$(subst !C,,$(lastword $3)))),$3$1))),$3)
`balance-match = $(call `balance-match-r,$(word 1,$1),$(wordlist 2,99999999,$1),!.)
`check-balance-r = $(if $(word 2,$1),$(call `check-balance-r,$(subst $  ,,$(filter-out !L%!R,$(subst !L, !L,$(word 1,$1))))$(wordlist 2,99999999,$1)),$1)
`check-balance = $(call `check-balance-r,$(subst $],!R .,$(subst $[,!L,$(subst !,,$(subst $ 	,,$(subst $  ,,$1))))))
`make-balanced = $(if $(findstring !,$2),$(call `balance2,$(subst !L,$`[,$(subst !R,$`],$(subst $  ,,$(call `balance-match,$(subst $[, !L,$(subst $], !R ,$(subst $(if ,,,),$(if ,,!C,),$(call ^d,$1))))))))),$(if $(findstring $(if ,,,),$2),$`(if ,,$1),$1))
`protect-arg = $(if $(or $(findstring $[,$1),$(findstring $],$1),$(findstring $(if ,,,),$1)),$(call `make-balanced,$1,$(call `check-balance,$1)),$1)
define `protect-expr
$(subst 
,$`',$1)
endef
define `protect-lhs
$(subst #,$`",$(subst X,$(subst 
,$`',$(call `protect-arg,$1)),$(if $(or $(findstring :,$1),$(findstring =,$1),$(if $(findstring $1,$(wordlist 1,99999999,$1)),,1),$(filter ifeq ifneq ifdef ifndef else endif define endef override include sinclude -include export unexport private undefine vpath,$1)),$`(if ,,X),X)))
endef
define `protect-rhs
$(call `quote-hash,$(call `protect-ltrim,$(subst 
,$`',$1)))
endef
define `protect-define
$(if $(or $(findstring define,$1),$(findstring endef,$1),$(findstring \,$1)),$(subst ~x,,$(subst ~x~x ,
,$(foreach ;,$(call `split,
,$1),$(subst ~,~~x,$(if $(filter define endef,$(word 1,$(call ^u,$;))),$` )$(call ^u,$;)$(if $(filter %\,$(call ^d,$(call ^u,$;))),$` ))~x~x))),$1)
endef

endef

define [mod-macros]
# Requires: core parse gen gen0
# Exports: 
$(call ^R,core)
$(call ^R,parse)
$(call ^R,gen)
$(call ^R,gen0)
`M.when = $(or $(call `check-arity,2+,$3,$2),!:IL6 if $(call ^d,$(call `c0,$(call ^n,1,$3),$1)) $(call ^d,$(call `c0-block,$(wordlist 2,99999999,$3),$1)))
`M.print = !:IL6 info $(call ^d,!:IL8 $(foreach ;,$3,$(call ^d,$(call `c0,$(call ^u,$;),$1))))
`M.current-env = !:IL4 $(call ^d,$1)
`M.current-file = $(or $(call `check-arity,0,$3,$2),$(if ,,!:IL10 ))
`M.current-file-line = $(or $(call `check-arity,0,$3,$2),!:IL10 $(call `form-index,$2))
`M.concat = $(call `il-concat,$(foreach ;,$3,$(call ^d,$(call `c0,$(call ^u,$;),$1))))
`M... = $(call `il-concat,$(foreach ;,$3,$(call ^d,$(call `c0,$(call ^u,$;),$1))))
`M.._. = $(call `il-concat,$(foreach ;,$(call `intersperse,!:P1 0 !0,$3),$(call ^d,$(call `c0,$(call ^u,$;),$1))))
`subst-x = $(if $1,$(call `subst-x,$(wordlist 3,99999999,$1),!:IL6 subst $(call `conj,$(wordlist 1,2,$1),$2)),$2)
`M.subst = $(if $(filter %2 %4 %6 %8 %0 1,$(words $3)),$(call `gen-error,$2,$(if ,,(subst {FROM TO}+ STR) accepts 2n+1 arguments, not %s),$(words $3)),$(call `subst-x,$(foreach ;,$(call `butlast,$3),$(call ^d,$(call `c0,$(call ^u,$;),$1))),$(call `c0,$(call ^u,$(lastword $3)),$1)))
`c0-set = $(if $(filter !:P2,$(word 1,$2)),$(foreach ;,$(call ^d,$(call `resolve,$2,$1)),$(if $(filter !1:EDefn0!0%,$;!0),!:IL7 ^set $(call `append,$(call ^d,!:IL4 $(call ^d,$(word 3,$(call ^u,$;)))) $(call ^d,$3),$(if $4,$(call ^d,$4))),$(if $(filter !1:EDefn1!0%,$;!0),!:IL7 ^fset $(call `append,$(call ^d,!:IL4 $(call ^d,$(word 3,$(call ^u,$;)))) $(call ^d,$3),$(if $4,$(call ^d,$4))),$(call `gen-error,$2,`%s` is not a global variable,$(call `symbol-name,$2))))),$(call `err-expected,S,$2,,$5,$6))
`M.set = $(or $(call `check-arity,2 3,$3,$2),$(call `c0-set,$1,$(call ^n,1,$3),$(call `c0,$(call ^n,2,$3),$1),$(if $(call ^n,3,$3),$(call `c0,$(call ^n,3,$3),$1)),NAME,(set NAME VALUE [RETVAL])))
`M.? = $(foreach ;,$(call ^d,$(call `resolve,$(call ^n,1,$3),$1)),$(if $(filter !1:EDefn1!0%,$;!0),$(call ^Y,^t,$(call `cons,!:IL4 $(call ^d,$(word 3,$(call ^u,$;))),$(foreach ;;,$(wordlist 2,99999999,$3),$(call ^d,$(call `c0,$(call ^u,$(;;)),$1)))),,,,,,,,!:IL7 $`1 $`2),$(if $(filter !1:EDefn6!0%,$;!0),$(call ^Y,^t,$(call `cons,!:IL4 $(call ^d,$(word 3,$(call ^u,$;))),$(foreach ;;,$(wordlist 2,99999999,$3),$(call ^d,$(call `c0,$(call ^u,$(;;)),$1)))),,,,,,,,!:IL6 $`1 $`2),$(if $(findstring $(subst $(call ^u,$;)0,1,-0),1),$(call `err-expected,S,$(call ^n,1,$3),$2,FUNC,(? FUNC ARGS...)),$(if $(call ^u,$;),$(call `gen-error,$(call ^n,1,$3),FUNC in (? FUNC ...) is not traceable),$(call `gen-error,$(call ^n,1,$3),undefined variable: `%s`,$(call `symbol-name,$2)))))))
`let-err = $(call `gen-error,$1,$(call ^n,$2,extra!0form!0after!0VALUE missing!0VALUE missing!0TARGET expected!0(TARGET!0VALUE) missing!0((TARGET!0VALUE)...) expected!0((TARGET!0VALUE)...) empty!0((TARGET!0VALUE)...) '?NAME'!0and!0'...NAME'!0cannot!0be!0used!0as!0TARGET) in %s,$3)
`parse-pairs = $(if $(filter !:P0,$(word 1,$1)),$(or $(foreach ;,$(wordlist 3,99999999,$1),$(call ^d,$(if $(filter !:P0,$(word 1,$(call ^u,$;))),$(if $(filter-out 2,$(words $(wordlist 3,99999999,$(call ^u,$;)))),$(if $(call ^n,3,$(wordlist 3,99999999,$(call ^u,$;))),$(call `let-err,$(call ^n,3,$(wordlist 3,99999999,$(call ^u,$;))),1,$3),$(call `let-err,$(call ^u,$;),$(if $(wordlist 3,99999999,$(call ^u,$;)),2,3),$3)),$(if $(foreach ;;,$(call ^d,$(call ^n,1,$(wordlist 3,99999999,$(call ^u,$;)))),$(if $(filter !1:P2!0%,$(;;)!0),$(filter ?% ...%,$(call ^n,3,$(call ^u,$(;;)))),)),$(call `let-err,$(call ^n,1,$(wordlist 3,99999999,$(call ^u,$;))),8,$3),$(call ^d,$(call ^n,1,$(wordlist 3,99999999,$(call ^u,$;)))) $(call ^d,$(call ^n,2,$(wordlist 3,99999999,$(call ^u,$;)))))),$(call `let-err,$(call ^u,$;),4,$3)))),$(call ^d,$(call `let-err,$1,7,$3))),$(call ^d,$(call `let-err,$(or $1,$2),$(if $1,6,5),$3)))
`c0-let = $(or $(call `first-perror,$3),!:IL2 $(call `cons,$(call `c0-lambda,$1,$(foreach ;,$3,$(call ^d,$(call ^n,1,$(call ^u,$;)))),$2),$(foreach ;,$(foreach ;,$3,$(call ^d,$(call ^n,2,$(call ^u,$;)))),$(call ^d,$(call `c0,$(call ^u,$;),$1)))))
`M.let = $(call `c0-let,$1,$(wordlist 2,99999999,$3),$(call `parse-pairs,$(call ^n,1,$3),$2,(let ((TARGET VALUE)...) BODY)))
`letg-where := (let-global ((TARGET VALUE)...) BODY)
`letting = $(call `c0-set,$1,$2,$(call `c0-set,$1,$2,$3,$(call `c0,$2,$1),,),$4,,)
`lg*2 = $(or $(call `first-perror,$4),$(if $(word 2,$4),!:IL2 $(call ^d,!:IL1 $(call ^d,$(call `lg*,$(call `append,:!=$(call ^d,!:EDefn7 .$(call `current-depth,$1)),$1),$2,$3,$4,!:IL0 1 .,$6))) $(call ^d,$5),$(call `lg*,$1,$2,$3,$4,$5,$6)))
`lg* = $(if $4,$(if $(filter !:NX0,$(word 1,$(call ^n,1,$4))),$(call `letting,$1,!:P2 $6 $(call ^d,$(call ^n,2,$(call ^n,1,$4))),$(call ^Y,$5,,,,,,,,,$(call ^n,3,$(call ^n,1,$4))),$(call `lg*,$1,$2,$3,$(wordlist 2,99999999,$4),$5,$6)),$(call ^n,1,$4)),$(if $3,$(or $(call `first-perror,$3),$(call `lg*2,$1,$2,$(wordlist 2,99999999,$3),$(call `parse-target,$(call ^n,1,$(call ^n,1,$3))),$(call `c0,$(call ^n,2,$(call ^n,1,$3)),$1),$(call `form-index,$(call ^n,1,$(call ^n,1,$3))))),$(call `c0-block,$2,$1)))
`M.let-global = $(call `lg*,$1,$(wordlist 2,99999999,$3),$(call `parse-pairs,$(call ^n,1,$3),$2,$(`letg-where)),,,)
`let&-where := (let& ((TARGET VALUE)...) BODY)
`let&-bindings = $(if $(call ^n,1,$1),$(if $(filter !:P8,$(word 1,$(call ^n,1,$1))),;!=$(call ^d,$(call ^n,1,$1)),$(call `let&-bindings,$(wordlist 2,99999999,$1),$2,$3,$(call `append,$(call `bind-target,$(call ^n,1,$(call ^n,1,$1)),p,$2,$(call `c0,$(call ^n,2,$(call ^n,1,$1)),$4 $3)),$4))),$4)
`M.let& = $(call ^Y,$(call `let&-bindings,$(call `parse-pairs,$(call ^n,1,$3),$2,$(`let&-where)),$(call `current-depth,$1),$1),$(wordlist 2,99999999,$3),$1,,,,,,,$`(or $`(call `dict-get,;,$`1),$`(call `c0-block,$`2,$`(call `append,$`1,$`3))))
`c0-for2 = $(if $2,$(if $6,!:IL3 $(subst .,,$3) $(call ^d,$(call `c0,$(call ^n,2,$5),$1)) $(call ^Y,$(call `c0-block,$6,$2 $(call `append,:!=$(call ^d,!:EDefn7 $3),$1)),,,,,,,,,$7),$(call `err-expected,,,$4,$(if $(word 2,$5),BODY,$(filter VEC LIST,$8)),$8)),$(call `err-expected,S,$(call ^n,1,$5),$4,TARGET,$8))
`M.for = $(if $(filter !:P0,$(word 1,$(call ^n,1,$3))),$(if $(wordlist 3,99999999,$(call ^n,1,$3)),$(foreach ;,$(call `current-depth,$1);,$(call `c0-for2,$1,$(call `bind-target,$(call ^n,1,$(wordlist 3,99999999,$(call ^n,1,$3))),p,$;,$(call ^Y,!:IL0 $(subst .,,$;) .,,,,,,,,,$(value `il-promote))),$;,$2,$(wordlist 3,99999999,$(call ^n,1,$3)),$(wordlist 2,99999999,$3),$(value `il-demote),(for (TARGET VEC) BODY))),$(call `err-expected,S,,$2,TARGET,(for (TARGET VEC) BODY))),$(if $(wordlist 1,2,$3),$(foreach ;,$(call `current-depth,$1);,$(call `c0-for2,$1,$(call `bind-target,$(call ^n,1,$(wordlist 1,2,$3)),p,$;,$(call ^Y,!:IL0 $(subst .,,$;) .,,,,,,,,,$(value `il-promote))),$;,$2,$(wordlist 1,2,$3),$(wordlist 3,99999999,$3),$(value `il-demote),(for TARGET VEC BODY))),$(call `err-expected,S,,$2,TARGET,(for TARGET VEC BODY))))
`M.append-for = !:IL6 filter $(call ^d,!:IL4 %) $(call ^d,$(if $(filter !:P0,$(word 1,$(call ^n,1,$3))),$(if $(wordlist 3,99999999,$(call ^n,1,$3)),$(foreach ;,$(call `current-depth,$1);,$(call `c0-for2,$1,$(call `bind-target,$(call ^n,1,$(wordlist 3,99999999,$(call ^n,1,$3))),p,$;,$(call ^Y,!:IL0 $(subst .,,$;) .,,,,,,,,,$(value `il-promote))),$;,$2,$(wordlist 3,99999999,$(call ^n,1,$3)),$(wordlist 2,99999999,$3),$`1,(append-for (TARGET VEC) BODY))),$(call `err-expected,S,,$2,TARGET,(append-for (TARGET VEC) BODY))),$(if $(wordlist 1,2,$3),$(foreach ;,$(call `current-depth,$1);,$(call `c0-for2,$1,$(call `bind-target,$(call ^n,1,$(wordlist 1,2,$3)),p,$;,$(call ^Y,!:IL0 $(subst .,,$;) .,,,,,,,,,$(value `il-promote))),$;,$2,$(wordlist 1,2,$3),$(wordlist 3,99999999,$3),$`1,(append-for TARGET VEC BODY))),$(call `err-expected,S,,$2,TARGET,(append-for TARGET VEC BODY)))))
`c0-cfor2 = $(or $(foreach ;,$(call ^d,$(call ^Y,,,,,,,,,,$7)),$(if $(filter !1:IL4!0%,$;!0),$(if $(findstring $(subst $  0,1,$(call ^n,2,$(call ^u,$;))0),1),$(if $3,$(foreach ;;,$(call `current-depth,$1);,$(call `c0-for2,$1,$(call `bind-target,$(call ^n,1,$3),p,$(;;),$(call ^Y,!:IL0 $(subst .,,$(;;)) .,,,,,,,,,$5)),$(;;),$2,$3,$4,$`1,$6)),$(call `err-expected,S,,$2,TARGET,$6))),)),$(call `subst-in-il,~x,,$(call `il-subst,!:IL4 ~x~x!0,$(call `subst-in-il,~,~~x,$7),$(if $3,$(foreach ;,$(call `current-depth,$1);,$(call `c0-for2,$1,$(call `bind-target,$(call ^n,1,$3),p,$;,$(call ^Y,!:IL0 $(subst .,,$;) .,,,,,,,,,$5)),$;,$2,$3,$4,!:IL8 $`(call ^d,$`(call `subst-in-il,~,~~x,$`1)) $`(call ^d,!:IL4 ~x~x),$6)),$(call `err-expected,S,,$2,TARGET,$6)))))
`c0-cfor = $(call `c0-cfor2,$1,$2,$3,$4,$5,$6,$(if $(word 3,$3),$(call `c0,$(call ^n,3,$3),$1),!:IL4 !0))
`M.concat-for = $(if $(filter !:P0,$(word 1,$(call ^n,1,$3))),$(call `c0-cfor,$1,$2,$(wordlist 3,99999999,$(call ^n,1,$3)),$(wordlist 2,99999999,$3),$(value `il-promote),(concat-for (TARGET VEC ?DELIM) BODY)),$(call `c0-cfor,$1,$2,$(wordlist 1,3,$3),$(wordlist 4,99999999,$3),$(value `il-promote),(concat-for TARGET VEC DELIM BODY)))
`M.foreach = $(if $(filter !:P0,$(word 1,$(call ^n,1,$3))),$(call `c0-cfor,$1,$2,$(wordlist 3,99999999,$(call ^n,1,$3)),$(wordlist 2,99999999,$3),$`1,(foreach (TARGET LIST ?DELIM) BODY)),$(if $(wordlist 1,2,$3),$(foreach ;,$(call `current-depth,$1);,$(call `c0-for2,$1,$(call `bind-target,$(call ^n,1,$(wordlist 1,2,$3)),p,$;,$(call ^Y,!:IL0 $(subst .,,$;) .,,,,,,,,,$`1)),$;,$2,$(wordlist 1,2,$3),$(wordlist 3,99999999,$3),$`1,(foreach TARGET LIST BODY))),$(call `err-expected,S,,$2,TARGET,(foreach TARGET LIST BODY))))
`cond-where := (cond (TEST BODY)...)
`begin-block = $(if $(filter 1,$(words $1)),$(call ^n,1,$1),!:P0 0 $(call `cons,!:P2 0 begin,$1))
`cond-wrap = $(if $(filter !:P0,$(word 1,$1)),$(if $(wordlist 2,99999999,$(wordlist 3,99999999,$1)),$(if $(foreach ;,$(call ^d,$(call ^n,1,$(wordlist 3,99999999,$1))),$(if $(filter !1:P2!0%,$;!0),$(findstring $(subst else0,1,$(call ^n,3,$(call ^u,$;))0),1),)),$(if $(if $2,,1),$(call `begin-block,$(wordlist 2,99999999,$(wordlist 3,99999999,$1))),$(call `gen-error,$(call ^n,1,$(wordlist 3,99999999,$1)),(else ...) is followed by additional clauses)),!:P0 0 $(call `append,$(call ^d,!:P2 0 if) $(call ^d,$(call ^n,1,$(wordlist 3,99999999,$1))) $(call ^d,$(call `begin-block,$(wordlist 2,99999999,$(wordlist 3,99999999,$1)))),$(if $2,$(call ^d,$2)))),$(if $(call ^n,1,$(wordlist 3,99999999,$1)),$(call `err-expected,,,$1,BODY,$(`cond-where)),$(call `err-expected,,,$1,TEST,$(`cond-where)))),$(call `err-expected,L,$1,,(TEST BODY),$(`cond-where)))
`M.cond = $(call `c0,$(call `foldr,$(value `cond-wrap),,$3),$1)
`defn-native-name = $(if $(filter !:EDefn1 !:EDefn0 !:EDefn6,$(word 1,$1)),$(word 3,$1),)
`M.native-name = $(or $(call `check-arity,1,$3,$2),$(if $(filter !:P2,$(word 1,$(call ^n,1,$3))),$(call ^Y,$(call `defn-native-name,$(call `resolve,$(call ^n,1,$3),$1)),$(call ^n,3,$(call ^n,1,$3)),,,,,,,,$`(if $`1,!:IL4 $`(call ^d,$`1),$`(call `gen-error,$`(call ^n,1,$(call ^E,$3)),`%s` is not a global variable,$`2))),$(call `err-expected,S,$(call ^n,1,$3),$2,NAME,(native-name NAME))))
`defmacro-where := (defmacro (NAME ARGS [POS]) BODY)
`M.defmacro = $(if $(filter !:P0,$(word 1,$(call ^n,1,$3))),$(foreach ;,$(call ^d,$(call ^n,1,$(wordlist 3,99999999,$(call ^n,1,$3)))),$(if $(filter !1:P2!0%,$;!0),!:IL12 $(call ^d,$(call ^k,$(call ^n,3,$(call ^u,$;)))!=$(call ^d,!:EDefn4 x $(call `gen-native-name,$(call ^n,3,$(call ^u,$;)),$1))) $(foreach ;;,$(call ^d,$(call `c0,!:P0 0 $(call `cons,!:P2 0 define,$3),$1)),$(if $(filter !1:IL12!0%,$(;;)!0),$(wordlist 3,99999999,$(call ^u,$(;;))),$(call ^u,$(;;)))),$(call `err-expected,S,$(call ^n,1,$(wordlist 3,99999999,$(call ^n,1,$3))),$2,NAME,$(`defmacro-where)))),$(call `err-expected,L,$(call ^n,1,$3),$2,(NAME ARG...),$(`defmacro-where)))
$(call ^at,!1:Data0!=DataType!0W!0W!0S!0L)
`data-where := (data NAME (CTOR ARG...)...)
`read-type-r = $(or $(if $(if $1,,1),$(if $6,$(call `gen-error,$2,no argument following last flag: %s,$6),!:Data0 $3 $(call ^n,1,$4) $(call ^d,$(wordlist 2,99999999,$4)) $5)),$(if $(filter !:P2,$(word 1,$(call ^n,1,$1))),$(or $(if $(if $(filter &%,$(call ^n,3,$(call ^n,1,$1))),,1),$(call `read-type-r,$(wordlist 2,99999999,$1),$2,$3,$4 $(if $(findstring $(subst $60,1,&word0),1),W,$(if $(and $(findstring $(subst $60,1,&list0),1),$(if $(word 2,$1),,1)),L,S)),$(call `conj,$5,$(call ^n,3,$(call ^n,1,$1))),)),$(if $6,$(call `gen-error,$(call ^n,1,$1),two type flags supplied for one argument)),$(if $(filter &list &word,$(call ^n,3,$(call ^n,1,$1))),$(call `read-type-r,$(wordlist 2,99999999,$1),$2,$3,$4,$5,$(call ^n,3,$(call ^n,1,$1)))),$(call `gen-error,$(call ^n,1,$1),$(if ,,unknown flag [supported: &list, &word]))),$(call `err-expected,S,$(call ^n,1,$1),$2,ARG,$(`data-where))))
`read-type = $(if $(filter !:P0,$(word 1,$1)),$(foreach ;,$(call ^d,$(call ^n,1,$(wordlist 3,99999999,$1))),$(if $(filter !1:P2!0%,$;!0),$(foreach ;;,$(call ^d,$(call ^n,2,$(wordlist 3,99999999,$1))),$(if $(filter !1:P1!0%,$(;;)!0),$(call `read-type-r,$(wordlist 3,99999999,$(wordlist 3,99999999,$1)),$1,$(call ^n,3,$(call ^u,$(;;))),$(call ^n,3,$(call ^u,$;)),,),$(call `read-type-r,$(wordlist 2,99999999,$(wordlist 3,99999999,$1)),$1,$2,$(call ^n,3,$(call ^u,$;)),,))),$(call `err-expected,S,$(call ^n,1,$(wordlist 3,99999999,$1)),$3,CTOR,$(`data-where)))),$(call `err-expected,L,$1,$3,(CTOR ...),$(`data-where)))
`read-types = $(if $(filter !:P8,$(word 1,$5)),$5,$(if $(if $3,,1),$(call `append,$6,$(if $5,$(call ^d,$5))),$(call `read-types,$1,$2,$(wordlist 2,99999999,$3),$(call `append,$4,1),$(call `read-type,$(call ^n,1,$3),$2$(words $4),$1),$(call `append,$6,$(if $5,$(call ^d,$5))))))
`M.data = $(call ^Y,$(if $(filter !:P2,$(word 1,$(call ^n,1,$3))),$(call `read-types,$2,!:$(call ^n,3,$(call ^n,1,$3)),$(call `skip-flags,$3)),$(call `err-expected,S,$(call ^n,1,$3),$2,NAME,$(`data-where))),$(if $(filter &public,$(call `get-flags,$3)),x,p),,,,,,,,$`(or $`(if $`(filter !:P8,$`(word 1,$`1)),$`1,),!:IL12 $`(call ^d,$`(filter %,$`(foreach ;,$`1,$`(if $`(filter !:Data0,$`(word 1,$`(call ^u,$`;))),$`(call ^k,$`(word 3,$`(call ^u,$`;)))!=$`(call ^d,!:EDefn5 $`2 $`(call ^d,$`(call ^n,4,$`(call ^u,$`;))) $`(call ^d,$`(word 2,$`(call ^u,$`;)))),)))) !:IL7 ^at $`(call ^d,!:IL4 $`(call ^d,$`(filter %,$`(foreach ;,$`1,$`(if $`(filter !:Data0,$`(word 1,$`(call ^u,$`;))),$`(call ^k,$`(word 2,$`(call ^u,$`;)))!=$`(call ^d,$`(call `append,$`(word 3,$`(call ^u,$`;)),$`(call ^n,4,$`(call ^u,$`;)))),)))))))
`case-where := (case VALUE (PATTERN BODY)...)
$(call ^at,!1:Case0!=Clause!0S!0S!0L)
`clause-or-error = $(or $(call `first-perror,$2),!:Case0 $(call ^d,$1) $(call ^d,$2) $3)
`enc-xtor = $(if $(filter S,$1),!:IL7 ^n $`(call ^d,!:IL4 $`(call ^d,$(call ^E,$2))) $`(call ^d,$`1),$(if $(filter W,$1),!:IL6 word $`(call ^d,!:IL4 $`(call ^d,$(call ^E,$2))) $`(call ^d,$`1),$`(call `il-nth-rest,$(call ^E,$2),$`1)))
`record-nxmap = $(filter %,$(foreach ;,$(call `indices,$1),$(call `parse-target,$(call ^n,$(call ^u,$;),$1),$(call `enc-xtor,$(call ^n,$(call ^u,$;),$2),$(call `1+,$(call ^u,$;))))))
`case-parse = $(foreach ;,$1,$(call ^d,$(if $(filter !:P0,$(word 1,$(call ^u,$;))),$(if $(word 2,$(wordlist 3,99999999,$(call ^u,$;))),$(foreach ;;,$(call ^d,$(call ^n,1,$(wordlist 3,99999999,$(call ^u,$;)))),$(if $(filter !1:P0!0%,$(;;)!0),$(foreach ;;;,$(call ^d,$(call `resolve,$(call ^n,1,$(wordlist 3,99999999,$(call ^u,$(;;)))),$2)),$(if $(filter !1:EDefn5!0%,$(;;;)!0),$(or $(call `check-arity,$(words $(call ^n,3,$(call ^u,$(;;;)))),$(wordlist 2,99999999,$(wordlist 3,99999999,$(call ^u,$(;;)))),$(call ^n,1,$(wordlist 3,99999999,$(call ^u,$(;;))))),$(call `clause-or-error,$(call ^n,4,$(call ^u,$(;;;))),$(call `record-nxmap,$(wordlist 2,99999999,$(wordlist 3,99999999,$(call ^u,$(;;)))),$(call ^n,3,$(call ^u,$(;;;)))),$(wordlist 2,99999999,$(wordlist 3,99999999,$(call ^u,$;))))),$(call `gen-error,$(call ^n,1,$(wordlist 3,99999999,$(call ^u,$(;;)))),expected a record constructor name))),$(call `clause-or-error,,$(call `parse-target,$(call ^u,$(;;))),$(wordlist 2,99999999,$(wordlist 3,99999999,$(call ^u,$;)))))),$(call `err-expected,,,$(call ^u,$;),$(if $(wordlist 3,99999999,$(call ^u,$;)),BODY,PATTERN),$(`case-where))),$(call `err-expected,L,$(call ^u,$;),,(PATTERN BODY),$(`case-where)))))
`case-cb = $(foreach ;,$1,$(call ^d,$(if $(filter !:Case0,$(word 1,$(call ^u,$;))),$(call ^d,$(call ^n,2,$(call ^u,$;))) $(call ^d,$(call `c0-block,$(wordlist 4,99999999,$(call ^u,$;)),$(call `append,$(call `bind-nxmap,$(call ^n,3,$(call ^u,$;)),p,$4,$2),$3))),!. $;)))
`case-merge = $(if $(word 2,$1),$(if $(findstring $(subst $(call ^n,2,$(call ^n,2,$1))0,1,$(call ^n,2,$(call ^n,1,$1))0),1),$(call `case-merge,$(call `cons,$(call ^d,$(addprefix $(call ^n,1,$(call ^n,1,$1)) ,$(call ^n,1,$(call ^n,2,$1)))) $(call ^d,$(call ^n,2,$(call ^n,1,$1))),$(wordlist 3,99999999,$1))),$(call `append,$(word 1,$1),$(call `case-merge,$(wordlist 2,99999999,$1)))),$1)
`case-fold = $(if $(or $(call ^n,1,$(call ^n,1,$1)),$(wordlist 2,99999999,$1)),!:IL6 if $(call ^d,$(if $(call ^n,1,$(call ^n,1,$1)),!:IL6 filter $(call ^Y,$(call ^n,1,$(call ^n,1,$1)),,,,,,,,,$2),!:IL4 1)) $(call ^d,$(call ^n,2,$(call ^n,1,$1))) $(call ^d,$(call `case-fold,$(wordlist 2,99999999,$1),$2)),$(or $(call ^n,2,$(call ^n,1,$1)),!:IL4 !.))
`c0-case = $(if $(and $(if $5,,1),$(if $(filter !:IL0 !:IL5 !:IL4,$(word 1,$4)),,$(if $(filter !:IL6 !:IL7,$(word 1,$4)),$(or $(filter-out ^u ^n wordlist,$(word 2,$4)),$(word 1,$(foreach ;,$(wordlist 3,99999999,$4),$(if $(filter !:IL0 !:IL5 !:IL4,$(word 1,$(call ^u,$;))),,1)))),1))),!:IL3 $(subst .,,$3;) $(call ^d,$(call `il-demote,$4)) $(call `c0-case,$(call `append,:!=$(call ^d,!:EDefn7 $3;),$1),$2,$3;,$(call `il-promote,!:IL0 $(subst .,,$3;) .),$`(call ^d,!:IL4 $`(call ^d,$`(subst !0,!0% ,$`(call ^d,$`1))!0%)) $`(call ^d,!:IL8 $`(call ^d,!:IL0 $`(subst .,,$(call ^E,$3);) .) $`(call ^d,!:IL4 !10))),$(call `case-fold,$(call `case-merge,$(call `case-cb,$(call `case-parse,$2,$1),$4,$1,$3)),$(or $5,$`(call ^d,!:IL4 $`(call ^d,$`1)) $`(call ^d,!:IL6 word $`(call ^d,!:IL4 1) $`(call ^d,$(call ^E,$4))))))
`M.case = $(if $3,$(call `c0-case,$1,$(wordlist 2,99999999,$3),$(call `current-depth,$1),$(call `c0,$(call ^n,1,$3),$1)),$(call `err-expected,,,$2,VALUE,$(`case-where)))

endef

define [mod-string]
# Requires: core
# Exports: string-repeat}2 string-from-bytecodes}1 bytes-from-bytecodes}1 string-to-bytecodes}1 string-lower}1 string-upper}1 string-slice}3 string-len}1 string-to-bytes}1 string-to-chars}1 gen-polysub}2'3
$(call ^R,core)
`all-bytes :=           !+ $'                        !0   !1 " \# $` % & ' ( ) * + , - . / 0 1 2 3 4 5 6 7 8 9 : ; < = > ? @ A B C D E F G H I J K L M N O P Q R S T U V W X Y Z [ \ ] ^ _ ` a b c d e f g h i j k l m n o p q r s t u v w x y z { | } ~                                                                                                                                 
`gen-polysub = $(if $1,$(call `gen-polysub,$(wordlist 2,99999999,$1),$(wordlist 2,99999999,$2),$`(subst $(if $(filter !0% !+%,$(word 1,$1)),$` )$(subst $(if ,,,),$`&,$(subst $],$`],$(subst $[,$`[,$(subst $`,$`$`,$(call ^u,$(word 1,$1)))))),$(if $(filter !0% !+%,$(word 1,$2)),$` )$(subst $(if ,,,),$`&,$(subst $],$`],$(subst $[,$`[,$(subst $`,$`$`,$(call ^u,$(word 1,$2)))))),$(or $3,$`1))),$(or $3,$`1))
`def-split = $(call ^fset,$1,$(call `gen-polysub,$(subst !0, ,$(call ^d,$2)),$(patsubst %,$3,$(subst !0, ,$(call ^d,$2)))),)
$(if $(call `def-split,`split-ascii,$(filter-out !1 !0 !+,$(wordlist 1,127,$(`all-bytes))),%!0),)
$(if $(call `def-split,`split-high,$(wordlist 128,255,$(`all-bytes)),%!0),)
$(if $(call `def-split,`split-utf8-esc,$(wordlist 194,244,$(`all-bytes)),%!0),)
$(if $(call `def-split,`split-utf8-cont,$(wordlist 128,191,$(`all-bytes)),!1.%!0),)
`utf8-group-if = $(if $(word 2,$1),$(subst !., ,$(subst $  !.,,$(call `split-utf8-cont,$1))),$1)
`string-to-chars = $(filter %,$(call `split-ascii,$(call `utf8-group-if,$(call `split-utf8-esc,$(subst $ 	,!+,$(subst $  ,!0,$(subst !,!1,$1)))))))
`string-to-bytes = $(filter %,$(call `split-high,$(call `split-ascii,$(subst $ 	,!+,$(subst $  ,!0,$(subst !,!1,$1))))))
`string-len = $(words $(call `string-to-chars,$1))
`string-slice = $(call ^u,$(subst $  ,,$(wordlist $1,$2,$(call `string-to-chars,$3))))
$(call ^fset,`string-upper,$(call `gen-polysub,$(wordlist 97,122,$(`all-bytes)),$(wordlist 65,90,$(`all-bytes))))
$(call ^fset,`string-lower,$(call `gen-polysub,$(wordlist 65,90,$(`all-bytes)),$(wordlist 97,122,$(`all-bytes))))
`string-to-bytecodes = $(and $(if $(if $(value `num-enc),,1),$(and $(call ^fset,`num-enc,$(call `gen-polysub,!10 !11 0 1 2 3 4 5 6 7 8 9,$(addprefix !1,a b c d e f g h i j k l)))1,$(call ^fset,`s2b-sub,$(call `gen-polysub,$(subst !0, ,$(call ^d,$(call `num-enc,$(`all-bytes)))),$(addsuffix !0,$(call `indices,$(`all-bytes)))))))1,$(filter %,$(call `s2b-sub,$(call `num-enc,$(subst $ 	,!+,$(subst $  ,!0,$(subst !,!1,$1)))))))
`bytes-from-bytecodes = $(foreach ;,$(patsubst 0,999,$1),$(or $(word $;,$(`all-bytes)),!.))
`string-from-bytecodes = $(call `concat-vec,$(call `bytes-from-bytecodes,$1))
`string-repeat = $(subst .,$1,$(subst $  ,,$(call `repeat-words,. . . . .,$2)))

endef

define [mod-math0]
# Requires: core
# Exports: 
$(call ^R,core)
`d2u = $(subst 3,0111,$(subst 6,3111,$(subst 8,611,$(subst 9,81,$(subst 7,61,$(subst 5,311,$(subst 4,31,$(subst 2,011,$(subst 1,01,$(or $1,?))))))))))
`u2d = $(subst 01,1,$(subst 011,2,$(subst 31,4,$(subst 311,5,$(subst 61,7,$(subst 81,9,$(subst 611,8,$(subst 3111,6,$(subst 0111,3,$1)))))))))
`uf-get-lz = $(subst :, ,$(filter-out 01%,$(subst :01, 01,$(subst $  ,:,$1))))
`uf-trim-lz = $(subst :, ,$(filter 01%,$(subst :01, 01,$(subst $  ,:,$1))))
`u-carry-fn = $(subst $21,1$3,$(if $(findstring $2$21,$1),$(call `u-carry-fn,$1,$2$2,$3$3),$1))
`borrow-n = $(if $(findstring $2~,$1),$(subst 1~,,$(subst $2~,~$(subst 0,0111111111,$2),$(call `borrow-n,$1,$2$2))),$1)
`u-sub-unsigned = $(foreach ;,$(subst $  ,,$(subst 1~,,$(subst 11~~,,$(subst 111~~~,,$(subst 111111~~~~~~,,$(subst 00,0,$(subst 10,1,$(join $(subst 0, 0,$(subst 1,,$2)$1),$(subst 0, 0,$(subst 1,,$1)$(subst 1,~,$2)))))))))),$(if $(findstring ~,$;),$(patsubst -0,0,$(subst $  ,,$(patsubst 0%,0,$(subst 01,0 1,$(call `borrow-n,$(subst 1~,,$(subst 11~~,,$(subst 111~~~,,$(subst 111111~~~~~~,,$(subst 0~,~0111111111,$(if $(filter ~%,$(subst 0,,$;)),- $(subst *,1,$(subst 1,~,$(subst ~,*,$;))),$;)))))),0))))),0$(subst $  ,,$(wordlist 2,99999999,$(subst 01,0 1,$;)))))
`u-add-unsigned-fn = 0$(subst $  ,,$(wordlist 2,99999999,$(subst 01,0 1,$(foreach ;,$(subst 01111111111,10,$(subst $  ,,$(subst 00,0,$(subst 10,1,$(join $(subst 0, 0,$(subst 1,,$1)$2),$(subst 0, 0,$(subst 1,,$2)$1)))))),$(if $(findstring 01111111111,$;),$(call `u-carry-fn,$;,0111111111,0),$;)))))
`u-add = $(if $(findstring -,$1$2),$(if $(findstring 1,$1$2),$(if $(findstring -,$1),$(if $(findstring -,$2),-$(call `u-add-unsigned-fn,$(subst -,,$1),$(subst -,,$2)),$(call `u-sub-unsigned,$2,$(subst -,,$1))),$(call `u-sub-unsigned,$1,$(subst -,,$2))),0),0$(subst $  ,,$(wordlist 2,99999999,$(subst 01,0 1,$(foreach ;,$(subst 01111111111,10,$(subst $  ,,$(subst 00,0,$(subst 10,1,$(join $(subst 0, 0,$(subst 1,,$1)$2),$(subst 0, 0,$(subst 1,,$2)$1)))))),$(if $(findstring 01111111111,$;),$(call `u-carry-fn,$;,0111111111,0),$;))))))
`u-cmp = $(if $(findstring -,$1$2),$(if $(findstring 1,$1$2),$(if $(findstring -,$1),$(if $(findstring -,$2),$(call `u-cmp,$(subst -,,$2),$(subst -,,$1)),~),1)),$(word 1,$(subst 0,,$(subst 1~,,$(subst 11~~,,$(subst 10~,,$(subst 111110~~~~~,0,$(join $(subst 0, 0,$(subst 1,,$2)$1),$(subst 0, 0,$(subst 1,,$1)$(subst 1,~,$2))))))))))
`uf-cmp = $(word 1,$(subst 0,,$(subst 1~,,$(subst 11~~,,$(subst 10~,,$(subst 111110~~~~~,0,$(join $1,$(subst 1,~,$2))))))))
`uf-sign-sub = $(foreach ;,$(subst $  ,,$(subst 00,0,$(subst 10,1,$(subst 1~,,$(subst 11~~,,$(subst 10~,,$(subst 111110~~~~~,0,$(join $1,$(subst 1,~,$2))))))))),$(if $(findstring ~,$;),$(strip $(subst 0, 0,$(call `borrow-n,$(subst 1~,,$(subst 11~~,,$(subst 111~~~,,$(subst 111111~~~~~~,,$(subst 0~,~0111111111,$(if $(filter ~%,$(subst 0,,$;)),$(if $3,+,-) $(subst *,1,$(subst 1,~,$(subst ~,*,$;))),$(if $3,-,+) $;)))))),0))),$(if $3,-,+) $(strip $(subst 0, 0,$;))))
`u-carry-all = $(if $(findstring 01111111111,$1),$(call `u-carry-all,$(patsubst -1%,-01%,$(patsubst 1%,01%,$(subst 0X,1,$(subst 1111111111,X0,$1))))),$1)
`u-add-ones = $(or $(filter-out -% %1111111111,$1$2),$(call `u-add,$1,$(call `u-carry-all,0$2)))
`u-1 = $(or $(patsubst %1,%,$(filter-out -% %0,$1)),$(filter-out 0% %1111111111,$11),$(call `u-add,$1,-01))
`A*0 = 
`A*01 = $2
`A*011 = $3
`A*0111 = $4
`A*01111 = $5
`A*011111 = $6
`A*0111111 = $(subst $  01111111111,1 0,$(subst 1,11,$4))
`A*01111111 = $7
`A*011111111 = $(subst $  01111111111,1 0,$(subst 1,11,$5))
`A*0111111111 = $8
`vmul-9 = 0$(subst $  , 0,$(subst $  X,1,$(subst 1111111111,X ,$(subst 0,,$(join $(join $(join $(`A*$(word 1,$1)),0 $(`A*$(word 2,$1))),0 0 $(join $(`A*$(word 3,$1)),0 $(`A*$(word 4,$1)))),0 0 0 0 $(join $(join $(`A*$(word 5,$1)),0 $(`A*$(word 6,$1))),0 0 $(join $(`A*$(word 7,$1)),0 $(join $(`A*$(word 8,$1)),0 $(`A*$(word 9,$1))))))))))
`vmul-loop = $(if $(word 10,$1),$(subst $  011111111111111111111,11 0,$(filter 0%,$(subst 0, 0,$(foreach ;,$(subst 01111111111,10,$(subst $  ,,$(subst 00,0,$(subst 10,1,$(join 0 0 0 0 0 0 0 0 0 $(call `vmul-loop,$(wordlist 10,99999999,$1),$2,$3,$4,$5,$6,$7,$8),$(`vmul-9)))))),$(if $(findstring 01111111111,$;),$(call `u-carry-fn,$;,0111111111,0),$;))))),$(`vmul-9))
`vmul-0 = $(if $(findstring 1,$2),$(call `vmul,$1,$(subst ., ,$(filter-out %0,$(subst 0 ,0.,$2)))) $(subst ., ,$(filter %0,$(subst 0 ,0.,$2))),$(patsubst %,0,$1) $2)
`vmul = $(if $(filter 09,$29),$(call `vmul-0,$1,$2),$(call `vmul-loop,$2,0 $1,$(subst $  01111111111,1 0,$(subst 1,11,0 $1)),$(subst $  01111111111,1 0,$(subst $  01111111111,1 0,0 $(subst 1,111,$1))),$(subst x,11,$(subst $  0xxxxx,1 0,$(subst 1,xx,$(subst $  011111,x 0,0 $1)))),$(subst 2,1,$(subst 1 0, 011111,$(subst 11,2,$1 0))),$(subst $  01111111111,1 0,$(subst $  0X,1,$(subst 1111111111,X 0,0 $(subst 1,1111111,$1)))),$(subst $  01111111111,1 0,$(subst $  0X,1,$(subst 1111111111,X 0,0 $(subst 1,111111111,$1))))))
`uf*b1 = $(subst $  0X,1,$(subst 1111111111,X 0,0 $(subst 1,$(subst 0,,$2),$1)))
`uf*b2 = 0$(subst $  , 0,$(subst $  X,1,$(subst 1111111111,X ,$(subst 0,,$(join 0 $(subst 1,$(subst 0,,$(word 1,$2)),$1),0 0 $(subst 1,$(subst 0,,$(word 2,$2)),$1))))))
`uf*b3 = $(subst $  01111111111,1 0,0$(subst $  , 0,$(subst $  X,1,$(subst 1111111111,X ,$(subst 0,,$(join $(join 0 $(subst 1,$(subst 0,,$(word 1,$2)),$1),0 0 $(subst 1,$(subst 0,,$(word 2,$2)),$1)),0 0 $(join 0 $(subst 1,$(subst 0,,$(word 3,$2)),$1),0 $3)))))))
`uf*b4 = $(call `uf*b3,$1,$2,$(call `uf*b1,$1,$(word 4,$2)))
`uf*b5 = $(call `uf*b3,$1,$2,$(call `uf*b2,$1,$(wordlist 4,99999999,$2)))
`uf*b6 = $(call `uf*b3,$1,$2,$(call `uf*b3,$1,$(wordlist 4,99999999,$2)))
`uf*b7 = $(call `uf*b3,$1,$2,$(call `uf*b4,$1,$(wordlist 4,99999999,$2)))
`uf*b8 = $(call `uf*b3,$1,$2,$(call `uf*b5,$1,$(wordlist 4,99999999,$2)))
`uf-mul = $(if $(word $(words 1 $1),$2),$(call `uf-mul,$2,$1),$(filter 0%,$(subst 0, 0,$(foreach ;,$(subst 01111111111,10,$(subst $  ,,$(or $(`uf*b$(words $2)),$(call `vmul,$1,$2)))),$(if $(findstring 01111111111,$;),$(call `u-carry-fn,$;,0111111111,0),$;)))))
`div-post = $(if $(if $(filter 2 3,$1),$(findstring 1,$(if $(filter 3,$1),$3,$(or $(call `uf-cmp,$3,$(subst 2,1,$(subst 1 0, 011111,$(subst 11,2,$4 0)))),$(subst 11,,$(lastword $2)))))),$(filter 0%,$(subst 0, 0,$(foreach ;,$(subst 01111111111,10,$(subst $  ,,$21)),$(if $(findstring 01111111111,$;),$(call `u-carry-fn,$;,0111111111,0),$;)))),$(if $(filter 4,$1),$3,$2))
`div-loop = $(if $(findstring 1,$(word 1,$1)),$(call `div-loop,0 $(filter 0%,$(subst 0, 0,$(foreach ;,$(subst 01111111111,10,$(subst $  ,,$(subst 00,0,$(subst 10,1,$(join $(wordlist 2,99999999,$1),$2))))),$(if $(findstring 01111111111,$;),$(call `u-carry-fn,$;,0111111111,0),$;)))),$2,$3,$4,$5,$(subst 1x,,$6x)),$(if $(word $4,$6),$(call `div-post,$5,0 $6,$(wordlist 2,99999999,$1),$2),$(foreach ;,0$(subst 1111111111,111111111,$(subst x,1,$(subst 1,,$(subst $3,x,$(subst 0,,$(subst 1,1111111111,$(subst 1,1111111111,$(word 1,$(wordlist 2,99999999,$1)))$(word 2,$(wordlist 2,99999999,$1)))$(word 3,$(wordlist 2,99999999,$1))))))),$(call `div-loop,$(filter 0%,$(subst 0, 0,$(foreach ;;,$(subst 01111111111,10,$(subst $  ,,$(subst 00,0,$(subst 10,1,$(join $(wordlist 2,99999999,$1),$(subst 101,0,$(subst 11011,0,$(subst 1110111,0,$(patsubst 0%,%0111111111,$(patsubst 0111111%,%101111,$(filter 0%,$(subst 0, 0,$(foreach ;;,$(subst 01111111111,10,$(subst $  ,,$(subst $  0X,1,$(subst 1111111111,X 0,0 $(subst 1,$(subst 0,,$;),$2))))),$(if $(findstring 01111111111,$(;;)),$(call `u-carry-fn,$(;;),0111111111,0),$(;;))))))))))1))))),$(if $(findstring 01111111111,$(;;)),$(call `u-carry-fn,$(;;),0111111111,0),$(;;))))),$2,$3,$4,$5,$6$(if $6, )$;))))
`uf*3 = $(filter 0%,$(subst 0, 0,$(foreach ;,$(subst 01111111111,10,$(subst $  ,,$(subst 1,111,$1))),$(if $(findstring 01111111111,$;),$(call `u-carry-fn,$;,0111111111,0),$;))))
`power-seq-1 = $(if $(word $4,$(wordlist $3,99999999,$2)),$(wordlist 1,$(words $2),$(filter 0%,$(subst 0, 0,$(foreach ;,$(subst 01111111111,10,$(subst $  ,,$(subst 00,0,$(subst 10,1,$(join $1,$21))))),$(if $(findstring 01111111111,$;),$(call `u-carry-fn,$;,0111111111,0),$;))))),$(call `power-seq-1,$(subst $  01111111111,1 0,$(subst 00,0,$(subst 10,1,$(join $1,$2 $1)))),$2 $2,$3,$4))
`uf-round = $(if $(if $(filter 2,$2),$(findstring 0111111,$(or $(filter-out 011111,$(or $(word 2,$(wordlist $1,99999999,$3)),0)),$(if $(or $(findstring 1,$(wordlist 3,99999999,$(wordlist $1,99999999,$3))),$(findstring 1,$(subst 11,,$(word $1,$3)))),0111111))),$(if $(filter 3,$2),$(findstring $  01,$(wordlist $1,99999999,$3)))),$(filter 0%,$(subst 0, 0,$(foreach ;,$(subst 01111111111,10,$(subst $  ,,0 $(wordlist 1,$1,$3)1)),$(if $(findstring 01111111111,$;),$(call `u-carry-fn,$;,0111111111,0),$;)))),0 $(wordlist 1,$1,$3))
`uf-div1 = $(call `uf-round,$3,$4,$(if $(filter 0111 0111111 01111111 0111111111,$2),$(call `power-seq-1,$(if $(filter 0111 0111111,$2),$(if $(filter 0111,$2),$(call `uf*3,$1),$(filter 0%,$(subst 0, 0,$(foreach ;,$(subst 01111111111,10,$(subst $  ,,$(subst x,111,$(subst 1 0, 0xxxxx,$(subst 11,x,$1 0))))),$(if $(findstring 01111111111,$;),$(call `u-carry-fn,$;,0111111111,0),$;))))),$(if $(filter 01111111,$2),$(wordlist 2,99999999,$(call `uf-mul,$1,01 01111 011 011111111 011111 01111111)),$1)),$(if $(filter 01111111,$2),0 0 0 0 0 0,0),$(if $(word $3,$1),$(words $1),$3),$(words $2 1 1 1)),$(if $(filter 01 011 01111 011111111,$2),$(wordlist 2,99999999,$(if $(findstring 01111,$2),$(subst 2 0, 011111,$(subst 22,1,$(subst 1 0, 0112,$(subst 11,2,$(if $(filter 01111,$2),$1,$(subst 2,1,$(subst 1 0, 011111,$(subst 11,2,$1 0)))) 0 0)))),$(if $(filter 011,$2),$(subst 2,1,$(subst 1 0, 011111,$(subst 11,2,$1 0))),$1))),$(subst $  01111111111,1 0,$(subst 1,11,$1)))))
`recip-loop = $(subst 1,,$2)$(if $(filter 1 %x1,$2),, $(call `recip-loop,$1,$(subst $1,x,$(subst 1,1111111111,$(subst x,,$2)))))
`recip2 = $(strip $(subst $  , 0,$(subst x,1,$(call `recip-loop,$(subst 0,,$(subst 1,1111111111,$(word 1,$1))$(word 2,$1)),1111111111))))
$(if $(call `memoize,`recip2),)
`recip-div2 = $(wordlist 2,99999999,$(call `power-seq-1,$(call `uf-mul,$1,$4),0 $(patsubst %,0,$4),$(if $(word $3,$1),$(words $1),$3),$(words $2 1 1 1)))
`uf-div2 = $(if $(filter 0,$(word 1,$2)),$(call `uf-div1,$(wordlist 2,99999999,$1),$(wordlist 2,99999999,$2),$3,$4),$(if $(filter 0 011 01111 011111 0111111 011111111,$(word 2,$2)),$(if $(filter 0 011111,$(word 2,$2)),$(if $(filter 011111,$(word 2,$2)),$(call `uf-div2,$(subst $  01111111111,1 0,$(subst 1,11,0 $1)),$(wordlist 1,2,$(subst $  01111111111,1 0,$(subst 1,11,0 $2))),$3,$4),$(call `uf-div1,$1,$(word 1,$2),$3,$4)),$(call `uf-div2,$(subst 2,1,$(subst 1 0, 011111,$(subst 11,2,$1 0))),$(subst 2,1,$(subst 1 0, 011111,$(subst 11,2,$2))),$3,$4)),$(call `uf-round,$3,$4,$(call `recip-div2,$1,$2,$3,$(call `recip2,$2)))))
`sdiv-done = $(subst 01, ,0$21)$(findstring 1,$3)
`sdiv-loop = $(subst 1,,$2) $(call $(if $(word $4,$5),`sdiv-done,`sdiv-loop),$1,$(subst $1,0,$(subst 0,,$(subst 1,1111111111,$2)$(word 1,$3))),$(wordlist 2,99999999,$3),$4,$5 0)
`uf-div3 = $(call `uf-round,$3,$4,$(strip $(subst $  , 0,$(subst 0,1,$(call `sdiv-loop,$(subst 0,,$(subst 1,1111111111,$(subst 1,1111111111,$(word 1,$2))$(word 2,$2))$(word 3,$2)),$(subst 0,,$(subst 1,1111111111,$(subst 1,1111111111,$(word 1,$1))$(word 2,$1))$(word 3,$1)),$(wordlist 4,99999999,$1),$3)))))
`uf-remainder = $(or $(wordlist 2,99999999,$(wordlist $3,99999999,$(filter 0%,$(subst 0, 0,$(foreach ;,$(subst 01111111111,10,$(subst $  ,,$(subst 00,0,$(subst 10,1,$(join $1,$(subst 101,0,$(subst 11011,0,$(subst 1110111,0,$(patsubst 0%,%0111111111,$(patsubst 0111111%,%101111,$(call `uf-mul,$2,$(wordlist 2,99999999,$(call `uf-div,$1,$2,$3,1))))))))1))))),$(if $(findstring 01111111111,$;),$(call `u-carry-fn,$;,0111111111,0),$;)))))),0)
`uf-div = $(if $(filter 09,$29),$(call `uf-div,$1,$(subst ., ,$(filter-out %0,$(subst 0 ,0.,$2))),$3,$4),$(if $(filter 0 -%,$3),$(call `div-post,$4,0,$1,$2),$(if $(if $(findstring 1,$1),,1),0,$(if $(word 4,$2),$(call `div-loop,0 $1,$2,$(subst 0,,$(subst 1,1111111111,$(word 1,$2))$(word 2,$2)),$3,$4,),$(if $(filter 4,$4),$(call `uf-remainder,$1,$2,$3),$(call `uf-div$(words $2),$1,$2,$3,$4))))))
`u-fdiv = $(if $(filter 00%,$1 $2),$(call `u-fdiv,$(patsubst 00%,0%,$1),$(patsubst 00%,0%,$2),$3),$(if $(and $1,$(findstring 1,$2)),0$(subst $  ,,$(wordlist 2,99999999,$(subst 01,0 1,$(subst $  ,,$(foreach ;,$(words $(wordlist $(words $(subst 0, 0,$2)),99999999,$(subst 0, 0,$1))),$(if $(filter 0,$;),$(if $(filter 4,$3),$1,0),$(call `uf-div,0$(subst 0, 0,$1),$(strip $(subst 0, 0,$2)),$;,$3)))))))))

endef

define [mod-math1]
# Requires: core math0
# Exports: 
$(call ^R,core)
$(call ^R,math0)
`fp-norm = $(if $(filter 0,$(word 3,$1)),$(foreach ;,$(word 1,$(subst 001,0 01,$(subst $  ,,$(wordlist 3,99999999,$1)))),$(call `u-add,$(word 1,$1),$(subst --,,-$(call `u-add-ones,0,$(subst 0,1,$;)))) $(word 2,$1)$(or $(subst 9$(subst 0, 0,$;),,9 $(wordlist 3,99999999,$1)),$(if ,, 0))),$1)
`u2fp-exp = $(foreach ;,$(lastword $(subst E, E,$1)),$(foreach ;;,$(subst E,,$(subst E+,E,$(subst +-,X,$;))),$(if $(subst 1,,$(subst 0,,$(patsubst -%,%,$(;;)))),,$(call `u2fp,$(subst E,X,$(subst $;2,,$12)),$(;;)))))
`u2fp = $(if $(if $(subst 1,,$(subst 0,,$1)),,1),$(if $1,$(if $(or $2,$(word 10,$(subst 0, 0,$1)),$(filter 00%,$10)),$(call `fp-norm,$(call `u-add-ones,$(or $2,0),$(subst 0,1,$(subst 1,,$1))) $(or $3,+)$(subst 0, 0,$1)$4),0$(subst 0,1,$(subst 1,,$1)) $(or $3,+)$(subst 0, 0,$1)$4)),$(if $(findstring E,$(subst e,E,$1)),$(call `u2fp-exp,$(subst e,E,$1)),$(if $(findstring 2-0,2$1),$(call `u2fp,$(subst 2-,,2$1),$2,-),$(if $(findstring .,$1),$(foreach ;,$(lastword $(subst ., ,$1)),$(if $(subst 1,,$(subst 0,,$;)),,$(call `u2fp,$(subst .,x,$(subst .$;2,,$12)),$2,$3,$(subst 0, 0,$;))))))))
`fp2u = $(if $(findstring 1,$(word 3,$1)),$(findstring -,$(word 2,$1))$(subst $  ,,$(subst . ,,$(subst . 0,.0,$(filter-out %0,$(subst 0 ,0,$(foreach ;,$(or $(subst 0,,$(subst 10,91,$(subst 10,091,$(word 1,$1)))),-),$(if $(findstring $;,-11111 91911 91111111111),$(if $(filter -%,$;),0. $(subst -,,$(subst 1,0 ,$;))$(wordlist 3,99999999,$1),$(subst 00,0,$(subst 10,1,$(join $(wordlist 3,99999999,$1),$(subst 1, 0,$(subst 9,111111111,$;)).)))),$(word 3,$1). $(wordlist 4,99999999,$1)  e$(subst +-,-,+$(call `u-1,$(word 1,$1))).)))) ))),$(if $(findstring 1,$(wordlist 3,99999999,$1)),$(call `fp2u,$(call `u-1,$(word 1,$1)) $(word 2,$1) $(wordlist 4,99999999,$1)),$(if $1,0,NaN)))
`prec-to-pod = $(if $1,$(if $(filter +% -%,$1),$(foreach ;,$(call `d2u,$(findstring $1,$(word 1,$1))),$(if $(filter-out + -,$(subst 1,,$(subst 0,,$;))),,$(subst +,-,$(subst -,,$;)))),$(if $(call `word-index?,$1),$(if $(filter 0%,$1),$(call `prec-to-pod,$(patsubst 0%,%,$1)),$1))),16)
`make-fp<<1 = $(if $(filter 0,$(word 1,$3)),$1 $2 $(or $(wordlist 2,99999999,$3),0),$(or $(filter-out -% %1111111111,$11),$(call `u-add,$1,01)) $2 $3)
`tally = $(if $(word 2,$1),$(call `tally,$(subst 1,1111111111,$(word 1,$1))$(wordlist 2,99999999,$1)),$(subst 0,,$1))
`fp-add-x = $(if $(findstring $2,$5),$(call `make-fp<<1,$1,$2,$(filter 0%,$(subst 0, 0,$(foreach ;,$(subst 01111111111,10,$(subst $  ,,$(subst 00,0,$(subst 10,1,$(join 0 $3,0 $(and $(filter-out $1,$4),$(subst 1,0 ,$(call `tally,$(subst 0, 0,$(call `u-add,$1,$(subst --,,-$4))))))$6))))),$(if $(findstring 01111111111,$;),$(call `u-carry-fn,$;,0111111111,0),$;))))),$1 $(call `uf-sign-sub,$3,$(and $(filter-out $1,$4),$(subst 1,0 ,$(call `tally,$(subst 0, 0,$(call `u-add,$1,$(subst --,,-$4))))))$6,$(findstring -,$2)))
`fp-add = $(and $1,$2,$(if $(findstring 1,$(call `u-cmp,$(word 1,$2),$(word 1,$1))),$(call `fp-add-x,$(word 1,$2),$(word 2,$2),$(wordlist 3,99999999,$2),$(word 1,$1),$(word 2,$1),$(wordlist 3,99999999,$1)),$(call `fp-add-x,$(word 1,$1),$(word 2,$1),$(wordlist 3,99999999,$1),$(word 1,$2),$(word 2,$2),$(wordlist 3,99999999,$2))))
`fp-mul = $(and $1,$2,$(call `u-add,$(word 1,$1),$(word 1,$2)) $(if $(findstring $(word 2,$1),$(word 2,$2)),+,-) $(call `uf-mul,$(wordlist 3,99999999,$1),$(wordlist 3,99999999,$2)))
`fp-mulp-x = $1 $2 $(wordlist 1,$5,$3)$(if $(and $(filter-out -0% 0%,$4),$(filter 0,$(word 1,$3))),$(addprefix $  ,$(word 2,$(wordlist $5,99999999,$3))))
`fp-mulp = $(if $(and $3,$1,$2),$(foreach ;,$(call `u-add,$(word 1,$1),$(word 1,$2)),$(foreach ;;,$(if $(filter 0% -0%,$3),$(call `u2d,$(call `u-add,$;,$3)),$3),$(if $(filter -% 0,$(;;)),0 + 0,$(call `fp-mulp-x,$;,$(if $(findstring $(word 2,$1),$(word 2,$2)),+,-),$(call `uf-mul,$(word 3,$1)$(if $(word 4,$1), $(wordlist 1,$(;;),$(wordlist 4,99999999,$1))),$(word 3,$2)$(if $(word 4,$2), $(wordlist 1,$(;;),$(wordlist 4,99999999,$2)))),$3,$(;;))))))
`fp-div-x = $(foreach ;,$(if $(filter 0% -0%,$6),$(call `u2d,$(call `u-add,$1,$6)),$6),$(if $(filter -%,$;),$(if $(filter 3,$(if $5,2,$(if $(filter +,$2),1,3))),$(call `u-add,01,$(subst --,,-$6)) $2 01,0 + 0),$(call `make-fp<<1,$1,$2,$(call `uf-div,$3,$4,$;,$(if $5,2,$(if $(filter +,$2),1,3))))))
`fp-div = $(if $(if $(findstring 101,$(word 3,$1)$(word 3,$2)),,1),$(if $(findstring 1,$(wordlist 3,99999999,$2)),$(if $(findstring 1,$(wordlist 3,99999999,$1)),$(call `fp-div,$(call `fp-norm,$1),$(call `fp-norm,$2),$3,$4),$(if $1,0 + 0,)),),$(if $3,$(if $(findstring 1,$(call `uf-cmp,$(wordlist 3,99999999,$2),$(wordlist 3,99999999,$1))),$(call `fp-div-x,$(call `u-add,$(word 1,$1),$(subst --,,-$(word 1,$2))),$(if $(findstring $(word 2,$1),$(word 2,$2)),+,-),$(wordlist 3,99999999,$1),$(wordlist 3,99999999,$2),$4,$3),$(call `fp-div-x,$(call `u-add,$(or $(filter-out -% %1111111111,$(word 1,$1)1),$(call `u-add,$(word 1,$1),01)),$(subst --,,-$(word 1,$2))),$(if $(findstring $(word 2,$1),$(word 2,$2)),+,-),0 $(wordlist 3,99999999,$1),$(wordlist 3,99999999,$2),$4,$3))))
`fp-mod = $(if $(if $(findstring 101,$(word 3,$1)$(word 3,$2)),,1),$(if $(findstring 1,$(wordlist 3,99999999,$2)),$(if $(findstring 1,$(wordlist 3,99999999,$1)),$(call `fp-mod,$(call `fp-norm,$1),$(call `fp-norm,$2)),$(if $1,0 + 0,)),),$(if $(if $(findstring $(word 2,$1),$(word 2,$2)),,1),$(call ^Y,$(call `fp-mod,$1,$(subst !,-,$(subst $  -, +,$(subst $  +, !,$2)))),$2,,,,,,,,$`(if $`(findstring 1,$`(wordlist 3,99999999,$`1)),$`(call `fp-add,$`2,$`1),$`1)),$(if $(findstring 1,$(call `u-cmp,$(word 1,$2),$(word 1,$1))),$1,$(word 1,$2) $(word 2,$1) $(call `uf-div,0 $(wordlist 3,99999999,$1),$(wordlist 3,99999999,$2),$(call `u2d,$(call `u-add,$(or $(filter-out -% %1111111111,$(word 1,$1)1),$(call `u-add,$(word 1,$1),01)),$(subst --,,-$(word 1,$2)))),4))))
`fp-round = $(if $(findstring 1,$(word 3,$1)),$(foreach ;,$(if $(filter 0% -0%,$2),$(call `u2d,$(call `u-add,$(word 1,$1),$2)),$2),$(if $(filter -%,$;),$(if $(filter 3,$(or $(filter 2 1,$3),$(if $(findstring $(word 2,$1),$(if $(filter 3,$3),+,-)),3,1))),$(call `u-add,01,$(subst --,,-$2)) $(word 2,$1) 01,0 + 0),$(call `make-fp<<1,$(word 1,$1),$(word 2,$1),$(if $(filter 0,$;),$(wordlist 2,99999999,$(call `uf-round,1,$(or $(filter 2 1,$3),$(if $(findstring $(word 2,$1),$(if $(filter 3,$3),+,-)),3,1)),0 $(wordlist 3,99999999,$1))),$(call `uf-round,$;,$(or $(filter 2 1,$3),$(if $(findstring $(word 2,$1),$(if $(filter 3,$3),+,-)),3,1)),$(wordlist 3,99999999,$1)))))),$(if $(findstring 1,$(wordlist 3,99999999,$1)),$(call `fp-round,$(call `fp-norm,$1),$2,$3),$(if $1,0 + 0)))
`fp-trunc = $(if $(subst 0,,$(filter-out -%,$(word 1,$1))),$(if $(word 9,$(subst 0, 0,$(word 1,$1))),$1,$(wordlist 1,$(call `u2d,$(call `u-add-ones,$(word 1,$1),11)),$1)),$(if $1,0 + 0))
`fp-mag-ceiling = $(if $(subst 0,,$(filter-out -%,$(word 1,$1))),$(call ^Y,$(call `fp-trunc,$1),$1,,,,,,,,$`(if $`(findstring 1,$`(subst $`1,,$`2)),$`(call `make-fp<<1,$`(word 1,$`1),$`(word 2,$`1),$`(filter 0%,$`(subst 0, 0,$`(foreach ;,$`(subst 01111111111,10,$`(subst $`  ,,0 $`(wordlist 3,99999999,$`1)1)),$`(if $`(findstring 01111111111,$`;),$`(call `u-carry-fn,$`;,0111111111,0),$`;))))),$`1)),$(if $(findstring 1,$(wordlist 3,99999999,$1)),01 $(word 2,$1) 01,$(if $1,0 + 0)))
`fp-floor = $(if $(findstring $  -,$1),$(call `fp-mag-ceiling,$1),$(if $1,$(call `fp-trunc,$1)))
`fp-ceil = $(if $(findstring $  +,$1),$(call `fp-mag-ceiling,$1),$(if $1,$(call `fp-trunc,$1)))
`fp-cmp = $(if $(findstring $(findstring + 01,$1),$2),$(or $(call `u-cmp,$(word 1,$1),$(word 1,$2)),$(call `uf-cmp,$(wordlist 3,99999999,$1),$(wordlist 3,99999999,$2))),$(if $(if $(and $1,$2),,1),$(if $1,1,$(if $2,~)),$(if $(if $(findstring 1,$(word 3,$1)),,1),$(if $(findstring 1,$(word 3,$2)),$(if $(filter -,$(word 2,$2)),1,~),),$(if $(if $(findstring 1,$(word 3,$2)),,1),$(if $(filter -,$(word 2,$1)),~,1),$(if $(findstring - 01,$(filter-out 0,.$1)),$(if $(findstring - 01,$(filter-out 0,.$2)),$(call `fp-cmp,$(subst !,-,$(subst $  -, +,$(subst $  +, !,$2))),$(subst !,-,$(subst $  -, +,$(subst $  +, !,$1)))),~),1)))))
`fp-sq = $(call `fp-mul,$1,$1)
`fp-pwr = $(foreach ;,$(subst 10,022222,$(subst 11,2,$2)),$(if $(findstring 2,$;),$(if $(findstring 1,$;),$(call `fp-mul,$(call `fp-sq,$(call `fp-norm,$(call `fp-pwr,$1,$(subst 2,1,$(subst 1,,$;))))),$1),$(call `fp-sq,$(call `fp-norm,$(call `fp-pwr,$1,$(subst 2,1,$;))))),$(if $(findstring 1,$2),$1,01 + 01)))
`extend-fn = $(if $(subst 0,,$2),$(if $(word $2,$1$3),$(wordlist 1,$2,$1$3),$(call `extend-fn,$1$3$3,$2,$3$3)))
`zero-pad = $(filter %,$(if $2,$(wordlist $(words $1 0),99999999,$(call `extend-fn,0,$2, 0 0 0 0))) $1)
`ltrimz = $(if $(filter 00% 0n% 0-%,$1),$(foreach ;,$(word 1,$(subst 0-,0 ,$(subst 0n,0 ,$(subst 0., ,$(subst 01, ,$(patsubst %0,% 0,$1)))))),$(subst <$;,$(subst 0, ,$;),<$1)),$1)
`fp-fix = $(call `u2d,$(call `ltrimz,$(subst $  ,,$(call `zero-pad,$(if $1,$(filter -,$1) $(foreach ;,$(call `u2d,$(word 1,$1)),$(if $(subst 0,,$(filter-out -%,$;)),$(call `extend-fn,$(wordlist 3,99999999,$1),$;, 0 0 0 0),0)$(if $3, . $(call `extend-fn,$(if $(subst 0,,$(filter-out -%,$;)),$(wordlist $;,99999999,$(wordlist 4,99999999,$1)),$(if $(findstring 1,$(call `u-cmp,$4,$(patsubst -%,%,$(word 1,$;)))),$(call `extend-fn,0,$(patsubst -%,%,$;), 0 0 0 0) $(wordlist 3,99999999,$1))),$3, 0 0 0 0))),n a n),$2))))

endef

define [mod-math2]
# Requires: core math0 math1
# Exports: 
$(call ^R,core)
$(call ^R,math0)
$(call ^R,math1)
`u-zeros = $(if $(filter-out -%,$1),$(subst 1, 0,$(if $(findstring 10,$1),$(call `tally,$(subst 0, 0,$1)),$(subst 0,,$1))))
`round-uf-const = $(foreach ;,$(subst $  ,,$(wordlist $(words 0 $2),99999999,$1)),$(and $(subst 0111111111,,$(subst .01111,,.$;)),$(subst 0,,$(subst .011111,,.$;)),$(if $(filter 011111%,$;),$(filter 0%,$(subst 0, 0,$(foreach ;;,$(subst 01111111111,10,$(subst $  ,,$(wordlist 1,$(words $2),$1)1)),$(if $(findstring 01111111111,$(;;)),$(call `u-carry-fn,$(;;),0111111111,0),$(;;))))),$(wordlist 1,$(words $2),$1))))
`get-uf-const = $(or $(call `round-uf-const,$($1/v),$2),$(if $(word 1,$2),$(and $(call ^set,$1/c,$(patsubst %,0,0 0 0 0 0 $(join $2,$($1/c))),)1,$(call ^set,$1/v,$(wordlist 2,99999999,$(call `uf-round,$(words $($1/c)),2,$(call $1,$($1/c)))),)1,$(call `get-uf-const,$1,$2))))
`uf-addsub = $(if $2,$(filter 0%,$(subst 0, 0,$(foreach ;,$(subst 01111111111,10,$(subst $  ,,$(subst 00,0,$(subst 10,1,$(join $1,$(if $3,$(subst 101,0,$(subst 11011,0,$(subst 1110111,0,$(patsubst 0%,%0111111111,$(patsubst 0111111%,%101111,$2)))))1,$2)))))),$(if $(findstring 01111111111,$;),$(call `u-carry-fn,$;,0111111111,0),$;)))),$1)
`uf-atan-loop = $(if $6,$(if $(filter 0,$(word 1,$1)),$(if $(filter 0,$(word 2,$1)),0 0 $(call `uf-atan-loop,$(wordlist 3,99999999,$1),$2,$3,$4,$5,$(wordlist 3,99999999,$6)),0 $(call `uf-atan-loop,$(wordlist 2,99999999,$1),$2,$3,$4,$5,$(wordlist 2,99999999,$6))),$(call `uf-addsub,$(wordlist 3,99999999,$(subst 0,0 ,$(subst 1,,$5))$(call `uf-div,0 $1,$(strip $(subst 0, 0,$5)),$(words 0 $6),2)),$(if $(word $(words 0 $2),$6),$2 $(call `uf-atan-loop,$(foreach ;,$(words $(wordlist $(words 0 $2),99999999,$6)),$(wordlist 1,$;,$(call `uf-mul,$(or $(wordlist 1,$;,$3),0),$(or $(wordlist 1,$;,$1),0)))),$2,$3,$4,$(call `u-add-ones,$5,11),$(wordlist $(words 0 $2),99999999,$6))),$4)))
`uf-atanh-3 = $(filter 0%,$(subst 0, 0,$(foreach ;,$(subst 01111111111,10,$(subst $  ,,$(subst 00,0,$(subst 10,1,$(join $2 $(call `uf-atan-loop,$(foreach ;,$(words $4),$(wordlist 1,$;,$(call `uf-mul,$(or $(wordlist 1,$;,$1),0),$(or $(wordlist 1,$;,$3),0)))),$2,$3,,0111,$(wordlist $(words 0 $2),99999999,$4)),$1))))),$(if $(findstring 01111111111,$;),$(call `u-carry-fn,$;,0111111111,0),$;))))
`uf-atanh-2 = $(if $2,$(strip $1 $(call `uf-atanh-3,$2,$(call `uf-get-lz,$3),$(call `uf-trim-lz,$3),$(wordlist $(words 0 $1),99999999,$4))),0)
`uf-atanh = $(call `uf-atanh-2,$(call `uf-get-lz,$1),$(call `uf-trim-lz,$1),$(call `uf-mul,$1,$1),$2)
`uf-log = $(subst $  01111111111,1 0,$(subst 1,11,$(call `uf-atanh,$(call `uf-div,$(or $1,0),$2,$(words $3),2),$3)))
`log-M = $(call `uf-log,0 011,011 0 011,0 0 $1)
`calc-m-powers = $(if $(findstring 1,$(word 1,$1)),$(call ^set,`m-powers,$2,$2),$(call `calc-m-powers,$(wordlist 2,99999999,$(call `uf-mul,$1,01 0 011)),$2$(if $2, )$(patsubst 00%,0%,$(subst $  ,,$1))))
`calc-m-powers-r = $(and $(call ^set,`m-powers-r,$(patsubst 00%,0%,$(foreach ;,$(or $(`m-powers),$(call `calc-m-powers,0 01 0 011,)),$(subst $  ,,$(call `uf-div,01 0 01,$(wordlist 1,6,$(subst 0, 0,$;)),4,2)))))1,$(`m-powers-r))
`psrch = $(if $(findstring $(subst $30,1,$20),1),$(words $3),$(foreach ;,$(words $(subst 0 0,0,$(patsubst %,0,$2 $3))),$(if $(findstring 1,$(call `uf-cmp,$(subst 0, 0,$(word $;,$2)),$1)),$(call `psrch,$1,$2,$(wordlist 1,$;,$2)),$(call `psrch,$1,$(wordlist 2,$;,0 $2),$3))))
`uf-log-fr2 = $(if $(filter 01%,$(word 1,$1)),$(filter 0%,$(subst 0, 0,$(foreach ;,$(subst 01111111111,10,$(subst $  ,,$(subst 00,0,$(subst 10,1,$(join $(wordlist $(words $2),99999999,$(call `uf-mul,$(call `get-uf-const,`log-M,$3 0 $2),$2)),$(subst 101,0,$(subst 11011,0,$(subst 1110111,0,$(patsubst 0%,%0111111111,$(patsubst 0111111%,%101111,0 $(call `uf-log,$(wordlist 2,99999999,$1),011 $(wordlist 2,99999999,$1),$3 0 $(word 75,$3)))))))1))))),$(if $(findstring 01111111111,$;),$(call `u-carry-fn,$;,0111111111,0),$;)))),$(filter 0%,$(subst 0, 0,$(foreach ;,$(subst 01111111111,10,$(subst $  ,,$(subst 00,0,$(subst 10,1,$(join $(wordlist $(words $2),99999999,$(call `uf-mul,$(call `get-uf-const,`log-M,$3 0 $2),$2)),0 $(call `uf-log,$(filter 0%,$(subst 0, 0,$(foreach ;,$(subst 01111111111,10,$(subst $  ,,$(subst 101,0,$(subst 11011,0,$(subst 1110111,0,$(patsubst 0%,%0111111111,$(patsubst 0111111%,%101111,$(wordlist 2,99999999,$1))))))1)),$(if $(findstring 01111111111,$;),$(call `u-carry-fn,$;,0111111111,0),$;)))),01 $(wordlist 2,99999999,$1),$3 0 $(word 75,$3))))))),$(if $(findstring 01111111111,$;),$(call `u-carry-fn,$;,0111111111,0),$;)))))
`uf-log-fr = $(foreach ;,$(call `psrch,$1,$(or $(`m-powers-r),$(call `calc-m-powers-r)),),$(call `uf-log-fr2,$(if $(filter 0,$;),0 $1,$(foreach ;;,$(words 0 0 $2),$(wordlist 1,$(;;),$(call `uf-mul,$(or $(wordlist 1,$(;;),$(strip $(subst 0, 0,$(word $;,$(or $(`m-powers),$(call `calc-m-powers,0 01 0 011,)))))),0),$(or $(wordlist 1,$(;;),$1),0))))),$(strip $(subst 0, 0,$(call `d2u,$;))),$2))
`log-10 = $(call `uf-log-fr,01,0 0 $1)
`log-size-x = $(if $(filter -01111 -0111 -011 -01 011 0111 01111 011111,$1),01,$(if $(filter 01,$1),$(if $(findstring 11,$(wordlist 1,2,$2)),0,-0$(subst 0,1,$(word 1,$(subst 01, ,$(subst 001000,000100,$(subst $  ,,$2000)))))),$(if $(filter 0,$1),$(if $(findstring 111,$(word 1,$2)),$(if $(findstring 111111111,$(word 1,$2)),-0$(word 1,$(subst $  1,1,$(subst 0111111111,1,$2))),0),01),0$(subst 0,1,$(subst 1,,$(patsubst 011111%,00%,$(subst -,,$1)))))))
`fp-log2 = $(if $(findstring 1,$(call `uf-cmp,$2,01 0 011)),$(call `fp-add,$(if $(findstring 1,$1),$(call `fp-mul,01 + $(call `get-uf-const,`log-10,$3 0 0 $(subst 0, 0,$(patsubst -%,%,$1))),$(call `u2fp,$1)),0 + 0),01 - $(call ^Y,,,,,,,,,,$(call `uf-log-fr,$2,$3))),$(call `fp-add,$(call `fp-mul,01 + $(call `get-uf-const,`log-10,$3 0 0 $(subst 0, 0,$(patsubst -%,%,$1))),$(call `u2fp,$(call `u-add,$1,$(subst --,,-01)))),0 + $(call `uf-log,$(wordlist 2,99999999,$2),011 $(wordlist 2,99999999,$2),0 $3)))
`adjust-digit-count = $(if $(filter -%,$2),$1$(subst 1, 1,$(subst -0,,$2)),$(wordlist $(words $(subst 1, 1,$2)),99999999,$1))
`fp-log = $(and $(findstring + 01,$(filter-out 0,.$1)),$2,$(call `fp-round,$(call `fp-log2,$(word 1,$1),$(wordlist 3,99999999,$1),$(if $(filter 0% -0%,$2),$(call `u-zeros,$2),$(call `adjust-digit-count,$(call `extend-fn,0,$2, 0 0 0 0),$(call `log-size-x,$(word 1,$1),$(wordlist 3,99999999,$1))))),$(or $(`result-pod),$2),2))
`fp-log-x-b = $(and $3,$(findstring + 01,$(filter-out 0,.$1)),$(findstring + 01,$(filter-out 0,.$2)),$(foreach ;,$(call `log-size-x,$(word 1,$1),$(wordlist 3,99999999,$1)),$(foreach ;;,$(call `log-size-x,$(word 1,$2),$(wordlist 3,99999999,$2)),$(call ^Y,$(if $(filter 0% -0%,$3),$(call `adjust-digit-count,$(call `adjust-digit-count,0 0 $(call `u-zeros,$3),$(subst --,,-$;)),$(;;)),0  $(call `extend-fn,0,$3, 0 0 0 0)),$1,$2,$3,,,,,,$`(call `fp-div,$`(call `fp-log2,$`(word 1,$`2),$`(wordlist 3,99999999,$`2),$`(call `adjust-digit-count,$`1,$(call ^E,$;))),$`(call `fp-log2,$`(word 1,$`3),$`(wordlist 3,99999999,$`3),$`(call `adjust-digit-count,$`1,$(call ^E,$(;;)))),$`(or $`(`result-pod),$`4),1)))))
`uf-exp-loop = $(if $4,$(if $(findstring 1,$(word 1,$1)),$(filter 0%,$(subst 0, 0,$(foreach ;,$(subst 01111111111,10,$(subst $  ,,$(subst 00,0,$(subst 10,1,$(join $(foreach ;,$(words $4),$(if $(filter-out 0,$;),$(call `uf-exp-loop,$(wordlist 3,99999999,$(subst 0,0 ,$(subst 1,,$3))$(call `uf-div,0 $(wordlist 1,$;,$(call `uf-mul,$(or $(wordlist 1,$;,$2),0),$(or $(wordlist 1,$;,$1),0))),$(strip $(subst 0, 0,$3)),$;,2)),$2,$(call `u-add-ones,$3,1),$4))),0 $1))))),$(if $(findstring 01111111111,$;),$(call `u-carry-fn,$;,0111111111,0),$;)))),$(if $(filter 0,$(word 2,$1)),0 0 $(call `uf-exp-loop,$(wordlist 3,99999999,$1),$2,$3,$(wordlist 3,99999999,$4)),0 $(call `uf-exp-loop,$(wordlist 2,99999999,$1),$2,$3,$(wordlist 2,99999999,$4)))))
`uf-exp-small = $(filter 0%,$(subst 0, 0,$(foreach ;,$(subst 01111111111,10,$(subst $  ,,$(subst 00,0,$(subst 10,1,$(join 01,$(call `uf-exp-loop,$1,$1,011,$2)))))),$(if $(findstring 01111111111,$;),$(call `u-carry-fn,$;,0111111111,0),$;))))
`uf-exp-med-2 = $(foreach ;,$(patsubst 0:%,%,$(patsubst 0:0:%,%,$(subst $  ,:,$(call `uf-div,0 $1,$(wordlist 2,99999999,$3),3,1)))),$(if $(findstring 1,$;),$(foreach ;;,$(word $(call `u2d,$(subst :,,$;)),$(or $(`m-powers),$(call `calc-m-powers,0 01 0 011,))),$(call `uf-mul,$(call `uf-exp-small,$(wordlist 2,99999999,$(filter 0%,$(subst 0, 0,$(foreach ;;;,$(subst 01111111111,10,$(subst $  ,,$(subst 00,0,$(subst 10,1,$(join $1,$(subst 101,0,$(subst 11011,0,$(subst 1110111,0,$(patsubst 0%,%0111111111,$(patsubst 0111111%,%101111,$(wordlist $(words $(subst :, ,$;)),99999999,$(call `uf-mul,$3,$(subst :, ,$;))))))))1))))),$(if $(findstring 01111111111,$(;;;)),$(call `u-carry-fn,$(;;;),0111111111,0),$(;;;)))))),$2$(if $(filter 0111%,$(;;)), 0)),$(wordlist 1,$(words 0 $2),$(subst 0, 0,$(;;))))),0 $(call `uf-exp-small,$(wordlist 2,99999999,$1),$2)))
`fp2su = $(if $(subst 0,,$(filter-out -%,$(word 1,$1))),$(findstring -,$(word 2,$1))$(subst $  ,,$(call `extend-fn,$(wordlist 3,99999999,$1),$(call `u2d,$(word 1,$1)), 0 0 0 0)),0)
`fp2uf = $(or $(foreach ;,$(if $(filter 0,$2),$(word 1,$1),$(call `u-add,$(word 1,$1),$(subst --,,-$2))),$(if $(subst 0,,$(filter-out -%,$;)),$(if $(word 9,$(subst 0, 0,$;)),,$(wordlist $(call `u2d,$;),99999999,$(wordlist 4,99999999,$1))),$(strip $(if $(findstring 1,$;),$(call `u-zeros,$(patsubst -%,%,$;))) $(wordlist 3,99999999,$1)))),0)
`exp-4 = $(call `u-add-ones,$(call `fp2su,$4),11) + $(call `uf-exp-med-2,$(call `fp2uf,$(call `fp-add,$1,$(subst !,-,$(subst $  -, +,$(subst $  +, !,$(call `fp-mul,$4,$3))))),01),0 $2,$(call `get-uf-const,`log-M,0 0 0 $2))
`exp-3 = $(call `exp-4,$1,$2,$3,$(call `fp-div,$1,$3,0,))
`exp-2 = $(if $2,$(call `exp-3,$1,$2,01 + $(call `get-uf-const,`log-10,$2 0 0 $(call `u-zeros,$(word 1,$1)))),0 + 0)
`fp-exp = $(and $1,$2,$(call `fp-round,$(call `exp-2,$1,$(if $(filter 0% -0%,$2),0 $(call `u-zeros,$(call `u-add,$2,$(call `fp2su,$(call `fp-div,$1,01 + 011 0111,0,)))),$(call `extend-fn,0,$2, 0 0 0 0))),$(or $(`result-pod),$2),2))
`fp-pow = $(and $1,$2,$3,$(if $(findstring 101,$(word 3,$1)$(word 3,$2)),$(foreach ;,$(if $(filter 0% -0%,$3),$(call `u-add,$(or $(filter-out -% %1111111111,$31),$(call `u-add,$3,01)),$(call `fp2su,$(call `fp-mul,$2,$(call `u2fp,$(or $(filter-out -% %1111111111,$(word 1,$1)1),$(call `u-add,$(word 1,$1),01)))))),$(call `d2u,$3)),$(if $(filter -% 0,$;),0 + 0,$(call `fp-exp,$(call `fp-mul,$2,$(call ^set,`result-pod,$(call ^set,`result-pod,,$(`result-pod)),$(call `fp-log,$1,$(call `u2d,$(call `u-add,$;,$(call `u-add,$(call `u-carry-all,$(call `log-size-x,$(word 1,$1),$(wordlist 3,99999999,$1))),$(word 1,$2))))))),$3))),$(if $(findstring 1,$(word 3,$1)),01 + 01,$(if $(findstring 1,$(word 3,$2)),0 + 0))))
`uf-atan = $(call ^Y,$(call `uf-get-lz,$1),$(call `uf-trim-lz,$1),$(call `uf-mul,$1,$1),$2,,,,,,$`(if $`2,$`(strip $`1 $`(call `uf-atan-loop,$`2,$`(call `uf-get-lz,$`3),$`(call `uf-trim-lz,$`3),-,01,$`(wordlist $`(words 0 $`1),99999999,$`4))),0))
`uf-pi = $(subst x,11,$(subst $  0xxxxx,1 0,$(subst 1,xx,$(subst $  011111,x 0,0 $(filter 0%,$(subst 0, 0,$(foreach ;,$(subst 01111111111,10,$(subst $  ,,$(subst 00,0,$(subst 10,1,$(join $(subst x,11,$(subst $  0xxxxx,1 0,$(subst 1,xx,$(subst $  011111,x 0,$(call `uf-atan,011,$1))))),$(subst 101,0,$(subst 11011,0,$(subst 1110111,0,$(patsubst 0%,%0111111111,$(patsubst 0111111%,%101111,$(call `uf-atan,$(call `extend-fn,,$(words $1), 0 0 01111 01 011111111 01111 01),$1))))))1))))),$(if $(findstring 01111111111,$;),$(call `u-carry-fn,$;,0111111111,0),$;))))))))
`uf-sin-loop = $(if $(findstring 1,$(word 1,$2)),$(filter 0%,$(subst 0, 0,$(foreach ;,$(subst 01111111111,10,$(subst $  ,,$(subst 00,0,$(subst 10,1,$(join $2,$(subst 101,0,$(subst 11011,0,$(subst 1110111,0,$(patsubst 0%,%0111111111,$(patsubst 0111111%,%101111,$(call `uf-sin-loop,$(call `u-add-ones,$1,11),$(foreach ;,$(words 0 $4),$(wordlist 3,99999999,$(subst 0,0 ,$(subst 1,,$(call `u-add-ones,$1,1)))$(call `uf-div,0 $(wordlist 3,99999999,$(subst 0,0 ,$(subst 1,,$1))$(call `uf-div,0 $(call `uf-mul,$2,$3),$(strip $(subst 0, 0,$1)),$;,2)),$(strip $(subst 0, 0,$(call `u-add-ones,$1,1))),$;,2))),$3,$4))))))1))))),$(if $(findstring 01111111111,$;),$(call `u-carry-fn,$;,0111111111,0),$;)))),$(if $4,0 $(call `uf-sin-loop,$1,$(wordlist 2,99999999,$2),$3,$(wordlist 2,99999999,$4))))
`xsin-reduce = $(if $(findstring $  -,$1),$(call `xsin-reduce,$(subst $  -, +,$1),$2,$(call `xor,$2,$3),$4,$5,$6,$7,$8),$(if $(findstring 1,$(call `fp-cmp,0 + 011111111,$1)),$(call $5,$1,$2,$3,$4,$6,$7,$8),$(if $(findstring 1,$(call `fp-cmp,01 + 011 0111 0111111,$1)),$(call `xsin-reduce,$(call `fp-add,01 + $(subst 2,1,$(subst 1 0, 011111,$(subst 11,2,$(call `get-uf-const,`uf-pi,0 $4) 0))),$(subst !,-,$(subst $  -, +,$(subst $  +, !,$1)))),$(if $2,,1),$3,$4,$5,$6,$7,$8),$(if $(findstring 1,$(call `fp-cmp,01 + 011111 011111,$1)),$(call `xsin-reduce,$(call `fp-add,$1,$(subst !,-,$(subst $  -, +,$(subst $  +, !,01 + $(call `get-uf-const,`uf-pi,0 $4))))),$2,$(if $3,,1),$4,$5,$6,$7,$8),$(call `xsin-reduce,$(call `fp-norm,$(call `fp-add,$(call `fp-mod,$(call `fp-add,0 + 011111111,$1),01 + $(subst $  01111111111,1 0,$(subst 1,11,$(call `get-uf-const,`uf-pi,$(call `u-zeros,$(word 1,$1)) 0 $4)))),$(subst !,-,$(subst $  -, +,$(subst $  +, !,0 + 011111111))))),$2,$3,$4,$5,$6,$7,$8)))))
`xsin-small = $(or $(and $7,$2,$(if $(findstring 1,$(wordlist 1,$(words $(wordlist 2,99999999,$(wordlist $7,99999999,$4))),$(call `fp2uf,$1,0))),,1),$(call `xsin-reduce,$5,$6,,$(if $(findstring 1,$(wordlist 3,99999999,$1)),$4,$(call `uf-get-lz,$(call `fp2uf,$1,0))) 0 $(wordlist 1,$7,$4),`xsin-small,$5,$6,$7)),01 $(if $3,-,+) $(if $2,0 $(call `uf-sin-loop,011,$(call `fp2uf,$1,0),$(foreach ;,$(words $4),$(wordlist 1,$;,$(call `uf-mul,$(or $(wordlist 1,$;,$(call `fp2uf,$1,0)),0),$(or $(wordlist 1,$;,$(call `fp2uf,$1,0)),0)))),$4),$(call ^Y,$(foreach ;,$(words $4),$(wordlist 1,$;,$(call `uf-mul,$(or $(wordlist 1,$;,$(call `fp2uf,$1,0)),0),$(or $(wordlist 1,$;,$(call `fp2uf,$1,0)),0)))),,,,,,,,,$`(filter 0%,$`(subst 0, 0,$`(foreach ;,$`(subst 01111111111,10,$`(subst $`  ,,$`(subst 00,0,$`(subst 10,1,$`(join 01,$`(subst 101,0,$`(subst 11011,0,$`(subst 1110111,0,$`(patsubst 0%,%0111111111,$`(patsubst 0111111%,%101111,0 $`(call `uf-sin-loop,0111,$`(subst 2,1,$`(subst 1 0, 011111,$`(subst 11,2,$`1 0))),$`1,$(call ^E,$4)))))))1))))),$`(if $`(findstring 01111111111,$`;),$`(call `u-carry-fn,$`;,0111111111,0),$`;)))))))
`fp-xsin = $(and $2,$3,$(call `fp-round,$(if $(findstring 1,$(wordlist 3,99999999,$2)),$(call `xsin-reduce,$2,$1,,0 $(if $(filter 0% -0%,$3),$(call `u-zeros,$3),$(call `extend-fn,0,$3, 0 0 0 0)),`xsin-small,$2,$1,$(filter-out 0% -0%,$3)),$(if $1,0 + 0,01 + 01)),$(or $(`result-pod),$3),2))
`xsin = $(call `u2d,$(call `fp2u,$(call `fp-xsin,$1,$(call `u2fp,$(call `d2u,$2)),$(call `prec-to-pod,$3))))
`fp-atan-unflip = $(if $2,$(call `fp-add,$(if $(filter | /,$2),$(subst $  +, -,$1),$1),01 + $(if $(filter |,$2),$(call `get-uf-const,`uf-pi,$3 $(if $4,$(call `uf-get-lz,$(call `fp2uf,$1,0)))),$(subst 2,1,$(subst 1 0, 011111,$(subst 11,2,$(call `get-uf-const,`uf-pi,$3 $(if $4,$(call `uf-get-lz,$(call `fp2uf,$1,0)))) 0))))),$1)
`fp-atan-tiny = 0 + $(call `uf-atan,$1,$2 $(if $3,$(call `uf-get-lz,$1)))
`fp-atan-small = $(call `fp-atan-unflip,$(if $(findstring 1,$(call `fp-cmp,0 + 01111 011,$1)),$(call `fp-atan-tiny,$(call `fp2uf,$1,0),$4,$(filter-out 0% -0%,$3)),$(call `fp-add,01 + $(subst 2 0, 011111,$(subst 22,1,$(subst 1 0, 0112,$(subst 11,2,$(call `get-uf-const,`uf-pi,$4) 0 0)))),$(subst !,-,$(subst $  -, +,$(subst $  +, !,$(call `fp-atan-tiny,$(call `fp2uf,$(call `fp-div,$(call `fp-add,01 + 01,$(subst !,-,$(subst $  -, +,$(subst $  +, !,$1)))),$(call `fp-add,$1,01 + 01),$(if $(filter 0% -0%,$3),$(or $(filter-out -% %1111111111,$31),$(call `u-add,$3,01)),$(call `1+,$3)),2),0),$4,)))))),$2,$4,$(filter-out 0% -0%,$3))
`fp-atan2 = $(if $(findstring $  -,$1),$(subst !,-,$(subst $  -, +,$(subst $  +, !,$(call `fp-atan2,$(subst $  -, +,$1),$2,$3)))),$(if $(findstring - 01,$(filter-out 0,.$2)),$(call `fp-atan2,$1,$(subst $  -, +,$2),$3,|),$(if $(findstring 1,$(call `fp-cmp,$1,$2)),$(call `fp-atan2,$2,$1,$3,$4/),$(if $(and $(findstring 1,$(wordlist 3,99999999,$2)),$2,$1),$(call `fp-atan-small,$(call `fp-div,$1,$2,$(if $(filter 0% -0%,$3),$(or $(filter-out -% %1111111111,$31),$(call `u-add,$3,01)),$(call `1+,$3)),2),$4,$3,0 $(if $(filter 0% -0%,$3),$(call `u-zeros,$3),$(call `extend-fn,0,$3, 0 0 0 0)))))))

endef
$(eval $(value [mod-runtime]))
